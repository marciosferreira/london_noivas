<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Noivas - Aluguel de Vestidos</title>

    <!-- Google Analytics 4 (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23RSZ1SMRX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-23RSZ1SMRX');
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'london-gold': '#C5A059',
                        'stone': {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        serif: ['Playfair Display', 'serif'],
                        sans: ['Lato', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        .animate-fadeIn {
            animation: fadeIn 1.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeInChat 0.35s ease-out; }
        @keyframes fadeInChat { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes staggerIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
        .stagger-item { animation: staggerIn 0.3s ease-out both; }
        .stagger-item:nth-child(1) { animation-delay: 0.05s; }
        .stagger-item:nth-child(2) { animation-delay: 0.12s; }
        .stagger-item:nth-child(3) { animation-delay: 0.19s; }
        .stagger-item:nth-child(4) { animation-delay: 0.26s; }
        .stagger-item:nth-child(5) { animation-delay: 0.33s; }
        .stagger-item:nth-child(6) { animation-delay: 0.40s; }

        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #C5A059; border-radius: 3px; }

        .bella-item-card { transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s; }
        .bella-item-card:hover { border-color: rgba(197, 160, 89, 0.4); box-shadow: 0 4px 12px rgba(197, 160, 89, 0.12), 0 1px 3px rgba(0,0,0,0.06); transform: translateX(2px); }
        .bella-item-card:active { transform: scale(0.99); }
        .bella-item-card:hover .item-thumb img { transform: scale(1.08); }
        .bella-item-card:hover .item-cta { color: #C5A059; text-decoration: underline; }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5f5f4;
        }
        ::-webkit-scrollbar-thumb {
            background: #C5A059;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a38446;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 font-sans antialiased">

    <!-- Header -->
    <header id="main-header" class="sticky top-0 left-0 right-0 z-50 bg-stone-900 py-4 shadow-lg">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-sm overflow-hidden bg-white">
                    <img src="{{ url_for('static', filename='logo.jpeg') }}" alt="London Noivas Logo" class="w-full h-full object-contain">
                </div>
                <h1 id="header-title" class="text-lg sm:text-2xl font-serif tracking-[0.2em] sm:tracking-widest text-white whitespace-nowrap">
                    LONDON NOIVAS
                </h1>
            </div>

            <nav class="hidden md:flex gap-8 items-center font-medium tracking-wide text-sm">
                <a href="{{ url_for('catalogo') }}" class="nav-link text-white hover:text-london-gold transition-colors">CATÁLOGO</a>
                <a href="#sobre" class="nav-link text-white hover:text-london-gold transition-colors">SOBRE</a>
                <a href="#contato" class="nav-link text-white hover:text-london-gold transition-colors">CONTATO</a>
                <a href="https://wa.me/5592993531943" onclick="trackWhatsAppClick('header')" class="bg-london-gold text-white px-6 py-2 rounded-full hover:bg-opacity-90 transition-all shadow-lg">
                    AGENDAR VISITA
                </a>
                
                {% if session.get('logged_in') %}
                <a href="{{ url_for('agenda') }}" class="bg-white/10 text-white px-3 py-1 rounded hover:bg-white/20 transition-all text-[11px] leading-none ml-3">
                    PAINEL
                </a>
                <a href="{{ url_for('logout') }}" class="bg-white/10 text-white px-3 py-1 rounded hover:bg-white/20 transition-all text-[11px] leading-none">
                    DESLOGAR
                </a>
                {% endif %}
            </nav>
            
            <button id="mobile-menu-btn" class="md:hidden text-london-gold focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="fixed inset-0 z-[60] bg-stone-900/95 backdrop-blur-sm transform translate-x-full transition-transform duration-300 md:hidden flex flex-col justify-center items-center">
        <button id="close-menu-btn" class="absolute top-6 right-6 text-white hover:text-london-gold transition-colors focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        
        <nav class="flex flex-col gap-8 text-center">
            <a href="/" class="text-2xl font-serif text-white hover:text-london-gold transition-colors" onclick="closeMobileMenu()">INÍCIO</a>
            <a href="{{ url_for('catalogo') }}" class="text-2xl font-serif text-white hover:text-london-gold transition-colors" onclick="closeMobileMenu()">CATÁLOGO</a>
            <a href="#sobre" class="text-2xl font-serif text-white hover:text-london-gold transition-colors" onclick="closeMobileMenu()">SOBRE</a>
            <a href="#contato" class="text-2xl font-serif text-white hover:text-london-gold transition-colors" onclick="closeMobileMenu()">CONTATO</a>
            <a href="https://wa.me/5592993531943" onclick="trackWhatsAppClick('mobile_menu'); closeMobileMenu()" class="text-xl bg-london-gold text-white px-8 py-3 rounded-full hover:bg-white hover:text-london-gold transition-all shadow-lg mt-4">
                AGENDAR VISITA
            </a>
            {% if session.get('logged_in') %}
            <a href="{{ url_for('logout') }}" class="text-xl border border-white/30 text-white px-8 py-3 rounded-full hover:bg-white hover:text-stone-900 transition-all shadow-lg" onclick="closeMobileMenu()">
                DESLOGAR
            </a>
            {% endif %}
        </nav>
    </div>

    <main>
        <!-- Hero Section -->
        <section class="relative min-h-screen w-full flex items-start md:items-center justify-center overflow-visible md:overflow-hidden pt-16 pb-10 md:pt-0 md:pb-0">
            <!-- Background with overlay -->
            <div class="absolute inset-0 z-0">
                <img 
                    src="https://images.unsplash.com/photo-1583939003579-730e3918a45a?auto=format&fit=crop&q=80&w=2000" 
                    alt="Luxury wedding dress" 
                    class="w-full h-full object-cover object-[50%_25%]"
                />
                <div class="absolute inset-0 bg-black/40"></div>
            </div>

            <div class="relative z-10 text-center px-6 max-w-4xl animate-fadeIn">
                <span class="text-london-gold font-medium tracking-[0.3em] text-sm md:text-base mb-4 block">ELEGÂNCIA BRITÂNICA EM CADA DETALHE</span>
                <h2 class="text-4xl md:text-6xl text-white font-serif mb-4 leading-tight">
                    O Vestido dos Seus Sonhos <br/> Está Aqui
                </h2>
                <p class="text-stone-200 text-lg md:text-xl mb-6 max-w-2xl mx-auto font-light">
                    Aluguel de vestidos exclusivos para noivas, madrinhas e ocasiões especiais. Viva uma experiência inesquecível com a curadoria London Noivas em Manaus.
                </p>
                <div class="flex flex-wrap gap-4 justify-center max-w-4xl mx-auto">
                    {% if occasion_tabs %}
                        {% for tab in occasion_tabs %}
                        <a href="{{ url_for('catalogo', occasion=tab.slug) }}" 
                           class="bg-white/10 backdrop-blur-sm border border-white/30 text-white px-6 py-3 rounded-sm font-medium tracking-wider hover:bg-white hover:text-stone-900 transition-all text-sm uppercase">
                            {{ tab.label }}
                        </a>
                        {% endfor %}
                    {% else %}
                        <a href="{{ url_for('catalogo') }}" class="bg-white/10 backdrop-blur-sm border border-white/30 text-white px-6 py-3 rounded-sm font-medium tracking-wider hover:bg-white hover:text-stone-900 transition-all text-sm uppercase">
                            VER CATÁLOGO
                        </a>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Intro Section -->
        <section id="sobre" class="pt-12 pb-4 md:pt-24 md:pb-12 bg-white">
            <div class="container mx-auto px-6 flex flex-col md:flex-row items-center gap-16">
                <div class="md:w-1/2 flex justify-center">
                    <div class="relative w-full md:w-[80%]">
                        <div class="absolute -top-4 -left-4 w-24 h-24 border-t-2 border-l-2 border-london-gold z-10"></div>
                        <!-- Imagem que representa o showroom real da foto enviada -->
                        <img 
                            src="{{ url_for('static', filename='london_noivas_image.png') }}" 
                            alt="Showroom London Noivas" 
                            class="w-full shadow-2xl relative z-0 rounded-sm object-contain aspect-[2/3] bg-stone-100"
                        />
                        <div class="absolute -bottom-8 -right-8 bg-london-gold p-8 hidden md:block shadow-xl">
                            <p class="text-white font-serif text-2xl italic leading-tight">"Elegância é a única beleza que nunca desaparece."</p>
                            <p class="text-white/80 text-sm mt-3 tracking-widest uppercase font-bold">— Audrey Hepburn</p>
                        </div>
                    </div>
                </div>
                <div class="md:w-1/2 space-y-8">
                    <div class="space-y-2">
                        <span class="text-london-gold font-bold tracking-[0.3em] text-xs uppercase">Tradição & Luxo Britânico</span>
                        <h2 class="text-4xl md:text-6xl font-serif text-stone-800 leading-tight">London Noivas: Onde os sonhos tomam forma</h2>
                    </div>
                    <p class="text-stone-600 leading-relaxed text-lg font-light">
                        Inspirada no requinte das grandes boutiques de Londres, a London Noivas oferece uma experiência de aluguel de luxo sem precedentes. 
                        Nosso showroom foi projetado para ser o seu santuário, onde cada prova de vestido é um momento de celebração e descoberta da sua melhor versão.
                    </p>
                    <div class="pt-4 grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-stone-50 flex items-center justify-center text-london-gold border border-london-gold/20">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <span class="text-stone-700 font-medium text-sm tracking-wide">Atendimento Personalizado</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-stone-50 flex items-center justify-center text-london-gold border border-london-gold/20">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <span class="text-stone-700 font-medium text-sm tracking-wide">Peças Exclusivas Nacionais e Importadas</span>
                        </div>
                    </div>
                    <div class="pt-6">
                        <a href="https://www.google.com.br/search?sca_esv=b91b52423da4ab6e&cs=0&output=search&kgmid=/g/11ymffx4qh&q=London+Noivas+e+Madrinhas&shem=bdsle,shrtn&shndl=30&source=sh/x/kp/local/m1/1&kgs=74936c11b6f17298&utm_source=bdsle,shrtn,sh/x/kp/local/m1/1&kgs=74936c11b6f17298&utm_source=bdsle,shrtn,sh/x/kp/local/m1/1" class="inline-block border-b-2 border-london-gold text-stone-800 font-bold tracking-widest pb-1 hover:text-london-gold transition-colors" onclick="openMapInfoModal(event, this.href, 'visite_nossa_loja', 'visit_shop', 'engagement')">
                            VISITE NOSSA LOJA
                        </a>
                    </div>
                </div>
            </div>
        </section>



        <!-- Features Section -->
        <section class="py-24 bg-stone-900 text-white">
            <div class="container mx-auto px-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-16">
                    <div class="flex flex-col items-center text-center group">
                        <div class="text-london-gold mb-6 group-hover:scale-110 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
                            </svg>
                        </div>
                        <h3 class="text-2xl font-serif mb-4 tracking-wider">Ajuste Sob Medida</h3>
                        <p class="text-stone-400 font-light leading-relaxed">
                            Costureiras especializadas garantem que o vestido fique perfeito no seu corpo.
                        </p>
                    </div>
                    <div class="flex flex-col items-center text-center group">
                        <div class="text-london-gold mb-6 group-hover:scale-110 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                            </svg>
                        </div>
                        <h3 class="text-2xl font-serif mb-4 tracking-wider">Acessórios Disponíveis</h3>
                        <p class="text-stone-400 font-light leading-relaxed">
                            Aluguel completo com véu, grinalda, bolsa, e outros acessórios selecionadas para o seu estilo.
                        </p>
                    </div>
                    <div class="flex flex-col items-center text-center group">
                        <div class="text-london-gold mb-6 group-hover:scale-110 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" />
                            </svg>
                        </div>
                        <h3 class="text-2xl font-serif mb-4 tracking-wider">Curadoria Exclusiva</h3>
                        <p class="text-stone-400 font-light leading-relaxed">
                            Modelos trazidos dos melhores fornecdores do Braisl e do mundo
                        </p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Showroom AI Section (Static) -->
        <section id="showroom" class="py-20 bg-stone-100">
            <div id="ai-chat-shell" class="relative transition-all duration-500">
                <button id="ai-chat-close" class="hidden fixed top-4 right-4 md:top-6 md:right-6 z-[90] rounded-full bg-white/90 p-2 text-stone-600 hover:text-stone-900 shadow-lg" onclick="collapseChatUI()" aria-label="Fechar chat">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div id="ai-chat-container" class="container mx-auto px-6">
                    <div class="flex flex-col lg:flex-row items-center gap-12 transition-all duration-500">
                    <div id="chat-wrapper" class="w-full space-y-6 transition-all duration-500">
                        <span class="text-london-gold font-bold tracking-widest text-sm">ESTILISTA VIRTUAL COM IA</span>
                        <h2 class="text-4xl md:text-5xl font-serif text-stone-800">Encontre o vestido perfeito com a Bella</h2>
                        <p class="text-stone-600 leading-relaxed">
                            Descreva a ocasião, a cor e o estilo que você imagina. A Bella entende sua descrição e busca no nosso acervo para sugerir as melhores opções — com fotos e alternativas parecidas.
                        </p>
                        
                        <div id="chat-box-container" class="bg-white rounded-lg shadow-xl border border-stone-200 overflow-hidden flex flex-col h-[400px]">
                            <div class="flex items-center justify-between px-4 py-3 bg-stone-900 text-white">
                                <div class="flex items-center gap-2">
                                    <div class="w-7 h-7 rounded-full bg-london-gold flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg>
                                    </div>
                                    <span class="text-xs tracking-widest font-semibold">ESTILISTA VIRTUAL COM IA</span>
                                </div>
                                <button class="rounded-full bg-white/20 p-1.5 text-white/70 hover:text-white" onclick="collapseChatUI()" aria-label="Fechar chat">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-stone-50 chat-scroll">
                                <div class="flex gap-3">
                                    <div class="w-8 h-8 rounded-full bg-london-gold flex items-center justify-center text-white flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                                        </svg>
                                    </div>
                                    <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm text-sm text-stone-700 max-w-[85%] border border-stone-100">
                                        Oi! Eu sou a Bella, sua estilista virtual com inteligência artificial. Me diga a ocasião e como você quer o vestido (modelo, cor, tecido e detalhes) e eu encontro as melhores opções do nosso acervo. Ex: "Procuro um vestido sereia com brilho para um casamento à noite"
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Input Area -->
                            <div class="p-4 bg-white border-t border-stone-200">
                                <div class="flex gap-2">
                                    <button onclick="resetChat()" class="p-2 text-stone-400 hover:text-stone-600 transition-colors" title="Nova Conversa">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                                        </svg>
                                    </button>
                                    <button id="ai-chat-expand" onclick="expandChatUI()" class="p-2 text-stone-400 hover:text-stone-600 transition-colors" title="Expandir tela">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9V5.25A1.5 1.5 0 0 1 5.25 3.75H9m6 0h3.75A1.5 1.5 0 0 1 20.25 5.25V9m0 6v3.75A1.5 1.5 0 0 1 18.75 20.25H15m-6 0H5.25A1.5 1.5 0 0 1 3.75 18.75V15" />
                                        </svg>
                                    </button>
                                    <input 
                                        type="text" 
                                        id="chat-input"
                                        placeholder="Digite aqui..."
                                        class="flex-1 p-3 border border-stone-300 rounded-sm focus:ring-2 focus:ring-london-gold outline-none text-sm"
                                        onkeypress="handleEnter(event)"
                                    />
                                    <button id="chat-send" onclick="sendMessage()" class="bg-stone-900 text-white px-4 py-2 rounded-sm hover:bg-london-gold transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="hidden lg:w-1/2 w-full aspect-[3/4] bg-white rounded-lg shadow-2xl overflow-hidden flex items-center justify-center border-4 border-white relative transition-all duration-500" id="result-frame">
                        <!-- Result State (Hidden by default) -->
                        <div id="result-state" class="w-full h-full relative group">
                             <img id="result-image" src="" alt="Vestido Recomendado" class="w-full h-full object-contain" />
                             <div id="result-overlay" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-6 text-white">
                                <h3 id="result-title" class="text-xl font-serif mb-2">Vestido Recomendado</h3>
                                <p id="result-desc" class="text-sm font-light opacity-90 line-clamp-3"></p>
                             </div>
                        </div>
                    </div>
                    </div>

                    <!-- Suggestions Gallery (Hidden by default) -->
                    <div id="suggestions-container" class="hidden mt-12 animate-fadeIn">
                        <h3 class="text-2xl font-serif text-stone-800 mb-6 text-center">Outras opções que combinam com sua necessidade</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="suggestions-grid">
                            <!-- Thumbnails will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Modal -->
            <div id="image-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <!-- Background backdrop -->
                <div class="fixed inset-0 bg-stone-900/90 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>

                <div class="fixed inset-0 z-10 overflow-y-auto">
                    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                        <div class="relative transform overflow-hidden rounded-sm bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                            
                            <div class="absolute top-0 right-0 pt-4 pr-4 z-20">
                                <button type="button" class="rounded-full bg-white/20 p-2 text-stone-500 hover:text-stone-800 focus:outline-none" onclick="closeModal()">
                                    <span class="sr-only">Close</span>
                                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <div class="flex flex-col md:flex-row">
                                <div class="md:w-1/2 aspect-[3/4] bg-stone-100 relative">
                                    <img id="modal-image" src="" alt="Detail View" class="absolute inset-0 w-full h-full object-contain">
                                </div>
                                <div class="md:w-1/2 p-8 flex flex-col justify-center">
                                    <h3 class="text-2xl font-serif text-london-gold mb-4">Detalhes da Peça</h3>
                                    <p id="modal-desc" class="text-stone-600 font-light leading-relaxed text-lg"></p>
                                    
                                    <div class="mt-8 pt-6 border-t border-stone-100">
                                        <button onclick="closeModal(); document.getElementById('chat-input').focus();" class="w-full bg-stone-900 text-white py-4 hover:bg-london-gold transition-colors font-bold tracking-widest text-sm">
                                            VOLTAR PARA A CONVERSA
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chat-overlay" class="fixed inset-0 z-[90] hidden" aria-hidden="true">
                <div class="absolute inset-0 bg-stone-900/70 backdrop-blur-sm"></div>
                <div class="relative h-full w-full flex flex-col p-4 md:p-6">
                    <div id="chat-overlay-panel" class="flex-1 min-h-0 w-full max-w-3xl mx-auto flex"></div>
                </div>
            </div>

            <script>
                let conversationHistory = [];
                const chatStorageKey = 'bella_chat_history';
                const chatHistoryLimit = 30;

                function normalizeSavedItems(items) {
                    if (!Array.isArray(items) || !items.length) return [];
                    const out = [];
                    for (const entry of items) {
                        if (!entry || typeof entry !== 'object') continue;
                        const imageUrl = entry.image_url || entry.imageUrl || '';
                        if (!imageUrl) continue;
                        const normalized = {
                            id: entry.id || entry.item_id || entry.custom_id,
                            customId: entry.customId || entry.custom_id,
                            title: entry.title,
                            description: entry.description,
                            price: entry.price,
                            image_url: imageUrl,
                            occasions: entry.occasions,
                            color: entry.color || entry.cor || entry.cores,
                            size: entry.size || entry.tamanho,
                            color_base: entry.color_base || entry.cor_base || entry.colorBase || entry.corBase,
                            color_comercial: entry.color_comercial || entry.cor_comercial || entry.colorCommercial || entry.corCommercial
                        };
                        out.push(normalized);
                        if (out.length >= 6) break;
                    }
                    return out;
                }

                function renderWelcome(container) {
                    container.innerHTML = `
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-london-gold flex items-center justify-center text-white flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                                </svg>
                            </div>
                            <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm text-sm text-stone-700 max-w-[85%] border border-stone-100">
                                Oi! Eu sou a Bella, sua estilista virtual com inteligência artificial. Me diga a ocasião e como você quer o vestido (modelo, cor, tecido e detalhes) e eu encontro as melhores opções do nosso acervo. Ex: "Procuro um vestido sereia com brilho para um casamento à noite"
                            </div>
                        </div>
                    `;
                }

                function saveChatHistory() {
                    try {
                        const trimmed = conversationHistory.slice(-chatHistoryLimit);
                        conversationHistory = trimmed;
                        localStorage.setItem(chatStorageKey, JSON.stringify(trimmed));
                    } catch (error) {
                        return;
                    }
                }

                function loadChatHistory() {
                    try {
                        const raw = localStorage.getItem(chatStorageKey);
                        if (!raw) return [];
                        const parsed = JSON.parse(raw);
                        if (!Array.isArray(parsed)) return [];
                        const cleaned = parsed
                            .filter((msg) => msg && ['user', 'assistant', 'thought'].includes(msg.role) && msg.content)
                            .map((msg) => ({
                                role: msg.role,
                                content: msg.content,
                                items: msg.role === 'assistant' && Array.isArray(msg.items) ? normalizeSavedItems(msg.items) : []
                            }));
                        return cleaned.slice(-chatHistoryLimit);
                    } catch (error) {
                        return [];
                    }
                }

                function restoreChatHistory() {
                    const container = document.getElementById('chat-messages');
                    if (!container) return;
                    renderWelcome(container);
                    const stored = loadChatHistory();
                    if (!stored.length) {
                        conversationHistory = [];
                        return;
                    }
                    conversationHistory = stored;
                    stored.forEach((msg) => {
                        addMessage(
                            msg.content,
                            msg.role === 'assistant' ? 'bot' : (msg.role === 'thought' ? 'thought' : 'user'),
                            msg.role === 'assistant' ? msg.items : null
                        );
                    });
                }

                window.addEventListener('load', () => {
                    restoreChatHistory();
                    const container = document.getElementById('chat-messages');
                    if (container) {
                        container.addEventListener('scroll', () => {
                            if (!autoScrollNextAssistant) return;
                            const distanceToBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
                            if (distanceToBottom > 200) autoScrollNextAssistant = false;
                        }, { passive: true });
                    }
                });

                function resetChat() {
                    conversationHistory = [];
                    const container = document.getElementById('chat-messages');
                    renderWelcome(container);
                    saveChatHistory();
                    
                    // Reset layout
                    const chatWrapper = document.getElementById('chat-wrapper');
                    const resultFrame = document.getElementById('result-frame');
                    
                    chatWrapper.classList.add('w-full');
                    chatWrapper.classList.remove('lg:w-1/2');
                    
                    resultFrame.classList.add('hidden');
                    
                    document.getElementById('suggestions-container').classList.add('hidden');
                }

                function handleEnter(e) {
                    if (e.key === 'Enter') sendMessage();
                }

                let autoScrollNextAssistant = false;

                function setChatBusy(isBusy) {
                    const input = document.getElementById('chat-input');
                    const sendBtn = document.getElementById('chat-send');
                    if (input) {
                        input.disabled = !!isBusy;
                        input.classList.toggle('opacity-60', !!isBusy);
                        input.classList.toggle('cursor-not-allowed', !!isBusy);
                    }
                    if (sendBtn) {
                        sendBtn.disabled = !!isBusy;
                        sendBtn.classList.toggle('opacity-60', !!isBusy);
                        sendBtn.classList.toggle('cursor-not-allowed', !!isBusy);
                    }
                }

                const chatOverlayState = {
                    expanded: false,
                    parent: null,
                    nextSibling: null
                };

                function expandChatUI() {
                    const expandBtn = document.getElementById('ai-chat-expand');
                    const chatBox = document.getElementById('chat-box-container');
                    const overlay = document.getElementById('chat-overlay');
                    const overlayPanel = document.getElementById('chat-overlay-panel');
                    if (!chatBox || !overlay || !overlayPanel || chatOverlayState.expanded) return;
                    chatOverlayState.expanded = true;
                    chatOverlayState.parent = chatBox.parentElement;
                    chatOverlayState.nextSibling = chatBox.nextElementSibling;
                    overlay.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                    if (expandBtn) expandBtn.classList.add('hidden');
                    overlayPanel.appendChild(chatBox);
                    chatBox.classList.remove('h-[400px]');
                    chatBox.classList.add('h-full', 'flex-1', 'min-h-0');
                }

                function collapseChatUI() {
                    const expandBtn = document.getElementById('ai-chat-expand');
                    const chatBox = document.getElementById('chat-box-container');
                    const overlay = document.getElementById('chat-overlay');
                    if (!chatBox || !overlay || !chatOverlayState.expanded) return;
                    overlay.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                    if (expandBtn) expandBtn.classList.remove('hidden');
                    chatBox.classList.add('h-[400px]');
                    chatBox.classList.remove('h-full', 'flex-1', 'min-h-0');
                    if (chatOverlayState.parent) {
                        if (chatOverlayState.nextSibling) {
                            chatOverlayState.parent.insertBefore(chatBox, chatOverlayState.nextSibling);
                        } else {
                            chatOverlayState.parent.appendChild(chatBox);
                        }
                    }
                    chatOverlayState.expanded = false;
                }

                async function sendMessage() {
                    const input = document.getElementById('chat-input');
                    const message = input.value.trim();
                    if (!message) return;

                    expandChatUI();
                    addMessage(message, 'user');
                    autoScrollNextAssistant = true;
                    input.value = '';
                    conversationHistory.push({ role: "user", content: message });
                    saveChatHistory();
                    setChatBusy(true);
                    
                    // Add loading indicator
                    const loadingId = addLoading({ forceScroll: true });
                    const loadingEl = document.getElementById(loadingId);
                    const loadingTextEl = loadingEl ? loadingEl.querySelector('span') : null;
                    const loadingThoughtEl = loadingEl ? loadingEl.querySelector('[data-bella-thinking="1"]') : null;

                    try {
                        const historySnapshot = conversationHistory
                            .filter((msg) => msg && ['user', 'assistant'].includes(msg.role) && msg.content)
                            .slice(-10)
                            .map((msg) => ({
                                role: msg.role,
                                content: msg.content
                            }));
                        
                        const response = await fetch('/api/ai-search', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                message: message,
                                history: historySnapshot
                            })
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        const pensamentosSet = new Set();
                        let thoughtRawText = '';
                        const appendThought = (raw) => {
                            const text = String(raw || '').replace(/^Pensamento:\s*/i, '').trim();
                            if (!text || pensamentosSet.has(text)) return;
                            pensamentosSet.add(text);
                            thoughtRawText = thoughtRawText ? `${thoughtRawText}\n${text}` : text;
                            if (loadingThoughtEl) loadingThoughtEl.textContent = thoughtRawText;
                            const container = document.getElementById('chat-messages');
                            if (container && loadingEl) scrollChatToMessage(container, loadingEl, 'end');
                        };

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n\n');
                            buffer = lines.pop(); // Keep the last incomplete chunk

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        
                                        if (data.type === 'thinking' && data.content) {
                                            appendThought(data.content);
                                            if (loadingTextEl) loadingTextEl.textContent = 'Bella está pensando';
                                        } else if (data.reply || data.error || (data.items && data.items.length > 0)) {
                                            // Final result
                                            removeMessage(loadingId);
                                            setChatBusy(false);

                                            const pensamentos = Array.isArray(data.pensamentos) ? data.pensamentos : [];
                                            pensamentos.forEach(appendThought);
                                            if (thoughtRawText) {
                                                addMessage(thoughtRawText, 'thought', null, { forceScroll: autoScrollNextAssistant, block: 'end' });
                                                conversationHistory.push({ role: "thought", content: thoughtRawText });
                                                saveChatHistory();
                                            }
                                            
                                            if (data.reply) {
                                                addMessage(data.reply, 'bot', data.items || [], { forceScroll: autoScrollNextAssistant, block: 'start' });
                                                autoScrollNextAssistant = false;
                                                conversationHistory.push({ role: "assistant", content: data.reply, items: normalizeSavedItems(data.items || []) });
                                                saveChatHistory();
                                            }
                                            
                                            const resultFrame = document.getElementById('result-frame');
                                            const suggestionsContainer = document.getElementById('suggestions-container');
                                            if (resultFrame) resultFrame.classList.add('hidden');
                                            if (suggestionsContainer) suggestionsContainer.classList.add('hidden');

                                            if (data.error) {
                                                if (typeof data.error === "string") {
                                                    addMessage("Desculpe, ocorreu um erro: " + data.error, 'bot', null, { forceScroll: autoScrollNextAssistant, block: 'start' });
                                                } else if (data.error.type && data.error.type !== "no_results") {
                                                    const msg = data.error.message || "Erro inesperado.";
                                                    addMessage("Desculpe, ocorreu um erro: " + msg, 'bot', null, { forceScroll: autoScrollNextAssistant, block: 'start' });
                                                } else if (!data.reply && data.error.type === "no_results") {
                                                    addMessage(data.error.message || "Não encontrei resultados.", 'bot', null, { forceScroll: autoScrollNextAssistant, block: 'start' });
                                                }
                                                autoScrollNextAssistant = false;
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Error parsing SSE:', e);
                                    }
                                }
                            }
                        }

                    } catch (error) {
                        removeMessage(loadingId);
                        setChatBusy(false);
                        addMessage("Desculpe, tive um problema de conexão. Tente novamente.", 'bot', null, { forceScroll: autoScrollNextAssistant, block: 'start' });
                        autoScrollNextAssistant = false;
                        console.error(error);
                    }
                }

                function renderMarkdown(text) {
                    const escapeHtml = (value) => String(value ?? "")
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");

                    const normalizeUrl = (value) => String(value ?? "")
                        .trim()
                        .replace(/^`+|`+$/g, "")
                        .replace(/^"+|"+$/g, "")
                        .replace(/^'+|'+$/g, "")
                        .replace(/&lt;\/?[^&]+?&gt;/g, "");

                    const applyInlineFormatting = (value) => String(value ?? "")
                        .replace(/\*\*([^*]+)\*\*/g, '<strong class="font-serif text-stone-900">$1</strong>')
                        .replace(/__([^_]+)__/g, '<strong class="font-serif text-stone-900">$1</strong>')
                        .replace(/(^|[^*])\*([^*]+)\*(?!\*)/g, '$1<em>$2</em>')
                        .replace(/(^|[^_])_([^_]+)_(?!_)/g, '$1<em>$2</em>');

                    let content = escapeHtml(text).replace(/\r\n/g, '\n');

                    content = content
                        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, url) => (
                            `<div class="bella-chat-item flex justify-center my-2"><div class="bella-chat-inner flex flex-col sm:flex-row gap-3 items-start sm:items-center max-w-full"><div class="bella-chat-media bg-white p-1 rounded-md shadow-md ring-1 ring-stone-200 hover:shadow-lg transition-shadow flex-shrink-0"><img src="${normalizeUrl(url)}" alt="${alt}" class="bella-chat-img w-[240px] max-w-[240px] h-auto rounded-[0.2rem] object-contain"></div><div class="bella-chat-meta hidden text-left text-sm text-stone-700 leading-relaxed"></div></div></div>`
                        ))
                        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, label, url) => (
                            `<a href="${normalizeUrl(url)}" class="text-london-gold underline" target="_blank" rel="noopener noreferrer">${label}</a>`
                        ))
                        .replace(/^\s*###\s+(.+)$/gm, '<div class="text-lg font-serif text-stone-900 font-semibold">$1</div>')
                        .replace(/^\s*##\s+(.+)$/gm, '<div class="text-xl font-serif text-stone-900 font-semibold">$1</div>')
                        .replace(/^\s*#\s+(.+)$/gm, '<div class="text-2xl font-serif text-stone-900 font-semibold">$1</div>');

                    content = content
                        .split(/(<[^>]+>)/g)
                        .map((chunk) => {
                            if (chunk.startsWith("<")) return chunk;
                            return applyInlineFormatting(chunk).replace(/\n/g, "<br>");
                        })
                        .join("");

                    const listProcessed = content
                        .replace(/(?:^|\n)(?:\s*[-*]\s+.+(?:\n|$))+/g, (block) => {
                            const items = block.trim().split(/\n/).map((line) => line.replace(/^\s*[-*]\s+/, '').trim());
                            const html = items.map((item) => `<li class="list-disc ml-5">${item}</li>`).join('');
                            return `\n<ul class="my-2">${html}</ul>\n`;
                        })
                        .replace(/(?:^|\n)(?:\s*\d+\.\s+.+(?:\n|$))+/g, (block) => {
                            const items = block.trim().split(/\n/).map((line) => line.replace(/^\s*\d+\.\s+/, '').trim());
                            const html = items.map((item) => `<li class="list-decimal ml-5">${item}</li>`).join('');
                            return `\n<ol class="my-2">${html}</ol>\n`;
                        });
                    return listProcessed.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-london-gold underline" target="_blank" rel="noopener noreferrer">$1</a>');
                }

                function scrollChatToMessage(container, messageEl, block) {
                    if (!container || !messageEl) return;
                    const margin = 8;
                    const top = messageEl.offsetTop - margin;
                    const bottom = messageEl.offsetTop + messageEl.offsetHeight + margin;
                    let targetTop = container.scrollTop;
                    if (block === 'start') {
                        targetTop = top;
                    } else if (block === 'end') {
                        targetTop = bottom - container.clientHeight;
                    } else {
                        if (top < container.scrollTop) {
                            targetTop = top;
                        } else if (bottom > (container.scrollTop + container.clientHeight)) {
                            targetTop = bottom - container.clientHeight;
                        }
                    }
                    container.scrollTop = Math.max(0, targetTop);
                }

                function escapeHtmlSimple(value) {
                    return String(value ?? "")
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                }

                function stripMarkdownImages(value) {
                    return String(value ?? "").replace(/!\[[^\]]*\]\([^)]+\)/g, "").trim();
                }

                function stripNumberedResultsList(value) {
                    const text = String(value ?? "");
                    const match = text.match(/(^|\n)\s*1\.\s+/m);
                    if (!match || typeof match.index !== 'number') return text.trim();
                    const startIndex = match.index + (match[1] ? match[1].length : 0);
                    const before = text.slice(0, startIndex).trim();
                    const afterChunk = text.slice(startIndex);
                    const marker = afterChunk.search(/^\s*(Para esta busca|O que você|Alguma característica|Quer ajustar|Quer que eu)\b/m);
                    const after = marker >= 0 ? afterChunk.slice(marker).trim() : '';
                    return [before, after].filter((p) => p && p.trim()).join('\n\n').trim();
                }

                function renderItemCards(items) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'mt-2 fade-in';

                    const list = document.createElement('div');
                    list.className = 'space-y-1.5';
                    wrapper.appendChild(list);

                    const total = Array.isArray(items) ? items.length : 0;
                    (Array.isArray(items) ? items : []).forEach((rawItem, index) => {
                        const item = rawItem || {};
                        const imageUrl = (item.image_url || item.imageUrl || '').toString().trim();
                        const title = (item.title || item.name || 'Sugestão Exclusiva').toString();
                        const description = (item.description || item.desc || '').toString();
                        const itemId = (item.id || item.itemId || '').toString();
                        const price = item.price || "Valor do aluguel: Consulte";
                        const customId = item.customId || item.custom_id || item.customID || null;
                        const occasions = item.occasions || '';
                        const color = item.color || '';
                        const size = item.size || '';
                        const colorBase = item.color_base || item.cor_base || item.colorBase || item.corBase || '';
                        const colorCommercial = item.color_comercial || item.cor_comercial || item.colorCommercial || item.corCommercial || '';
                        const itemObs = item.item_obs || item.itemObs || '';

                        const badgeColor = index === 0 ? 'bg-london-gold' : 'bg-stone-600';
                        const badgeLabel = total === 1 ? '★' : String(index + 1);
                        const hasImage = !!imageUrl;

                        const tags = [];
                        const occText = Array.isArray(occasions) ? occasions.join(', ') : String(occasions || '');
                        const colorText = (colorBase || colorCommercial)
                            ? [String(colorBase || '').trim(), String(colorCommercial || '').trim()].filter(Boolean).join(' / ')
                            : String(color || '').trim();
                        const sizeText = String(size || '').trim();

                        if (occText.trim()) tags.push(occText.trim());
                        if (colorText) tags.push(colorText);
                        if (sizeText) tags.push(sizeText);

                        const tagsHtml = tags.slice(0, 3).map((t) =>
                            `<span class="text-[10px] text-stone-500 bg-stone-50 px-1.5 py-0.5 rounded-full border border-stone-100 leading-none">${escapeHtmlSimple(t)}</span>`
                        ).join('');

                        const card = document.createElement('div');
                        card.className = 'bella-item-card stagger-item bg-white rounded-lg border border-stone-200 overflow-hidden cursor-pointer flex';

                        const thumb = document.createElement('div');
                        if (hasImage) {
                            thumb.className = 'item-thumb w-[72px] sm:w-[88px] flex-shrink-0 bg-stone-100 overflow-hidden relative self-stretch';
                            thumb.innerHTML = `
                                <img src="${escapeHtmlSimple(imageUrl)}" class="w-full h-full object-cover transition-transform duration-500" alt="${escapeHtmlSimple(title)}" loading="lazy">
                                <div class="absolute top-1.5 left-1.5">
                                    <span class="${badgeColor} text-white text-[9px] font-bold tracking-wider w-5 h-5 rounded-full flex items-center justify-center shadow-sm">${escapeHtmlSimple(badgeLabel)}</span>
                                </div>
                            `;
                        } else {
                            thumb.className = 'item-thumb w-[72px] sm:w-[88px] flex-shrink-0 bg-stone-100 overflow-hidden relative self-stretch flex items-center justify-center';
                            thumb.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="w-8 h-8 text-stone-300">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5A2.25 2.25 0 0 0 22.5 18.75V5.25A2.25 2.25 0 0 0 20.25 3H3.75A2.25 2.25 0 0 0 1.5 5.25v13.5A2.25 2.25 0 0 0 3.75 21Z" />
                                </svg>
                                <div class="absolute top-1.5 left-1.5">
                                    <span class="${badgeColor} text-white text-[9px] font-bold tracking-wider w-5 h-5 rounded-full flex items-center justify-center shadow-sm">${escapeHtmlSimple(badgeLabel)}</span>
                                </div>
                            `;
                        }

                        const body = document.createElement('div');
                        body.className = 'p-2.5 sm:p-3 flex-1 min-w-0 flex flex-col justify-center gap-1';
                        body.innerHTML = `
                            <div class="flex items-start justify-between gap-2">
                                <h4 class="font-serif text-stone-900 text-[13px] sm:text-sm leading-tight">${escapeHtmlSimple(title)}</h4>
                                ${itemId ? `<span class="text-[9px] text-stone-400 font-mono flex-shrink-0 bg-stone-50 px-1.5 py-0.5 rounded">${escapeHtmlSimple(customId || itemId)}</span>` : ''}
                            </div>
                            <p class="text-stone-500 text-[11px] sm:text-xs leading-relaxed line-clamp-2">${escapeHtmlSimple(description)}</p>
                            <div class="flex items-center gap-1.5 flex-wrap mt-0.5">
                                ${tagsHtml}
                                <span class="item-cta text-london-gold text-[11px] font-bold ml-auto flex-shrink-0 transition-colors">Ver detalhes →</span>
                            </div>
                        `;

                        card.appendChild(thumb);
                        card.appendChild(body);
                        card.addEventListener('click', () => {
                            openCatalogModal(
                                imageUrl || 'https://via.placeholder.com/600x800?text=Sem+Imagem',
                                title,
                                description,
                                itemId,
                                price,
                                'ai_chat',
                                customId,
                                occText,
                                color,
                                sizeText,
                                colorBase,
                                colorCommercial,
                                itemObs
                            );
                        });
                        list.appendChild(card);
                    });

                    const hint = document.createElement('p');
                    hint.className = 'text-[11px] text-stone-400 mt-2 flex items-center gap-1.5';
                    hint.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672ZM12 2.25V4.5m5.834.166-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243-1.59-1.59" /></svg>
                        <span>Toque em qualquer item para ver detalhes completos</span>
                    `;
                    wrapper.appendChild(hint);

                    return wrapper;
                }

                function addMessage(text, sender, items, options) {
                    const container = document.getElementById('chat-messages');
                    const resolvedOptions = options && typeof options === 'object' ? options : {};
                    const forceScroll = !!resolvedOptions.forceScroll;
                    const block = resolvedOptions.block || (sender === 'bot' ? 'start' : 'end');
                    const wasNearBottom = !!container && (container.scrollHeight - container.scrollTop - container.clientHeight) < 120;
                    const div = document.createElement('div');
                    const isUser = sender === 'user';
                    const isThought = sender === 'thought';
                    const isBot = sender === 'bot' || isThought;
                    div.className = "flex gap-3 " + (isUser ? "flex-row-reverse" : "");
                    
                    const avatar = isBot
                        ? `<div class="w-8 h-8 rounded-full bg-london-gold flex items-center justify-center text-white flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" /></svg></div>`
                        : `<div class="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center text-stone-600 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg></div>`;
                    
                    const bubbleClass = isThought
                        ? "bg-stone-50 text-stone-500 rounded-tl-none border-stone-200 italic"
                        : (isBot ? "bg-white text-stone-700 rounded-tl-none border-stone-100" : "bg-stone-800 text-white rounded-tr-none");
                    
                    const hasItems = sender === 'bot' && Array.isArray(items) && items.length;
                    const cleanText = hasItems ? stripNumberedResultsList(stripMarkdownImages(text)) : text;
                    const markdownText = renderMarkdown(cleanText);
                    if (isBot) {
                        if (isThought) {
                            div.innerHTML = `
                                ${avatar}
                                <div class="flex flex-col gap-1 max-w-[85%]" data-bella-message-body="1">
                                    <div class="text-[11px] text-stone-400 tracking-wide">Pensamento da IA</div>
                                    <div class="bella-chat-bubble ${bubbleClass} p-3 rounded-lg shadow-sm text-sm border">
                                        ${markdownText}
                                    </div>
                                </div>
                            `;
                        } else {
                            div.innerHTML = `
                                ${avatar}
                                <div class="flex flex-col gap-1 max-w-[85%]" data-bella-message-body="1">
                                    <div class="bella-chat-bubble ${bubbleClass} p-3 rounded-lg shadow-sm text-sm border">
                                        ${markdownText}
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        div.innerHTML = `
                            ${avatar}
                            <div class="bella-chat-bubble ${bubbleClass} p-3 rounded-lg shadow-sm text-sm max-w-[85%] border">
                                ${markdownText}
                            </div>
                        `;
                    }

                    if (hasItems) {
                        const body = div.querySelector('[data-bella-message-body="1"]');
                        if (body) body.appendChild(renderItemCards(items));
                    }
                    
                    container.appendChild(div);
                    if (forceScroll || wasNearBottom) {
                        scrollChatToMessage(container, div, block);
                    }
                    return div;
                }

                function addLoading(options) {
                    const id = 'loading-' + Date.now();
                    const container = document.getElementById('chat-messages');
                    const resolvedOptions = options && typeof options === 'object' ? options : {};
                    const forceScroll = !!resolvedOptions.forceScroll;
                    const doNotScroll = !!resolvedOptions.doNotScroll;
                    const wasNearBottom = !!container && (container.scrollHeight - container.scrollTop - container.clientHeight) < 120;
                    const div = document.createElement('div');
                    div.id = id;
                    div.className = "flex gap-3";
                    div.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-london-gold flex items-center justify-center text-white flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 animate-spin"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg>
                        </div>
                        <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm text-sm text-stone-500 border border-stone-100 flex flex-col gap-2 max-w-[85%]">
                            <div class="flex items-center gap-2">
                                <span class="italic">Bella está pensando</span>
                                <div class="flex space-x-1 h-3 items-center">
                                    <div class="w-2 h-2 bg-london-gold rounded-full animate-bounce" style="animation-delay: 0s"></div>
                                    <div class="w-2 h-2 bg-london-gold rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-2 bg-london-gold rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                            </div>
                            <div data-bella-thinking="1" class="text-xs text-stone-400 whitespace-pre-line"></div>
                        </div>
                    `;
                    container.appendChild(div);
                    if (forceScroll || (!doNotScroll && wasNearBottom)) {
                        scrollChatToMessage(container, div, 'end');
                    }
                    return id;
                }

                let bellaOccasionFilter = [];
                let bellaQueryFilter = '';

                function removeMessage(id) {
                    const el = document.getElementById(id);
                    if (el) el.remove();
                }

                function showResult(dress, suggestions, requestedOccasions, requestedQuery) {
                    const chatWrapper = document.getElementById('chat-wrapper');
                    const resultFrame = document.getElementById('result-frame');
                    const img = document.getElementById('result-image');
                    const title = document.getElementById('result-title');
                    const desc = document.getElementById('result-desc');
                    if (Array.isArray(requestedOccasions) && requestedOccasions.length) {
                        bellaOccasionFilter = requestedOccasions;
                    } else if (requestedOccasions) {
                        bellaOccasionFilter = [requestedOccasions];
                    }
                    if (typeof requestedQuery === 'string' && requestedQuery.trim()) {
                        bellaQueryFilter = requestedQuery.trim();
                    }

                    // Adjust layout
                    chatWrapper.classList.remove('w-full');
                    chatWrapper.classList.add('lg:w-1/2');
                    
                    resultFrame.classList.remove('hidden');
                    
                    img.src = dress.image_url;
                    title.textContent = "Recomendação Principal";
                    desc.textContent = dress.description;

                    // Ensure overlay is visible when new result comes in
                    const overlay = document.getElementById('result-overlay');
                    if (overlay) overlay.classList.remove('hidden');

                    // Add click handler to open details
                    const imgContainer = img.parentElement;
                    imgContainer.style.cursor = "pointer";
                    imgContainer.onclick = () => {
                        // Hide overlay on click
                        if (overlay) overlay.classList.add('hidden');
                        
                        openCatalogModal(
                            dress.image_url,
                            dress.title || "Sugestão Exclusiva",
                            dress.description,
                            dress.id,
                            dress.price || "Valor do aluguel: Consulte",
                            'ai_result',
                            dress.customId,
                            dress.occasions,
                            dress.color || dress.cor || dress.cores,
                            dress.size || dress.tamanho,
                            dress.color_base || dress.cor_base || dress.colorBase || dress.corBase,
                            dress.color_comercial || dress.cor_comercial || dress.colorCommercial || dress.corCommercial,
                            dress.item_obs || dress.itemObs
                        )
                    };

                    document.getElementById('suggestions-container').classList.add('hidden');

                    return;
                }

                function showSuggestions(suggestions, targetOccasions) {
                    const container = document.getElementById('suggestions-container');
                    const grid = document.getElementById('suggestions-grid');
                    grid.innerHTML = ''; // Limpa anteriores

                    const normalizeSlug = (s) => (s || '')
                        .toString()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '_')
                        .replace(/^_+|_+$/g, '')
                        .replace(/_+/g, '_');

                    const parseOccasionsToSlugs = (occasionsVal) => {
                        if (!occasionsVal) return [];
                        const str = Array.isArray(occasionsVal) ? occasionsVal.join(', ') : occasionsVal.toString();
                        return str
                            .split(',')
                            .map(s => normalizeSlug(s.trim()))
                            .filter(Boolean);
                    };

                    const targetSet = new Set(parseOccasionsToSlugs(targetOccasions));
                    const filtered = targetSet.size > 0
                        ? suggestions.filter(s => parseOccasionsToSlugs(s.occasions).some(o => targetSet.has(o)))
                        : suggestions;

                    filtered.forEach((item, index) => {
                        if(index >= 4) return;
                        const div = document.createElement('div');
                        div.className = "aspect-[3/4] bg-stone-200 cursor-pointer overflow-hidden rounded-sm relative group";
                        div.onclick = () => openCatalogModal(
                            item.image_url,
                            item.title || "Sugestão Exclusiva",
                            item.description,
                            item.id,
                            item.price || "Valor do aluguel: Consulte",
                            'ai_suggestion',
                            item.customId,
                            item.occasions,
                            item.color || item.cor || item.cores,
                            item.size || item.tamanho,
                            item.color_base || item.cor_base || item.colorBase || item.corBase,
                            item.color_comercial || item.cor_comercial || item.colorCommercial || item.corCommercial,
                            item.item_obs || item.itemObs
                        );
                        
                        div.innerHTML = `
                            <img src="${item.image_url}" class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-500" alt="Sugestão">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all flex items-center justify-center">
                                <span class="text-white opacity-0 group-hover:opacity-100 font-serif tracking-widest text-xs border border-white px-3 py-1">VER DETALHES</span>
                            </div>
                        `;
                        grid.appendChild(div);
                    });

                    if (filtered.length > 0) {
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                }

                function openModal(item) {
                    const modal = document.getElementById('image-modal');
                    document.getElementById('modal-image').src = item.image_url;
                    document.getElementById('modal-desc').textContent = item.description;
                    modal.classList.remove('hidden');
                }

                function closeModal() {
                    document.getElementById('image-modal').classList.add('hidden');
                }
            </script>
                </div>
            </div>
        </section>

        <!-- Testimonials -->
        <section class="py-24 bg-stone-50 overflow-hidden">
            <div class="container mx-auto px-6 text-center mb-16">
                <h2 class="text-4xl md:text-5xl font-serif text-stone-800">Experiências London Noivas</h2>
                <div class="w-20 h-0.5 bg-london-gold mx-auto mt-4"></div>
            </div>
            <div class="flex flex-wrap justify-center gap-8">
                <!-- Testimonial 1 -->
                <div class="bg-white p-10 rounded-sm shadow-sm max-w-sm border-t-4 border-london-gold">
                    <div class="flex justify-center mb-6">
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                    </div>
                    <p class="text-stone-600 italic mb-6 leading-relaxed">"O atendimento foi impecável. O vestido parecia ter sido feito no meu corpo."</p>
                    <div class="font-bold text-stone-800 tracking-widest text-sm uppercase">Mariana Silva</div>
                    <div class="text-london-gold text-xs mt-1 uppercase font-bold tracking-tighter">Noiva 2025</div>
                </div>

                <!-- Testimonial 2 -->
                <div class="bg-white p-10 rounded-sm shadow-sm max-w-sm border-t-4 border-london-gold">
                    <div class="flex justify-center mb-6">
                        <!-- Stars -->
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                    </div>
                    <p class="text-stone-600 italic mb-6 leading-relaxed">"A London Noivas superou todas as minhas expectativas. O acervo é maravilhoso."</p>
                    <div class="font-bold text-stone-800 tracking-widest text-sm uppercase">Beatriz Costa</div>
                    <div class="text-london-gold text-xs mt-1 uppercase font-bold tracking-tighter">Madrinha</div>
                </div>

                <!-- Testimonial 3 -->
                <div class="bg-white p-10 rounded-sm shadow-sm max-w-sm border-t-4 border-london-gold">
                    <div class="flex justify-center mb-6">
                        <!-- Stars -->
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <svg class="w-4 h-4 text-london-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                    </div>
                    <p class="text-stone-600 italic mb-6 leading-relaxed">"Amei o Estilista Virtual com IA! Me ajudou muito a decidir o que eu queria."</p>
                    <div class="font-bold text-stone-800 tracking-widest text-sm uppercase">Fernanda Lima</div>
                    <div class="text-london-gold text-xs mt-1 uppercase font-bold tracking-tighter">Formanda</div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="contato" class="bg-stone-50 pt-20 pb-10 border-t border-stone-200">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-16">
                <div class="col-span-1 md:col-span-2">
                    <h2 class="text-3xl font-serif mb-6 tracking-widest text-stone-800">LONDON NOIVAS</h2>
                    <p class="text-stone-500 mb-8 max-w-sm">
                        Tornando momentos especiais em memórias eternas através da elegância e sofisticação que você merece.
                    </p>
                    <div class="flex gap-4">
                        <a href="https://instagram.com/londonnoivas" target="_blank" class="flex items-center gap-3 group">
                            <div class="w-10 h-10 border border-stone-300 rounded-full flex items-center justify-center group-hover:bg-london-gold group-hover:text-white group-hover:border-london-gold transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.281.11-.705.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.486-.276a2.478 2.478 0 0 1-.919-.598 2.48 2.48 0 0 1-.599-.92c-.11-.281-.24-.705-.275-1.485-.038-.843-.047-1.096-.047-3.232 0-2.136.009-2.388.047-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/>
                                </svg>
                            </div>
                            <span class="text-stone-500 font-bold text-sm tracking-widest group-hover:text-london-gold transition-colors">@londonnoivas</span>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-stone-800 mb-6 tracking-widest uppercase text-sm">Onde Estamos</h4>
                    <ul class="space-y-4 text-stone-500 text-sm mb-6">
                        <li>Rua Voltaire, 9</li>
                        <li>Colônia Santo Antônio - Manaus - AM</li>
                        <li>Seg - Sáb: 10h às 20h</li>
                        <li>Tel/WhatsApp: <span id="phone-display-index" class="cursor-pointer underline decoration-dotted text-london-gold" onclick="revealPhone('phone-display-index')">Ver número</span></li>
                    </ul>
                    <div class="rounded-sm overflow-hidden shadow-md border border-stone-200">
                        <a href="https://maps.app.goo.gl/iTZXMqYrz5CS9Xax6" onclick="openMapInfoModal(event, this.href, 'footer_map_image')" class="block w-full h-[200px] bg-stone-100">
                            <img src="{{ url_for('static', filename='mapa.png') }}" alt="Localização London Noivas" class="w-full h-full object-cover hover:opacity-90 transition-opacity">
                        </a>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-stone-800 mb-6 tracking-widest uppercase text-sm">Links Rápidos</h4>
                    <ul class="space-y-4 text-stone-500 text-sm">
                        <li><a href="#colecoes" class="hover:text-london-gold transition-colors">Destaques</a></li>
                        <li><a href="{{ url_for('catalogo') }}" class="hover:text-london-gold transition-colors">Catálogo Completo</a></li>
                        <li><a href="#showroom" class="hover:text-london-gold transition-colors">Estilista Virtual com IA</a></li>
                        <li><a href="https://wa.me/5592993531943" target="_blank" onclick="trackWhatsAppClick('footer_link')" class="hover:text-london-gold transition-colors">Agendamento/Dúvidas</a></li>
                        <li>
                             {% if not session.get('logged_in') %}
                             <a href="{{ url_for('login', next=url_for('agenda')) }}" class="hover:text-london-gold transition-colors">Área Restrita</a>
                             {% else %}
                             <a href="{{ url_for('agenda') }}" class="hover:text-london-gold transition-colors">Painel Admin</a>
                             {% endif %}
                        </li>
                    </ul>
                </div>
            </div>

            <div class="border-t border-stone-200 pt-8 text-center text-stone-400 text-xs">
                <p>&copy; 2025 London Noivas. Todos os direitos reservados. Desenvolvido com sofisticação.</p>
            </div>
        </div>
        
        <!-- Floating AI Stylist CTA -->
        <div id="ai-stylist-cta" class="fixed bottom-32 right-8 z-50 group">
            <!-- The Chat Bubble (Hidden by default, shown on hover/focus) -->
            <div id="ai-cta-bubble" class="absolute bottom-full right-0 mb-6 bg-white p-6 rounded-lg shadow-2xl border-l-4 border-london-gold w-[90vw] sm:w-[450px] transform scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100 group-focus-within:scale-100 group-focus-within:opacity-100 transition-all duration-300 origin-bottom-right">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="font-serif text-london-gold font-bold text-xl">Estilista Virtual com IA</h4>
                    <span class="text-sm bg-stone-100 text-stone-500 px-3 py-1 rounded-full">Beta</span>
                </div>
                <p class="text-base text-stone-600 mb-5 font-light leading-relaxed">
                    Oi! Eu sou a Bella, Vou te ajudar a encontrar o vestido ideal pra você. Me fale sobre o evento, cor, estilo, etc.
                    <span class="block text-sm text-stone-400 mt-3 italic border-t border-stone-100 pt-3">Ex: "Procuro um vestido sereia com brilho para um casamento à noite"</span>
                </p>
                <div class="flex gap-2 relative">
                    <input type="text" id="ai-cta-input" placeholder="Digite aqui..." 
                           class="w-full text-base border border-stone-200 rounded-sm px-4 py-3 pr-12 focus:border-london-gold focus:ring-1 focus:ring-london-gold outline-none transition-all"
                           onkeypress="handleAiCtaEnter(event)">
                    <button onclick="submitAiCta()" class="absolute right-3 top-1/2 -translate-y-1/2 text-london-gold hover:text-stone-800 transition-colors p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                    </button>
                </div>
            </div>
        
            <!-- The Icon Trigger -->
            <button class="bg-stone-900 text-white p-4 rounded-full shadow-2xl hover:bg-london-gold transition-colors relative group-hover:rotate-12 duration-300">
                <!-- Notification Dot -->
                <span class="absolute -top-1 -right-1 flex h-4 w-4">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-london-gold opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-4 w-4 bg-london-gold border-2 border-white"></span>
                </span>
                
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 00-1.423 1.423z" />
                </svg>
            </button>
        </div>

        <script>
            function handleAiCtaEnter(e) {
                if (e.key === 'Enter') submitAiCta();
            }

            function redirectToBella(text) {
                const url = new URL(window.location.origin + '/');
                if (text) {
                    url.searchParams.set('bella_query', text);
                }
                url.hash = 'showroom';
                window.location.href = url.toString();
            }
        
            function submitAiCta() {
                const ctaContainer = document.getElementById('ai-stylist-cta');
                const ctaInput = document.getElementById('ai-cta-input');
                const mainInput = document.getElementById('chat-input');
                const bubble = document.getElementById('ai-cta-bubble');
                const text = ctaInput.value.trim();
        
                if (text) {
                    const chatBox = document.getElementById('chat-box-container');
                    const showroom = document.getElementById('showroom');
                    if (!chatBox && !showroom) {
                        redirectToBella(text);
                        return;
                    }

                    // Close bubble and remove focus
                    ctaInput.blur();
                    if (bubble) {
                        bubble.style.setProperty('transform', 'scale(0)', 'important');
                        bubble.style.setProperty('opacity', '0', 'important');
                    }

                    // Scroll to chat box
                    if (chatBox) {
                        chatBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        showroom.scrollIntoView({ behavior: 'smooth' });
                    }
        
                    // Set value and send
                    setTimeout(() => {
                        if (!mainInput) {
                            redirectToBella(text);
                            return;
                        }
                        mainInput.value = text;
                        // Trigger input event to resize if needed (not needed here but good practice)
                        mainInput.focus();
                        sendMessage();
                        
                        // Fix for mobile sticky hover: Replace the element to clear state
                        if (ctaContainer) {
                            const newCta = ctaContainer.cloneNode(true);
                            // Clear input in the new element
                            const newInput = newCta.querySelector('#ai-cta-input');
                            if (newInput) newInput.value = '';
                            
                            // Reset styles in the new element (remove inline overrides so CSS takes over, but clean state)
                            const newBubble = newCta.querySelector('#ai-cta-bubble');
                            if (newBubble) {
                                newBubble.style.removeProperty('transform');
                                newBubble.style.removeProperty('opacity');
                            }
                            
                            ctaContainer.parentNode.replaceChild(newCta, ctaContainer);
                        }
                    }, 800);
                }
            }

            function consumeBellaQueryFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('bella_query');
                if (!query) return;
                const input = document.getElementById('chat-input');
                if (!input) return;
                input.value = query;
                input.focus();
                sendMessage();
                const url = new URL(window.location.href);
                url.searchParams.delete('bella_query');
                window.history.replaceState({}, document.title, url.pathname + url.hash);
            }

            window.addEventListener('load', () => {
                setTimeout(consumeBellaQueryFromUrl, 400);
            });
        </script>

        <!-- Floating WhatsApp CTA -->
        <a id="floating-whatsapp-cta" href="https://wa.me/5592993531943" onclick="trackWhatsAppClick('floating_cta')" class="fixed bottom-8 right-8 bg-green-500 text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform z-50 flex items-center gap-2 group">
            <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-500 whitespace-nowrap font-bold">
                Agendamento/Dúvidas
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.588-5.946 0-6.556 5.332-11.891 11.891-11.891 3.181 0 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.481 8.403 0 6.556-5.332 11.892-11.891 11.892-1.999 0-3.956-.503-5.692-1.448l-6.301 1.666zm6.29-4.143c1.589.943 3.197 1.441 4.934 1.441 5.485 0 9.95-4.465 9.95-9.95 0-2.652-1.036-5.147-2.919-7.031-1.883-1.883-4.384-2.917-7.031-2.917-5.485 0-9.951 4.465-9.951 9.95 0 2.07.635 4.089 1.835 5.823l-1.101 4.022 4.133-1.092zm10.293-7.234c-.298-.15-1.764-.871-2.037-.972-.273-.102-.472-.152-.671.152-.199.303-.771 1.018-.944 1.219-.174.202-.348.227-.646.077-.298-.15-1.258-.464-2.396-1.48-.885-.789-1.483-1.763-1.656-2.064-.174-.302-.018-.465.132-.614.135-.133.298-.348.447-.521.149-.174.199-.298.298-.497.099-.198.05-.373-.025-.522-.075-.15-.671-1.616-.919-2.213-.242-.581-.486-.502-.671-.512-.174-.01-.373-.013-.572-.013-.199 0-.523.075-.795.373-.273.302-1.045 1.018-1.045 2.486s1.07 2.885 1.219 3.085c.149.202 2.105 3.214 5.099 4.507.712.308 1.268.491 1.701.628.715.227 1.365.195 1.879.118.573-.086 1.764-.72 2.013-1.417.248-.696.248-1.292.174-1.417-.074-.125-.272-.201-.57-.352z"/>
            </svg>
        </a>
    </footer>

    <!-- Catalog Modal -->
    <div id="catalog-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-stone-900/90 transition-opacity backdrop-blur-sm" onclick="closeCatalogModal()"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-sm bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-5xl animate-fadeIn">
                    
                    <div class="absolute top-0 right-0 pt-4 pr-4 z-20">
                        <button type="button" class="rounded-full bg-white/20 p-2 text-stone-500 hover:text-stone-800 focus:outline-none transition-colors" onclick="closeCatalogModal()">
                            <span class="sr-only">Fechar</span>
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="flex flex-col md:flex-row h-full md:h-[80vh]">
                        <!-- Image Side -->
                <div class="md:w-1/2 bg-stone-100 relative h-[50vh] md:h-full group cursor-zoom-in" onclick="openFullImage(document.getElementById('catalog-modal-img').src)">
                    <img id="catalog-modal-img" src="" alt="Detalhe" class="absolute inset-0 w-full h-full object-contain transition-transform duration-500 hover:scale-105">
                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/20 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-12 h-12 drop-shadow-lg">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
                        </svg>
                    </div>
                </div>
                        
                        <!-- Content Side -->
                        <div class="md:w-1/2 p-8 md:p-12 flex flex-col overflow-y-auto bg-white">
                            <div class="flex-1">
                                <span class="text-london-gold font-bold tracking-widest text-xs uppercase mb-2 block">London Noivas Collection</span>
                                <h3 id="catalog-modal-title" class="text-3xl md:text-4xl font-serif text-stone-900 mb-2 leading-tight"></h3>
                        <p id="catalog-modal-occasions" class="text-stone-500 font-serif mb-2">Ocasiões: <span id="catalog-modal-occasions-value"></span></p>
                        <p id="catalog-modal-color" class="text-stone-500 font-serif mb-2 hidden"><span id="catalog-modal-color-value"></span></p>
                        <p id="catalog-modal-size" class="text-stone-500 font-serif mb-2 hidden">Tamanho: <span id="catalog-modal-size-value"></span></p>
                        <p id="catalog-modal-price" class="text-stone-500 font-serif mb-2 hidden">Valor do aluguel: <span id="catalog-modal-price-value"></span></p>
                        <p id="catalog-modal-obs" class="text-stone-500 font-serif mb-2 hidden">Observações: <span id="catalog-modal-obs-value"></span></p>
                                <p class="text-xs text-stone-400 mb-6 font-mono">ID: <span id="catalog-modal-id-value"></span></p>
                                
                                <div class="w-12 h-1 bg-stone-200 mb-8"></div>
                                
                                <div class="prose prose-stone max-w-none">
                                    <h4 class="font-serif text-lg text-stone-800 mb-2">Descrição da Peça</h4>
                                    <p id="catalog-modal-desc" class="text-stone-600 font-light leading-relaxed text-lg mb-8"></p>
                                </div>

                                <!-- Similar Items Section -->
                                <div id="catalog-modal-similar-section" class="hidden mb-8">
                                    <div class="w-12 h-1 bg-stone-200 mb-6"></div>
                                    <h4 class="font-serif text-lg text-stone-800 mb-4">Você também pode gostar</h4>
                                    <div id="catalog-modal-similar-grid" class="grid grid-cols-2 gap-4">
                                        <!-- Similar items injected here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-8 border-t border-stone-100">
                                <p class="text-stone-400 text-sm mb-4 text-center italic">Gostou deste modelo? Fale conosco agora.</p>
                                <a id="catalog-modal-whatsapp-link" href="#" target="_blank" class="block w-full bg-[#25D366] hover:bg-[#1ebc57] text-white py-4 px-6 rounded-sm transition-colors text-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 duration-200 flex items-center justify-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                    </svg>
                                    <span class="font-bold tracking-widest text-sm">SOLICITAR MAIS INFORMAÇÕES</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.catalogData = window.catalogData || {};

        function openCatalogModalById(itemId, source) {
            const data = window.catalogData && window.catalogData[itemId];
            if (data) {
                // Pass UUID as itemId, and customId as display param
                openCatalogModal(
                    data.imageUrl,
                    data.title,
                    data.description,
                    itemId,
                    data.price,
                    source,
                    data.customId,
                    data.occasions,
                    data.color,
                    data.size,
                    data.colorBase,
                    data.colorCommercial,
                    data.itemObs
                );
            } else {
                console.error('Dados do item não encontrados para ID:', itemId);
            }
        }

        function openCatalogModal(imageUrl, title, description, itemId, price, source, customDisplayId, occasions, color, size, colorBase, colorCommercial, itemObs) {
            const idToShow = customDisplayId || itemId;

            function normalizarMonetarioParaNumero(raw) {
                let s = (raw || '').toString().trim();
                if (!s) return null;

                s = s.replace(/\s+/g, '').replace(/^R\$\s*/i, '');
                s = s.replace(/[^\d.,]/g, '');
                if (!s) return null;

                if (s.includes(',')) {
                    const parts = s.split(',');
                    const intPart = parts.slice(0, -1).join(',').replace(/[.,]/g, '');
                    let decPart = (parts[parts.length - 1] || '').replace(/\D/g, '').slice(0, 2);
                    if (decPart.length === 1) decPart = `${decPart}0`;
                    if (decPart.length === 0) decPart = '00';
                    const n = Number(`${intPart || '0'}.${decPart}`);
                    return Number.isFinite(n) ? n : null;
                }

                if (s.includes('.')) {
                    const dotParts = s.split('.');
                    if (dotParts.length === 2 && dotParts[1] && dotParts[1].length <= 2) {
                        const intPart = (dotParts[0] || '').replace(/\D/g, '');
                        let decPart = (dotParts[1] || '').replace(/\D/g, '').slice(0, 2);
                        if (decPart.length === 1) decPart = `${decPart}0`;
                        if (decPart.length === 0) decPart = '00';
                        const n = Number(`${intPart || '0'}.${decPart}`);
                        return Number.isFinite(n) ? n : null;
                    }

                    const digits = s.replace(/\D/g, '');
                    if (!digits) return null;
                    const n = Number(`${digits}.00`);
                    return Number.isFinite(n) ? n : null;
                }

                const digits = s.replace(/\D/g, '');
                if (!digits) return null;
                const n = Number(`${digits}.00`);
                return Number.isFinite(n) ? n : null;
            }

            function formatarPrecoParaModal(rawPrice) {
                const s = (rawPrice || '').toString().trim();
                if (!s || s === '0' || s === '0.00' || s === '0,00') return 'Consulte';
                if (/consulte/i.test(s)) return 'Consulte';

                const cleaned = s.replace(/^Valor do aluguel:\s*/i, '').trim();
                const n = normalizarMonetarioParaNumero(cleaned);
                if (n === null) return cleaned;
                if (n === 0) return 'Consulte';
                return `R$ ${n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }

            document.getElementById('catalog-modal-img').src = imageUrl || 'https://via.placeholder.com/600x800?text=Sem+Imagem';
            document.getElementById('catalog-modal-title').textContent = title;
            document.getElementById('catalog-modal-desc').textContent = description;
            const priceRow = document.getElementById('catalog-modal-price');
            const priceValue = document.getElementById('catalog-modal-price-value');
            const priceText = formatarPrecoParaModal(price);
            if (priceValue) priceValue.textContent = (priceText || '').toString().trim();
            if (priceRow) {
                if (priceText) priceRow.classList.remove('hidden');
                else priceRow.classList.add('hidden');
            }
            document.getElementById('catalog-modal-id-value').textContent = idToShow;
            document.getElementById('catalog-modal-occasions-value').textContent = occasions || 'Várias';

            const colorRow = document.getElementById('catalog-modal-color');
            const colorValue = document.getElementById('catalog-modal-color-value');
            const baseText = (colorBase || '').toString().trim();
            const commercialText = (colorCommercial || '').toString().trim();
            const colorText = (baseText || commercialText)
                ? [baseText ? `Cor base: ${baseText}` : '', commercialText ? `Cor comercial: ${commercialText}` : ''].filter(Boolean).join(' / ')
                : (color || '').toString().trim();
            if (colorValue) colorValue.textContent = colorText;
            if (colorRow) {
                if (colorText) colorRow.classList.remove('hidden');
                else colorRow.classList.add('hidden');
            }

            const sizeRow = document.getElementById('catalog-modal-size');
            const sizeValue = document.getElementById('catalog-modal-size-value');
            const sizeText = (size || '').toString().trim();
            if (sizeValue) sizeValue.textContent = sizeText;
            if (sizeRow) {
                if (sizeText) sizeRow.classList.remove('hidden');
                else sizeRow.classList.add('hidden');
            }

            const obsRow = document.getElementById('catalog-modal-obs');
            const obsValue = document.getElementById('catalog-modal-obs-value');
            const obsText = (itemObs || '').toString().trim();
            if (obsValue) obsValue.textContent = obsText;
            if (obsRow) {
                if (obsText) obsRow.classList.remove('hidden');
                else obsRow.classList.add('hidden');
            }
            
            const phoneNumber = "5592993531943";
            
            // Construct message with Title and ID
            let text = `Olá, gostaria de mais informações sobre o vestido: ${title}`;
            text += `\nCód: ${idToShow}`;
            
            // Check if it's an AI item (starts with ai_) or regular item
            const isAiItem = itemId && itemId.toString().startsWith('ai_');

            if (!isAiItem) {
                const url = new URL('/catalogo', window.location.origin);
                url.searchParams.set('item', itemId);
                window.history.pushState({}, '', url);
                text += `\nLink: ${url.toString()}`;
            }

            const encodedText = encodeURIComponent(text);
            const whatsappLink = document.getElementById('catalog-modal-whatsapp-link');
            whatsappLink.href = `https://wa.me/${phoneNumber}?text=${encodedText}`;
            
            // Dynamic tracking based on source (AI, Featured, or Catalog)
            if (source === 'featured') {
                whatsappLink.onclick = function() { trackWhatsAppClick('featured_modal_whatsapp'); };
            } else if (isAiItem) {
                whatsappLink.onclick = function() { trackWhatsAppClick('ai_modal_whatsapp'); };
            } else {
                whatsappLink.onclick = function() { trackWhatsAppClick('catalog_modal_whatsapp'); };
            }
            
            document.getElementById('catalog-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling

            // Reset and fetch similar items
            const similarSection = document.getElementById('catalog-modal-similar-section');
            const similarGrid = document.getElementById('catalog-modal-similar-grid');
            similarSection.classList.add('hidden');
            similarGrid.innerHTML = '';

            if (itemId && !isAiItem) {
                // Increment visit count for all sources
                fetch(`/api/item/${itemId}/visit`, { method: 'POST' })
                    .catch(err => console.error('Error incrementing visit count:', err));

                const isBellaAiModal = source === 'ai_result' || source === 'ai_suggestion';

                let apiUrl = '';
                if (isBellaAiModal) {
                    const similarParams = new URLSearchParams();
                    similarParams.set('limit', '4');
                    similarParams.set('no_faiss', '1');
                    if (Array.isArray(bellaOccasionFilter) && bellaOccasionFilter.length) similarParams.set('occasions', bellaOccasionFilter.join(','));
                    else if (occasions) similarParams.set('occasions', occasions);
                    if (colorBase) similarParams.set('cor_base', colorBase);
                    if (colorCommercial) similarParams.set('cor_comercial', colorCommercial);
                    apiUrl = `/api/ai-similar/${itemId}?${similarParams.toString()}`;
                } else {
                    const bellaOccParam = Array.isArray(bellaOccasionFilter) && bellaOccasionFilter.length
                        ? bellaOccasionFilter.join(',')
                        : '';
                    const bellaOccQuery = bellaOccParam ? `&occasion=${encodeURIComponent(bellaOccParam)}` : '';
                    const bellaQueryParam = bellaQueryFilter ? `&q=${encodeURIComponent(bellaQueryFilter)}` : '';
                    apiUrl = `/api/ai-similar/${itemId}?limit=4${bellaOccQuery}${bellaQueryParam}`;
                }

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        const normalizeSlug = (s) => (s || '')
                            .toString()
                            .normalize('NFD')
                            .replace(/[\u0300-\u036f]/g, '')
                            .toLowerCase()
                            .replace(/[^a-z0-9]+/g, '_')
                            .replace(/^_+|_+$/g, '')
                            .replace(/_+/g, '_');

                        const normalizeText = (s) => (s || '')
                            .toString()
                            .normalize('NFD')
                            .replace(/[\u0300-\u036f]/g, '')
                            .toLowerCase()
                            .replace(/[^a-z0-9]+/g, ' ')
                            .trim()
                            .replace(/\s+/g, ' ');

                        const parseOccasionsToSlugs = (occasionsStr) => {
                            if (!occasionsStr) return [];
                            return occasionsStr
                                .toString()
                                .split(',')
                                .map(s => normalizeSlug(s.trim()))
                                .filter(Boolean);
                        };

                        const targetOccasionInput = (Array.isArray(bellaOccasionFilter) && bellaOccasionFilter.length)
                            ? bellaOccasionFilter.join(', ')
                            : occasions;
                        const targetOccasions = new Set(parseOccasionsToSlugs(targetOccasionInput));
                        const apiSuggestions = Array.isArray(data.suggestions) ? data.suggestions : [];
                        let suggestions = targetOccasions.size > 0
                            ? apiSuggestions.filter(s => parseOccasionsToSlugs(s.occasions).some(o => targetOccasions.has(o)))
                            : apiSuggestions;

                        const targetBase = normalizeText(colorBase || '');
                        const targetCommercial = normalizeText(colorCommercial || '');
                        const existingIds = new Set(suggestions.map(s => String(s.id)));

                        if (isBellaAiModal && suggestions.length < 4 && window.catalogData && typeof window.catalogData === 'object') {
                            let localCandidates = Object.entries(window.catalogData)
                                .filter(([id, d]) => id && d && String(id) !== String(itemId))
                                .filter(([id, d]) => !existingIds.has(String(id)))
                                .filter(([id, d]) => targetOccasions.size === 0 || parseOccasionsToSlugs(d.occasions).some(o => targetOccasions.has(o)))
                                .map(([id, d]) => ({
                                    id,
                                    customId: d.customId,
                                    title: d.title,
                                    image_url: d.imageUrl,
                                    description: d.description,
                                    price: d.price,
                                    itemObs: d.itemObs,
                                    color: d.color,
                                    colorBase: d.colorBase,
                                    colorCommercial: d.colorCommercial,
                                    size: d.size,
                                    occasions: d.occasions
                                }));

                            localCandidates = localCandidates.sort((a, b) => {
                                const aCommercial = normalizeText(a.colorCommercial || '');
                                const bCommercial = normalizeText(b.colorCommercial || '');
                                const aBase = normalizeText(a.colorBase || '');
                                const bBase = normalizeText(b.colorBase || '');
                                const aCommercialOk = Boolean(targetCommercial && aCommercial && aCommercial === targetCommercial);
                                const bCommercialOk = Boolean(targetCommercial && bCommercial && bCommercial === targetCommercial);
                                if (aCommercialOk !== bCommercialOk) return aCommercialOk ? -1 : 1;
                                const aBaseOk = Boolean(targetBase && aBase && aBase === targetBase);
                                const bBaseOk = Boolean(targetBase && bBase && bBase === targetBase);
                                if (aBaseOk !== bBaseOk) return aBaseOk ? -1 : 1;
                                return 0;
                            });

                            for (const c of localCandidates) {
                                if (suggestions.length >= 4) break;
                                suggestions.push(c);
                                existingIds.add(String(c.id));
                            }
                        }

                        if (suggestions.length > 0) {
                            suggestions.forEach(item => {
                                const div = document.createElement('div');
                                div.className = 'cursor-pointer group';
                                const itemOccasions = typeof item.occasions === 'string'
                                    ? item.occasions
                                    : Array.isArray(item.occasions)
                                        ? item.occasions.join(', ')
                                        : '';
                                const fallback = window.catalogData && window.catalogData[item.id];
                                const suggestionPrice = item.price || (fallback && fallback.price) || 'Valor do aluguel: Consulte';
                                const suggestionObs = item.item_obs || item.itemObs || (fallback && fallback.itemObs) || '';
                                div.onclick = () => openCatalogModal(
                                    item.image_url,
                                    item.title,
                                    item.description,
                                    item.id,
                                    suggestionPrice,
                                    'similar',
                                    item.customId,
                                    itemOccasions,
                                    item.color,
                                    item.size,
                                    item.color_base || item.cor_base || item.colorBase || item.corBase,
                                    item.color_comercial || item.cor_comercial || item.colorCommercial || item.corCommercial,
                                    suggestionObs
                                );
                                div.innerHTML = `
                                    <div class="aspect-[3/4] bg-stone-100 overflow-hidden mb-2 rounded-sm relative">
                                        <img src="${item.image_url}" class="w-full h-full object-contain transition-transform duration-500 group-hover:scale-110" alt="${item.title}">
                                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300"></div>
                                    </div>
                                    <p class="text-xs font-bold text-stone-800 uppercase tracking-wide truncate">${item.title}</p>
                                `;
                                similarGrid.appendChild(div);
                            });
                            similarSection.classList.remove('hidden');
                        }
                    })
                    .catch(err => console.error('Erro ao buscar similares:', err));
            }
        }

        function closeCatalogModal() {
            document.getElementById('catalog-modal').classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
            
            // Remove item param from URL
            const url = new URL(window.location);
            url.searchParams.delete('item');
            window.history.pushState({}, '', url);
        }

        // Check URL for item param on load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item');
            if (itemId && window.catalogData && window.catalogData[itemId]) {
                const item = window.catalogData[itemId];
                openCatalogModal(
                    item.imageUrl,
                    item.title,
                    item.description,
                    itemId,
                    item.price,
                    'url_load',
                    item.customId,
                    item.occasions,
                    item.color,
                    item.size,
                    item.colorBase,
                    item.colorCommercial,
                    item.itemObs
                );
            }
        });
    </script>
    <!-- Analytics Tracking Scripts -->
    <script>
        // Google Analytics 4 Event Tracking
        const GA_MEASUREMENT_ID = 'G-23RSZ1SMRX';

        function trackEvent(eventName, params) {
            console.log('Event Tracked:', eventName, params);
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, params);
            }
        }

        let mapInfoModalState = { open: false, url: '', source: '', category: 'contact' };

        function openMapInfoModal(event, mapUrl, source, clickEventName, eventCategory) {
            if (event) event.preventDefault();
            const category = eventCategory || 'contact';
            trackEvent(clickEventName || 'click_map_footer', {
                'event_category': category,
                'event_label': source || 'footer_map',
                'transport_type': 'beacon'
            });
            const modal = document.getElementById('map-info-modal');
            const openBtn = document.getElementById('map-modal-open');
            if (!modal || !openBtn) {
                window.open(mapUrl, '_blank', 'noopener,noreferrer');
                return;
            }
            mapInfoModalState = { open: true, url: mapUrl || '', source: source || '', category };
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            openBtn.setAttribute('href', mapUrl || '#');
            trackEvent('map_modal_open', {
                'event_category': category,
                'event_label': source || 'footer_map',
                'transport_type': 'beacon'
            });
        }

        function closeMapInfoModal(reason) {
            const modal = document.getElementById('map-info-modal');
            if (!modal) return;
            const category = (mapInfoModalState && mapInfoModalState.category) ? mapInfoModalState.category : 'contact';
            modal.classList.add('hidden');
            mapInfoModalState = { open: false, url: '', source: '', category: 'contact' };
            document.body.style.overflow = '';
            trackEvent('map_modal_close', {
                'event_category': category,
                'event_label': reason || 'close',
                'transport_type': 'beacon'
            });
        }

        function confirmOpenMapFromModal() {
            const url = mapInfoModalState && mapInfoModalState.url ? mapInfoModalState.url : '';
            trackEvent('map_modal_view_map', {
                'event_category': (mapInfoModalState && mapInfoModalState.category) ? mapInfoModalState.category : 'contact',
                'event_label': (mapInfoModalState && mapInfoModalState.source) ? mapInfoModalState.source : 'view_map',
                'transport_type': 'beacon'
            });
            closeMapInfoModal('view_map');
            if (url) {
                setTimeout(() => window.open(url, '_blank', 'noopener,noreferrer'), 60);
            }
        }

        function trackWhatsAppClick(location) {
            trackEvent('whatsapp_click', {
                'event_category': 'contact',
                'event_label': location,
                'transport_type': 'beacon'
            });
        }

        window.addEventListener('load', () => {
            const floatingCta = document.getElementById('floating-whatsapp-cta');
            if (!floatingCta) return;
            const phoneNumber = '5592993531943';
            const text = 'Olá, visitei o site da London Noivas e tenho uma dúvida:\n\n';
            floatingCta.href = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(text)}`;
        });

        function revealPhone(elementId) {
            const phoneSpan = document.getElementById(elementId);
            if (phoneSpan) {
                phoneSpan.innerText = '(92) 99353-1943';
                phoneSpan.classList.remove('cursor-pointer', 'underline', 'decoration-dotted', 'text-london-gold');
                phoneSpan.classList.add('text-stone-800');
                phoneSpan.onclick = null; // Remove click handler
                
                trackEvent('phone_reveal', {
                    'event_category': 'contact',
                    'event_label': 'footer_phone'
                });
            }
        }

        // Mobile Menu Logic
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        function openMobileMenu() {
            if (mobileMenu) mobileMenu.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        function closeMobileMenu() {
            if (mobileMenu) mobileMenu.classList.add('translate-x-full');
            document.body.style.overflow = ''; // Restore scrolling
        }

        if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', openMobileMenu);
        if(closeMenuBtn) closeMenuBtn.addEventListener('click', closeMobileMenu);

        document.addEventListener('keydown', function(e) {
            if (e && e.key === 'Escape') {
                const modal = document.getElementById('map-info-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    closeMapInfoModal('esc');
                }
            }
        });
    </script>
    <div id="map-info-modal" class="fixed inset-0 z-[205] hidden" role="dialog" aria-modal="true" aria-labelledby="map-modal-title">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeMapInfoModal('backdrop')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-sm shadow-2xl border border-stone-200">
                <div class="flex items-start justify-between gap-4 p-5 border-b border-stone-100">
                    <div>
                        <h3 id="map-modal-title" class="font-serif text-stone-900 text-xl">Atenção</h3>
                        <p class="text-stone-500 text-sm mt-1">O Google Street View esta desatualizado e mostra apenas a construçao da nossa loja, que foi concluida no final de 2025</p>
                    </div>
                    <button type="button" onclick="closeMapInfoModal('x')" class="text-stone-500 hover:text-stone-800 transition-colors p-1" aria-label="Fechar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-5 flex flex-col sm:flex-row gap-3 sm:justify-end">
                    <button type="button" onclick="closeMapInfoModal('close_button')" class="w-full sm:w-auto px-5 py-3 border border-stone-200 text-stone-700 hover:bg-stone-50 transition-colors rounded-sm font-bold tracking-widest text-xs uppercase">
                        Fechar
                    </button>
                    <a id="map-modal-open" href="#" target="_blank" rel="noopener noreferrer" onclick="event.preventDefault(); confirmOpenMapFromModal();" class="w-full sm:w-auto px-5 py-3 bg-stone-900 text-white hover:bg-london-gold transition-colors rounded-sm font-bold tracking-widest text-xs uppercase text-center">
                        Ver mapa
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Full Screen Image Modal -->
    <div id="full-image-modal" class="fixed inset-0 z-[200] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="closeFullImage()"></div>
        
        <button onclick="closeFullImage()" class="absolute top-4 right-4 z-[210] text-white/70 hover:text-white transition-colors p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <img id="full-image-img" src="" alt="Full Screen" class="max-w-full max-h-full object-contain shadow-2xl pointer-events-auto rounded-sm">
        </div>
    </div>

    <script>
        function openFullImage(src) {
            if (!src || src.includes('placeholder')) return;
            const modal = document.getElementById('full-image-modal');
            const img = document.getElementById('full-image-img');
            img.src = src;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        function closeFullImage() {
            const modal = document.getElementById('full-image-modal');
            modal.classList.add('hidden');
            // Only restore scrolling if catalog modal is not open, but since catalog modal also locks scrolling, 
            // we should check if catalog modal is open.
            // However, simplistically, if catalog modal is open, it handles its own overflow.
            // But we can just set it back to hidden, which usually defaults to 'auto' on body remove,
            // but here we are stacking modals.
            
            // If catalog modal is open, keep body overflow hidden.
            const catalogModal = document.getElementById('catalog-modal');
            if (catalogModal && !catalogModal.classList.contains('hidden')) {
                // Keep hidden
            } else {
                document.body.style.overflow = '';
            }
        }

        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const fullModal = document.getElementById('full-image-modal');
                if (!fullModal.classList.contains('hidden')) {
                    closeFullImage();
                }
            }
        });
    </script>
    <!-- Full Screen Image Modal -->
    <div id="full-image-modal" class="fixed inset-0 z-[200] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="closeFullImage()"></div>
        
        <button onclick="closeFullImage()" class="absolute top-4 right-4 z-[210] text-white/70 hover:text-white transition-colors p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <img id="full-image-img" src="" alt="Full Screen" class="max-w-full max-h-full object-contain shadow-2xl pointer-events-auto rounded-sm">
        </div>
    </div>

    <script>
        function openFullImage(src) {
            if (!src || src.includes('placeholder')) return;
            const modal = document.getElementById('full-image-modal');
            const img = document.getElementById('full-image-img');
            img.src = src;
            modal.classList.remove('hidden');
            // Keep body overflow hidden (already set by catalog modal)
        }

        function closeFullImage() {
            const modal = document.getElementById('full-image-modal');
            modal.classList.add('hidden');
        }

        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const fullModal = document.getElementById('full-image-modal');
                if (!fullModal.classList.contains('hidden')) {
                    closeFullImage();
                    event.stopPropagation(); // Prevent closing the underlying catalog modal
                }
            }
        });
    </script>
</body>
</html>
