{% extends "base.html" %} {% block title %}Editar Cliente{% endblock %} {% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_edit_client.css') }}" />
{% endblock %} {% block content %}

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Editar Cliente</h1>
    <a href="{{ request.args.get('next', url_for('listar_clientes')) }}" class="cancel-link">Cancelar</a>
  </div>

{{all_fields}}
{{cliente}}
  <form method="POST" id="editClientForm">
    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for field in all_fields if field.visible %}
      <div class="col d-flex">
        <div class="bg-light shadow-sm rounded p-3 border w-100 h-100 d-flex flex-column justify-content-center">
          <label for="{{ field.id }}" class="form-label fw-semibold">
            {{ field.label if field.fixed else field.title }}{% if field.required %} *{% endif %}
          </label>

          {% set value = cliente.get(field.id, '') %}

          {% if field.type in ['string', 'value', 'cpf', 'cnpj', 'email', 'phone'] %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ value }}" {% if field.required %}required{% endif %} />
              {{ field.id }}

              {% elif field.type == "client_name" %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ value }}" {% if field.required %}required{% endif %} />



          {% elif field.type == 'number' %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ value }}" {% if field.required %}required{% endif %} />

          {% elif field.type == 'date' %}
            <input type="date" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ value }}" {% if field.required %}required{% endif %} />

          {% elif field.type == 'dropdown' %}
            <select class="form-select" id="{{ field.id }}" name="{{ field.id }}" {% if field.required %}required{% endif %}>
              <option value="">Selecione</option>
              {% for option in field.options %}
                <option value="{{ option }}" {% if value == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="d-flex justify-content-center mt-4">
      <button type="submit" class="btn btn-success btn-submit">Salvar</button>
    </div>
  </form>
</div>

{% endblock %}{% block scripts %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const cpfInput = document.getElementById('client_cpf');
    const cnpjInput = document.getElementById('client_cnpj');
    const telInput = document.getElementById('client_phone');
    const form = document.getElementById('editClientForm') || document.getElementById('clientForm');

    function maskCPF(value) {
      return value
        .replace(/\D/g, '')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    function maskCNPJ(value) {
      return value
        .replace(/\D/g, '')
        .replace(/^(\d{2})(\d)/, '$1.$2')
        .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
        .replace(/\.(\d{3})(\d)/, '.$1/$2')
        .replace(/(\d{4})(\d)/, '$1-$2');
    }

    function maskPhone(value) {
      value = value.replace(/\D/g, '').slice(0, 11);
      let formatted = '';
      if (value.length > 0) formatted += '(' + value.substring(0, 2);
      if (value.length >= 3) formatted += ') ' + value.substring(2, 7);
      if (value.length >= 8) formatted += '-' + value.substring(7);
      return formatted;
    }

    function unmask(value) {
      return value.replace(/\D/g, '');
    }

    function isValidCPF(cpf) {
      cpf = unmask(cpf);
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0, resto;
      for (let i = 1; i <= 9; i++) soma += parseInt(cpf[i - 1]) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf[9])) return false;
      soma = 0;
      for (let i = 1; i <= 10; i++) soma += parseInt(cpf[i - 1]) * (12 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(cpf[10]);
    }

    function isValidCNPJ(cnpj) {
      cnpj = unmask(cnpj);
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
      let tamanho = cnpj.length - 2;
      let numeros = cnpj.substring(0, tamanho);
      let digitos = cnpj.substring(tamanho);
      let soma = 0, pos = tamanho - 7;

      for (let i = tamanho; i >= 1; i--) {
        soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
        if (pos < 2) pos = 9;
      }
      let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
      if (resultado != parseInt(digitos.charAt(0))) return false;

      tamanho += 1;
      numeros = cnpj.substring(0, tamanho);
      soma = 0;
      pos = tamanho - 7;
      for (let i = tamanho; i >= 1; i--) {
        soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
        if (pos < 2) pos = 9;
      }
      resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
      return resultado == parseInt(digitos.charAt(1));
    }

    // 🟡 Aplica máscara inicial se valor já estiver preenchido
    if (cpfInput && cpfInput.value) cpfInput.value = maskCPF(cpfInput.value);
    if (cnpjInput && cnpjInput.value) cnpjInput.value = maskCNPJ(cnpjInput.value);
    if (telInput && telInput.value) telInput.value = maskPhone(telInput.value);

    // 🟡 Eventos de digitação
    if (cpfInput) {
      cpfInput.addEventListener('input', e => {
        e.target.value = maskCPF(e.target.value);
      });
    }

    if (cnpjInput) {
      cnpjInput.addEventListener('input', e => {
        e.target.value = maskCNPJ(e.target.value);
      });
    }

    if (telInput) {
      telInput.addEventListener('input', e => {
        e.target.value = maskPhone(e.target.value);
      });
    }

    // 🔒 Validação ao submeter
    if (form) {
      form.addEventListener('submit', function (e) {
        const cpf = cpfInput?.value || '';
        const cnpj = cnpjInput?.value || '';
        const tel = telInput?.value || '';

        if (cpf && !isValidCPF(cpf)) {
          e.preventDefault();
          alert('CPF inválido!');
          return false;
        }

        if (cnpj && !isValidCNPJ(cnpj)) {
          e.preventDefault();
          alert('CNPJ inválido!');
          return false;
        }

        if (tel && unmask(tel).length !== 11) {
          e.preventDefault();
          alert('Telefone inválido! Deve conter 11 dígitos.');
          return false;
        }
      });
    }
  });
  </script>


{% endblock %}
