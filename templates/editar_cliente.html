<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Cliente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_edit_client.css') }}" />
  </head>
  <body>
    <!-- Mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
        {{ message|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <div class="form-container">
      <h1>Editar Cliente</h1>
      <a href="{{ request.args.get('next', url_for('listar_clientes')) }}" class="cancel-link">Cancelar</a>

      <form method="POST" id="editClientForm">
        <label for="client_name">Nome:</label>
        <input type="text" id="client_name" name="client_name" value="{{ cliente.client_name }}" required class="form-control" />

        <label for="client_tel">Telefone:</label>
        <input
          type="tel"
          id="client_tel"
          name="client_tel"
          class="form-control"
          placeholder="(xx) xxxxx-xxxx"
          value="{{ cliente.client_tel|default('', true) }}"
          data-only-digits="true"
        />

        <label for="client_email">E-mail:</label>
        <input
          type="email"
          id="client_email"
          name="client_email"
          class="form-control"
          placeholder="exemplo@email.com"
          value="{{ cliente.client_email|default('', true) }}"
        />

        <label for="client_address">Endereço:</label>
        <input type="text" id="client_address" name="client_address" value="{{ cliente.client_address|default('', true) }}" class="form-control" />

        <label for="client_cpf">CPF:</label>
        <input
          type="text"
          id="client_cpf"
          name="client_cpf"
          maxlength="14"
          placeholder="000.000.000-00"
          value="{{ cliente.client_cpf|default('', true) }}"
          class="form-control"
          data-only-digits="true"
          data-mask="cpf"
        />

        <label for="client_cnpj">CNPJ:</label>
        <input
          type="text"
          id="client_cnpj"
          name="client_cnpj"
          maxlength="18"
          placeholder="00.000.000/0000-00"
          value="{{ cliente.client_cnpj|default('', true) }}"
          class="form-control"
          data-only-digits="true"
          data-mask="cnpj"
        />

        <!-- Campos ocultos para valores sem formatação -->
        <input type="hidden" id="client_tel_digits" name="client_tel_digits" />
        <input type="hidden" id="client_cpf_digits" name="client_cpf_digits" />
        <input type="hidden" id="client_cnpj_digits" name="client_cnpj_digits" />

        <button type="submit">Salvar</button>
      </form>
    </div>

    <script>
      // Função para aplicar máscara ao CPF
      function maskCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
        cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
        cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        return cpf;
      }

      // Função para aplicar máscara ao CNPJ
      function maskCNPJ(cnpj) {
        cnpj = cnpj.replace(/\D/g, '');
        cnpj = cnpj.replace(/^(\d{2})(\d)/, '$1.$2');
        cnpj = cnpj.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        cnpj = cnpj.replace(/\.(\d{3})(\d)/, '.$1/$2');
        cnpj = cnpj.replace(/(\d{4})(\d)/, '$1-$2');
        return cnpj;
      }

      // Aplicando máscaras nos campos
      document.getElementById('client_cpf').addEventListener('input', function (e) {
        let value = e.target.value;
        e.target.value = maskCPF(value);
      });

      document.getElementById('client_cnpj').addEventListener('input', function (e) {
        let value = e.target.value;
        e.target.value = maskCNPJ(value);
      });

      // Validação de CPF e CNPJ ao submeter o formulário
      document.getElementById('clientForm').addEventListener('submit', function (e) {
        // Obter valores com formatação
        const telFormatted = document.getElementById('client_tel').value;
        const cpfFormatted = document.getElementById('client_cpf').value;
        const cnpjFormatted = document.getElementById('client_cnpj').value;

        // Remover formatação e manter apenas dígitos
        const telDigits = telFormatted.replace(/\D/g, '');
        const cpfDigits = cpfFormatted.replace(/\D/g, '');
        const cnpjDigits = cnpjFormatted.replace(/\D/g, '');

        // Preencher campos ocultos com apenas dígitos
        document.getElementById('client_tel_digits').value = telDigits;
        document.getElementById('client_cpf_digits').value = cpfDigits;
        document.getElementById('client_cnpj_digits').value = cnpjDigits;

        // Validar CPF
        if (cpfDigits && !validaCPF(cpfDigits)) {
          e.preventDefault();
          alert('CPF inválido!');
          return;
        }

        // Validar CNPJ
        if (cnpjDigits && !validaCNPJ(cnpjDigits)) {
          e.preventDefault();
          alert('CNPJ inválido!');
          return;
        }
      });

      function validaCPF(cpf) {
        if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
        let soma = 0,
          resto;
        for (let i = 1; i <= 9; i++) soma += parseInt(cpf[i - 1]) * (11 - i);
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf[9])) return false;
        soma = 0;
        for (let i = 1; i <= 10; i++) soma += parseInt(cpf[i - 1]) * (12 - i);
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        return resto === parseInt(cpf[10]);
      }

      function validaCNPJ(cnpj) {
        if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
        let tamanho = cnpj.length - 2;
        let numeros = cnpj.substring(0, tamanho);
        let digitos = cnpj.substring(tamanho);
        let soma = 0;
        let pos = tamanho - 7;

        for (let i = tamanho; i >= 1; i--) {
          soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
          if (pos < 2) pos = 9;
        }

        let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
        if (resultado != parseInt(digitos.charAt(0))) return false;

        tamanho += 1;
        numeros = cnpj.substring(0, tamanho);
        soma = 0;
        pos = tamanho - 7;
        for (let i = tamanho; i >= 1; i--) {
          soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
          if (pos < 2) pos = 9;
        }

        resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
        return resultado == parseInt(digitos.charAt(1));
      }
    </script>

    <script>
      const telInput = document.getElementById('client_tel');

      telInput.addEventListener('input', function (e) {
        let input = e.target.value.replace(/\D/g, ''); // Remove tudo que não for número

        if (input.length > 11) {
          input = input.slice(0, 11); // Limita a 11 dígitos
        }

        let formatted = '';

        if (input.length > 0) {
          formatted += '(' + input.substring(0, 2);
        }
        if (input.length >= 3) {
          formatted += ') ' + input.substring(2, 7);
        }
        if (input.length >= 8) {
          formatted += '-' + input.substring(7);
        }

        e.target.value = formatted;
      });
    </script>

    <script>
      // Reutiliza as funções de máscara que você já tem:
      function maskPhone(value) {
        let input = value.replace(/\D/g, '');

        if (input.length > 11) input = input.slice(0, 11);

        let formatted = '';
        if (input.length > 0) formatted += '(' + input.substring(0, 2);
        if (input.length >= 3) formatted += ') ' + input.substring(2, 7);
        if (input.length >= 8) formatted += '-' + input.substring(7);

        return formatted;
      }

      // Aplica as máscaras aos valores já preenchidos ao carregar a página
      window.addEventListener('DOMContentLoaded', () => {
        const telInput = document.getElementById('client_tel');
        const cpfInput = document.getElementById('client_cpf');
        const cnpjInput = document.getElementById('client_cnpj');

        if (telInput && telInput.value) {
          telInput.value = maskPhone(telInput.value);
        }

        if (cpfInput && cpfInput.value) {
          cpfInput.value = maskCPF(cpfInput.value);
        }

        if (cnpjInput && cnpjInput.value) {
          cnpjInput.value = maskCNPJ(cnpjInput.value);
        }
      });
    </script>
  </body>
</html>
