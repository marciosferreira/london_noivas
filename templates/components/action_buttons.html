<!-- Action Buttons Component -->
<div class="dropdown dropend">
  <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">A√ß√µes</button>
  <ul class="dropdown-menu dropdown-menu-end">
    {% if show_rent %}
    <li>
      <a
        class="dropdown-item text-success"
        href="{{ url_for('rent', item_id=item.item_id, rent='true') }}"
        onclick="return checkTransactionLimit(event);"
      >
        Reservar/Retirar
      </a>
    </li>
    {% endif %} {% if show_mark_returned %}
    <li>
      <a
        class="dropdown-item text-success"
        href="{{ url_for('mark_returned', transaction_id=item.transaction_id, next=request.url) }}"
        onclick="return confirm('Tem certeza de que deseja marcar este item como devolvido?');"
      >
        Marcar como devolvido
      </a>
    </li>
    {% endif %} {% if show_mark_rented %}

    <!-- Bot√£o rented com opc√≥es-->
    <a
      href="#"
      class="dropdown-item text-success"
      title="Retirar"
      onclick="confirmarAcao('{{ url_for('mark_rented', transaction_id=item.transaction_id, next=request.url) }}'); return false;"
    >
      Marcar como retirado
    </a>

    {% endif %} {% if show_edit_item %}
    <li><a class="dropdown-item" href="{{ url_for('edit_item', item_id=item.item_id, next=request.url) }}">Editar item</a></li>
    {% endif %} {% if show_edit_transaction %}
    <li>
      <a class="dropdown-item" href="{{ url_for('edit_transaction', transaction_id=item.transaction_id, next=request.url) }}">Editar transa√ß√£o</a>
    </li>
    {% endif %} {% if show_edit_client %}
    <li>
      <a
        class="dropdown-item"
        href="{{ url_for('editar_cliente', client_id=(cliente.client_id if cliente is defined else item.client_id), next=request.url) }}"
      >
        Editar cliente
      </a>
    </li>
    {% endif %} {% if show_view_transactions %}
    <li><a class="dropdown-item" href="{{ url_for('client_transactions', client_id=cliente.client_id) }}">Transa√ß√µes do cliente</a></li>
    {% endif %} {% if show_consult or show_ver_reservas %}
    <li><a class="dropdown-item" href="{{ url_for('view_calendar', item_id=item.item_id, next=request.url) }}">Ver reservas do item</a></li>
    {% endif %} {% if show_archive %}
    <li>
      <a
        class="dropdown-item"
        href="{{ url_for('mark_archived', item_id=item.item_id, next=request.url) }}"
        onclick="return confirm('Tem certeza de que deseja arquivar este item?');"
      >
        Arquivar item
      </a>
    </li>
    {% endif %} {% if show_restore %}
    <li>
      <a
        class="dropdown-item text-success"
        href="{{ url_for('restore_item', item_id=item.item_id, next=request.url) }}"
        onclick="return confirm('Tem certeza de que deseja restaurar este item?');"
      >
        Restaurar
      </a>
    </li>
    {% endif %} {% if show_mark_available %}

    <!-- Bot√£o Dispon√≠vel -->
    <a
      href="{{ url_for('mark_available', item_id=item.item_id, next=request.url) }}"
      class="dropdown-item"
      title="Tornar dispon√≠vel"
      onclick="return confirm('Tem certeza que deseja tornar este item dispon√≠vel novamente?');"
    >
      Diponibilizar item
    </a>
    {% endif %} {% if show_delete_item or show_delete_transaction %} {% endif %} {% if show_delete_item %}
    <li>
      <form method="POST" action="{{ url_for('delete', item_id=item.item_id, next=request.url) }}" style="display: inline">
        <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Tem certeza de que deseja deletar este item?');">
          Deletar item
        </button>
      </form>
    </li>
    {% endif %} {% if show_delete_client %}
    <li>
      <form
        method="POST"
        action="{{ url_for('deletar_cliente', client_id=cliente.client_id) }}"
        onsubmit="return confirm('Tem certeza que deseja deletar este cliente? Esta a√ß√£o n√£o poder√° ser desfeita.');"
        style="display: inline"
      >
        <button type="submit" class="dropdown-item text-danger" title="Deletar">
          <i class="fas fa-trash"></i>
          Deletar cliente
        </button>
      </form>
    </li>
    {% endif %} {% if show_delete_transaction %}
    <li>
      <a
        class="dropdown-item text-danger"
        href="{{ url_for('delete_transaction', transaction_id=item.transaction_id, next=request.url) }}"
        onclick="return confirm('Tem certeza de que deseja deletar esta transa√ß√£o?');"
      >
        Deletar transa√ß√£o
      </a>
    </li>
    {% endif %} {% if show_print %}
    <li>
      <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modalModelo" onclick="abrirModalModelo('{{ item.transaction_id }}')">
        Gerar Documento
      </button>
    </li>
    {% endif %}

    <!-- Bot√£o para Imprimir QR Code -->
    {% if show_qrcode %}
    <li>
      <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#qrModal" onclick="abrirModalQR('{{ item.item_id }}')">
        Imprimir QR Code
      </button>
    </li>
    {% endif %} {% if show_share %}
    <li>
      <a
        class="dropdown-item"
        href="#"
        onclick="copiarLinkCompartilhamento('{{ url_for('ver_item_publico', item_id=item.item_id, _external=True) }}'); return false;"
      >
        Compartilhar link
      </a>
    </li>
    {% endif %}
  </ul>
</div>

<!-- modal qrcode -->

<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configurar impress√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="qr-item-id" />

        <p>Escolha o que incluir junto ao QR Code:</p>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="imagem" id="check-imagem" checked />
          <label class="form-check-label" for="check-imagem">Imagem do item</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="descricao" id="check-descricao" checked />
          <label class="form-check-label" for="check-descricao">Descri√ß√£o</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="custom_id" id="check-custom_id" checked />
          <label class="form-check-label" for="check-custom_id">ID personalizado</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="obs" id="check-obs" checked />
          <label class="form-check-label" for="check-obs">Observa√ß√µes</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="gerarLayoutQRCode()">Visualizar para Impress√£o</button>
      </div>
    </div>
  </div>
</div>

<script>
  function checkTransactionLimit(event) {
    const totalTransactions = {{ total_relevant_transactions }};
    if (totalTransactions >= 30) {
      alert("O limite de transa√ß√µes simult√¢neas foi atingido. Entre em contato conosco.");
      event.preventDefault();
      return false;
    }
    return true;
  }
</script>

<script>
  function abrirModalQR(itemId) {
    // Verifique se o itemId est√° sendo passado corretamente
    console.log('Abrindo modal para item ID:', itemId);

    // Atribui o itemId ao campo oculto no modal
    document.getElementById('qr-item-id').value = itemId;
  }
</script>

<script>
  function gerarLayoutQRCode() {
    const itemId = document.getElementById('qr-item-id').value; // Recupera o itemId
    console.log('Item ID:', itemId);

    const incluir = [];

    // Verifica os campos selecionados para inclus√£o no conte√∫do
    if (document.getElementById('check-imagem').checked) incluir.push('imagem');
    if (document.getElementById('check-descricao').checked) incluir.push('descricao');
    if (document.getElementById('check-custom_id').checked) incluir.push('custom_id');
    if (document.getElementById('check-obs').checked) incluir.push('obs');

    // Gera a URL para o QR Code com o item_id e os par√¢metros de inclus√£o
    const url = `/imprimir-qrcode/${itemId}?` + incluir.map((i) => `incluir=${i}`).join('&');
    console.log('üîç URL gerada:', url); // Verifique no console se a URL est√° correta

    // Fecha o modal usando JavaScript moderno
    const modal = document.getElementById('qrModal');
    const modalInstance = bootstrap.Modal.getInstance(modal); // Obt√©m a inst√¢ncia do modal
    modalInstance.hide(); // Fecha o modal

    // Abre a URL em uma nova janela para impress√£o
    window.open(url, '_blank');
  }
</script>

<script>
  function copiarLinkCompartilhamento(link) {
    navigator.clipboard
      .writeText(link)
      .then(() => {
        alert('Link copiado para a √°rea de transfer√™ncia!');
      })
      .catch((err) => {
        console.error('Erro ao copiar o link:', err);
        alert('Erro ao copiar o link. Tente novamente.');
      });
  }
</script>
