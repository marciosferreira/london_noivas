<!-- Action Buttons Component -->
<div class="dropdown dropend">
  <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">A√ß√µes</button>
  <ul class="dropdown-menu dropdown-menu-end">
    {% if show_rent %}
    <li>
      <a
        class="dropdown-item text-success"
        href="{{ url_for('rent', item_id=item.item_id, rent='true') }}"
        onclick="return checkTransactionLimit(event);"
      >
        Reservar/Retirar
      </a>
    </li>
    {% endif %} {% if show_mark_returned %}
    <li>
      <a
        class="dropdown-item text-success"
        href="{{ url_for('mark_returned', transaction_id=item.transaction_id, next=request.url) }}"
        onclick="return confirm('Tem certeza de que deseja marcar este item como devolvido?');"
      >
        Marcar como devolvido
      </a>
    </li>
    {% endif %} {% if show_mark_rented %}

    <!-- Bot√£o rented com opc√≥es-->
    <a
      href="#"
      class="dropdown-item text-success"
      title="Retirar"
      onclick="confirmarAcao('{{ url_for('mark_rented', transaction_id=item.transaction_id, next=request.url) }}'); return false;"
    >
      Marcar como retirado
    </a>

    {% endif %} {% if show_edit_item %}
    <li><a class="dropdown-item" href="{{ url_for('edit_item', item_id=item.item_id, next=request.url) }}">Editar item</a></li>
    {% endif %} {% if show_edit_transaction %}
    <li>
      <a class="dropdown-item" href="{{ url_for('edit_transaction', transaction_id=item.transaction_id, next=request.url) }}">Editar transa√ß√£o</a>
    </li>
    {% endif %} {% if show_edit_client %}
    <li>
      <a
        class="dropdown-item"
        href="{{ url_for('editar_cliente', client_id=(cliente.client_id if cliente is defined else item.client_id), next=request.url) }}"
      >
        Editar cliente
      </a>
    </li>
    {% endif %} {% if show_view_transactions %}
    <li><a class="dropdown-item" href="{{ url_for('client_transactions', client_id=cliente.client_id) }}">Transa√ß√µes do cliente</a></li>
    {% endif %} {% if show_consult or show_ver_reservas %}
    <li><a class="dropdown-item" href="{{ url_for('view_calendar', item_id=item.item_id, next=request.url) }}">Ver reservas do item</a></li>
    {% endif %} {% if show_archive %}
    <li>
      <a
        class="dropdown-item"
        href="{{ url_for('mark_archived', item_id=item.item_id, next=request.url) }}"
        onclick="return confirm('Tem certeza de que deseja arquivar este item?');"
      >
        Arquivar item
      </a>
    </li>
    {% endif %} {% if show_restore %}
    <li>
      <a
        class="dropdown-item text-success"
        href="{{ url_for('restore_item', item_id=item.item_id, next=request.url) }}"
        onclick="return confirm('Tem certeza de que deseja restaurar este item?');"
      >
        Restaurar
      </a>
    </li>
    {% endif %} {% if show_mark_available %}

    <!-- Bot√£o Dispon√≠vel -->
    <a
      href="{{ url_for('mark_available', item_id=item.item_id, next=request.url) }}"
      class="dropdown-item"
      title="Tornar dispon√≠vel"
      onclick="return confirm('Tem certeza que deseja tornar este item dispon√≠vel novamente?');"
    >
      Diponibilizar item
    </a>
    {% endif %} {% if show_delete_item or show_delete_transaction %} {% endif %} {% if show_delete_item %}
    <li>
      <form method="POST" action="{{ url_for('delete', item_id=item.item_id, next=request.url) }}" style="display: inline">
        <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Tem certeza de que deseja deletar este item?');">
          Deletar item
        </button>
      </form>
    </li>
    {% endif %} {% if show_delete_client %}
    <li>
      <form
        method="POST"
        action="{{ url_for('deletar_cliente', client_id=cliente.client_id) }}"
        onsubmit="return confirm('Tem certeza que deseja deletar este cliente? Esta a√ß√£o n√£o poder√° ser desfeita.');"
        style="display: inline"
      >
        <button type="submit" class="dropdown-item text-danger" title="Deletar">
          <i class="fas fa-trash"></i>
          Deletar cliente
        </button>
      </form>
    </li>
    {% endif %} {% if show_delete_transaction %}
    <li>
      <a
        class="dropdown-item text-danger"
        href="{{ url_for('delete_transaction', transaction_id=item.transaction_id, next=request.url) }}"
        onclick="return confirm('Tem certeza de que deseja deletar esta transa√ß√£o?');"
      >
        Deletar transa√ß√£o
      </a>
    </li>
    {% endif %} {% if show_print %}
    <li>
      <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modalModelo" onclick="abrirModalModelo('{{ item.transaction_id }}')">
        Gerar Documento
      </button>
    </li>
    {% endif %} {% if show_qrcode %}
    <li>
      <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#qrModal" onclick="abrirModalQR('{{ item.item_id }}')">
        Imprimir QR Code
      </button>
    </li>
    {% endif %} {% if show_share %}
    <li>
      <a
        class="dropdown-item"
        href="#"
        onclick="copiarLinkCompartilhamento('{{ url_for('ver_item_publico', item_id=item.item_id, _external=True) }}'); return false;"
      >
        Compartilhar link
      </a>
    </li>
    {% endif %}
  </ul>
</div>

<!-- Modal para Sele√ß√£o do Modelo -->
<div class="modal fade" id="modalModelo" tabindex="-1" aria-labelledby="modalModeloLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gerar Documento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <label for="select-modelo">Escolha um modelo:</label>
        <select class="form-select mb-3" id="select-modelo" onchange="carregarModeloSelecionado()">
          <option value="">Selecione...</option>
          {% for modelo in saved_models %}
          <option value="{{ modelo.text_id }}">{{ modelo.nome }}</option>
          {% endfor %}
        </select>

        <!-- √Årea de conte√∫do do modelo selecionado -->
        <div id="print-area">
          <p class="text-muted">Nenhum modelo selecionado.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" onclick="printConteudo()">üñ®Ô∏è Imprimirx</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Sele√ß√£o do Modelo -->
<div class="modal fade" id="modalModelo" tabindex="-1" aria-labelledby="modalModeloLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gerar Documento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <label for="select-modelo">Escolha um modelo:</label>
        <select class="form-select mb-3" id="select-modelo" onchange="carregarModeloSelecionado()">
          <option value="">Selecione...</option>
          {% for modelo in saved_models %}
          <option value="{{ modelo.text_id }}">{{ modelo.nome }}</option>
          {% endfor %}
        </select>

        <!-- √Årea de conte√∫do do modelo selecionado -->
        <div id="print-area">
          <p class="text-muted">Nenhum modelo selecionado.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" onclick="printConteudo()">üñ®Ô∏è Imprimirb</button>
      </div>
    </div>
  </div>
</div>

<!-- modal qrcode -->

<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configurar impress√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="qr-item-id" />

        <p>Escolha o que incluir junto ao QR Code:</p>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="imagem" id="check-imagem" checked />
          <label class="form-check-label" for="check-imagem">Imagem do item</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="descricao" id="check-descricao" checked />
          <label class="form-check-label" for="check-descricao">Descri√ß√£o</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="custom_id" id="check-custom_id" checked />
          <label class="form-check-label" for="check-custom_id">ID personalizado</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="obs" id="check-obs" checked />
          <label class="form-check-label" for="check-obs">Observa√ß√µes</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="gerarLayoutQRCode()">Visualizar para Impress√£o</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de impress√£o qrcode-->
<div class="modal fade" id="modalPrintPreview" tabindex="-1" aria-labelledby="modalPrintPreviewLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Pr√©-visualiza√ß√£o para impress√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body" id="print-preview-content">
        <p class="text-muted">Carregando...</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button class="btn btn-primary" onclick="printModalContent()">üñ®Ô∏è Imprimirs</button>
      </div>
    </div>
  </div>
</div>

<script>
  function checkTransactionLimit(event) {
    const totalTransactions = {{ total_relevant_transactions }};
    if (totalTransactions >= 30) {
      alert("O limite de transa√ß√µes simult√¢neas foi atingido. Entre em contato conosco.");
      event.preventDefault();
      return false;
    }
    return true;
  }

  // ‚úÖ Fun√ß√£o para imprimir apenas a √°rea de conte√∫do do modal
</script>

<script>
  function abrirModalQR(itemId) {
    document.getElementById('qr-item-id').value = itemId;
  }
</script>

<script>
  function gerarLayoutQRCode() {
    const itemId = document.getElementById('qr-item-id').value;
    const checks = {
      imagem: document.getElementById('check-imagem').checked,
      descricao: document.getElementById('check-descricao').checked,
      custom_id: document.getElementById('check-custom_id').checked,
      obs: document.getElementById('check-obs').checked,
    };

    fetch(`/qr-data/${itemId}`)
      .then((res) => res.json())
      .then((data) => {
        let html = `
          <div style="text-align:center;">
            <img src="/static/qrcodes/${itemId}.png" alt="QR Code"><hr>
        `;

        if (checks.imagem && data.image_url) {
          html += `<img src="${data.image_url}" style="max-width:200px;"><br>`;
        }
        if (checks.descricao) {
          html += `<strong>Descri√ß√£o:</strong> ${data.description}<br>`;
        }
        if (checks.custom_id) {
          html += `<strong>ID:</strong> ${data.item_custom_id}<br>`;
        }
        if (checks.obs) {
          html += `<strong>Observa√ß√µes:</strong> ${data.item_obs}<br>`;
        }

        html += `</div>`;

        const win = window.open('', '', 'width=600,height=800');
        win.document.write(`<html><head><title>Imprimir</title></head><body>${html}<script>window.print();<\/script></body></html>`);
        win.document.close();
      });
  }
</script>

<script>
  // ‚úÖ Fun√ß√£o para imprimir qrcode

  function gerarLayoutQRCode() {
    const itemId = document.getElementById('qr-item-id').value;
    const incluir = [];

    if (document.getElementById('check-imagem').checked) incluir.push('imagem');
    if (document.getElementById('check-descricao').checked) incluir.push('descricao');
    if (document.getElementById('check-custom_id').checked) incluir.push('custom_id');
    if (document.getElementById('check-obs').checked) incluir.push('obs');

    const url = `/imprimir-item/${itemId}?` + incluir.map((i) => `incluir=${i}`).join('&');

    console.log('üîç URL gerada:', url); // üîß Verificar no console
    window.open(url, '_blank');
  }
</script>

<script>
  // ‚úÖ Fun√ß√£o para imprimir qrcode

  function gerarLayoutQRCode() {
    const itemId = document.getElementById('qr-item-id').value;
    const incluir = [];

    if (document.getElementById('check-imagem').checked) incluir.push('imagem');
    if (document.getElementById('check-descricao').checked) incluir.push('descricao');
    if (document.getElementById('check-custom_id').checked) incluir.push('custom_id');
    if (document.getElementById('check-obs').checked) incluir.push('obs');

    const url = `/imprimir-item/${itemId}?` + incluir.map((i) => `incluir=${i}`).join('&');

    fetch(url)
      .then((response) => response.text())
      .then((html) => {
        document.getElementById('print-preview-content').innerHTML = html;
        const modal = new bootstrap.Modal(document.getElementById('modalPrintPreview'));
        modal.show();
      });
  }
</script>

<script>
  // ‚úÖ Fun√ß√£o para imprimir qrcode

  function printModalContent() {
    const conteudo = document.getElementById('print-preview-content').innerHTML;

    const janela = window.open('', '', 'width=800,height=600');
    janela.document.write(`
      <html>
        <head>
          <title>Imprimir</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
            hr { margin: 20px 0; }
            img { max-width: 200px; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
            @media print {
              .no-print { display: none !important; }
            }
          </style>
        </head>
        <body>
          ${conteudo}
          <script>
            window.onload = function () {
              setTimeout(function () {
                window.print();
                window.close();
              }, 300);
            }
          <\/script>
        </body>
      </html>
    `);
    janela.document.close();
  }
</script>

<script>
  function copiarLinkCompartilhamento(link) {
    navigator.clipboard
      .writeText(link)
      .then(() => {
        alert('Link copiado para a √°rea de transfer√™ncia!');
      })
      .catch((err) => {
        console.error('Erro ao copiar o link:', err);
        alert('Erro ao copiar o link. Tente novamente.');
      });
  }
</script>

<script>
  let transacaoSelecionada = null;

  function abrirModalModelo(transactionId) {
    transacaoSelecionada = transactionId;
    document.getElementById('print-area').innerHTML = "<p class='text-muted'>Nenhum modelo selecionado.</p>";
    document.getElementById('select-modelo').value = '';
  }

  function carregarModeloSelecionado() {
    const select = document.getElementById('select-modelo');
    const textId = select.value;
    const outputDiv = document.getElementById('print-area');

    if (!textId || !transacaoSelecionada) {
      outputDiv.innerHTML = "<p class='text-muted'>Selecione um modelo para visualizar.</p>";
      return;
    }

    outputDiv.innerHTML = '<p>Carregando...</p>';

    fetch(`/visualizar-modelo/${textId}/${transacaoSelecionada}`)
      .then((response) => response.text())
      .then((html) => {
        outputDiv.innerHTML = html;
      })
      .catch((error) => {
        outputDiv.innerHTML = "<p class='text-danger'>Erro ao carregar modelo.</p>";
        console.error(error);
      });
  }
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Evita que clique no bot√£o "Deletar" ative o modal
    document.querySelectorAll('.action-button.danger').forEach((btn) => {
      btn.addEventListener('click', function (e) {
        e.stopPropagation();
      });
    });
  });
</script>

<script>
  function printConteudo() {
    // Conte√∫do est√°tico para impress√£o
    const conteudoHtml = `
          <h1>Conte√∫do Est√°tico para Impress√£o</h1>
          <p>Este √© um exemplo de conte√∫do que ser√° impresso.</p>
          <p><strong>Descri√ß√£o:</strong> Teste de impress√£o com conte√∫do est√°tico.</p>
          <p><strong>ID do Item:</strong> 1234567890</p>
        `;

    const conteudo = document.getElementById('print-area').innerHTML;

    // Calcula a largura e altura da janela com base no tamanho da tela do dispositivo
    const largura = window.innerWidth * 0.9; // 90% da largura da tela
    const altura = window.innerHeight * 0.9; // 90% da altura da tela

    // Abre a janela de impress√£o com tamanho din√¢mico
    const win = window.open('', '', `width=${largura},height=${altura},scrollbars=yes`);

    if (!win) {
      alert('N√£o foi poss√≠vel abrir a janela de impress√£o. Verifique se o bloqueador de pop-up est√° ativado.');
      return;
    }

    win.document.open();
    win.document.write(`
          <html>
            <head>
              <title>Imprimir</title>
              <style>
                body {
                  font-family: Arial, sans-serif;
                  padding: 20px;
                  background: #fff;
                }

                @media print {
                  body {
                    font-size: 14px;
                  }

                  .no-print {
                    display: none !important;
                  }

                  @page {
                    size: A4;
                    margin: 20mm;
                  }
                }

                /* Garante que o conte√∫do se ajusta em diferentes tamanhos de tela */
                .modelo-gerado {
                  width: 100%;
                  margin: 0 auto;
                  padding: 10px;
                }
              </style>
            </head>
            <body>
              <div class="modelo-gerado">
                ${conteudoHtml}
              </div>
            </body>
          </html>
        `);
    win.document.close();

    // Espera o conte√∫do ser carregado e chama a impress√£o
    win.onload = function () {
      setTimeout(() => {
        win.print();
        win.close();
      }, 500);
    };
  }
</script>
