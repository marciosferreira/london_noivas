<!DOCTYPE html>
<html lang="pt-br">
  <head>

    <script src="https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.1/dist/index.umd.min.js"></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Registro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_edit_transaction.css') }}" />
  </head>
  <body>



    <div class="form-container">
      <h1>Editar transa√ß√£o</h1>
      <a href="{{ request.args.get('next', url_for('index')) }}" class="cancel-link">Sair sem Finalizar</a>


      <form method="POST" enctype="multipart/form-data">


        <label for="client_name">Nome do Cliente:</label>
        <div class="position-relative">
          <input type="text" id="client_name" name="client_name" autocomplete="off" class="form-control" value="{{ item.client_name}}"required />
          <div id="client_suggestions" class="autocomplete-suggestions"></div>
        </div>

<br>
<input type="hidden" name="client_id" id="client_id" />




        <label for="client_tel">Telefone do Cliente:</label>
        <input type="text" id="client_tel" name="client_tel" value="{{ item.client_tel }}" required />

        <label for="datepicker">Defina as datas:</label>
        <input id="datepicker" name="range_date" class="form-control" value="{{ item.range_date }}"/>

        <div class="form-group">
          <label for="retirado">
            <input type="checkbox" id="retirado" name="retirado" value="True" {% if item.retirado %}checked{% endif %} />
            Retirado
          </label>
        </div>

        {% if 'returned' in request.full_path %}
  <label for="return_date">Data de Devolu√ß√£o:</label>
  <input type="date" id="return_date" name="return_date" value="{{ item.return_date }}" required />
{% endif %}



        <label for="valor">Valor (R$):</label>
        <input type="number" id="valor" name="valor" step="0.01" min="0" value="{{ item.valor }}" required/>

        <label for="pagamento">Pagamento:</label>
<select id="pagamento" name="pagamento">
    <option value="N√£o pago" {% if item.pagamento == "N√£o pago" or not item.pagamento %}selected{% endif %}>N√£o pago</option>
    <option value="Pago 50%" {% if item.pagamento == "Pago 50%" %}selected{% endif %}>Pago 50%</option>
    <option value="Pago 100%" {% if item.pagamento == "Pago 100%" %}selected{% endif %}>Pago 100%</option>
</select>

<label for="comments">Observa√ß√µes:</label>
<textarea id="comments" name="comments" rows="3" value="{{item.comments}}">{{item.comments}}</textarea>


<!-- Campo de Data -->
<div id="dev-date-container" style="display: none;">
  <label for="dev_date">Devolvido em:</label>
  <input
    type="date"
    id="dev_date"
    name="dev_date"
    value="{{ item.dev_date }}"
  />
</div>

<script>
  // Fun√ß√£o para atualizar a exibi√ß√£o e obrigatoriedade do campo de data
  function updateDevDateField() {
    const returnedRadio = document.getElementById('status-returned');
    const devDateContainer = document.getElementById('dev-date-container');
    const devDateInput = document.getElementById('dev_date');

    // Verifica se o status √© "returned"
    if (returnedRadio.checked) {
      devDateContainer.style.display = 'block'; // Mostra o campo
      devDateInput.required = true;            // Torna obrigat√≥rio
    } else {
      devDateContainer.style.display = 'none'; // Esconde o campo
      devDateInput.required = false;           // Remove obrigatoriedade
    }
  }

  // Adiciona eventos aos bot√µes de r√°dio
  const radioButtons = document.querySelectorAll('input[name="status"]');
  radioButtons.forEach((radio) => {
    radio.addEventListener('change', updateDevDateField);
  });

  // Atualiza a exibi√ß√£o inicial com base no valor atual do status
  window.onload = function () {
    updateDevDateField();
  };
</script>



        <label>Foto Atual:</label>
        {% if item.image_url and item.image_url != "" %}
        <img src="{{ item.image_url }}" alt="Imagem do vestido" />
        {% else %}
        <img src="{{ url_for('static', filename='item-placeholder.png') }}" alt="Sem Imagem" />
        {% endif %}



        <button type="submit">Salvar</button>
      </form>
    </div>






  </body>
</html>



<script>
  const DateTime = easepick.DateTime;
  const bookedDates = {{ reserved_ranges | tojson(indent=2) }}.map(d => {
      if (d instanceof Array) {
        const start = new DateTime(d[0], 'YYYY-MM-DD');
        const end = new DateTime(d[1], 'YYYY-MM-DD');
        return [start, end];
      }
      return new DateTime(d, 'YYYY-MM-DD');
  });
  const picker = new easepick.create({
    element: document.getElementById('datepicker'),
    css: [
      'https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.1/dist/index.css',
      'https://easepick.com/css/demo_hotelcal.css',
    ],
    lang: 'pt-BR',
    autoApply: false, // Exibe os bot√µes "Aplicar" e "Cancelar"
    plugins: ['RangePlugin', 'LockPlugin', 'AmpPlugin'],
    AmpPlugin: {
      resetButton: true,  // üëà Isso ativa o bot√£o "Limpar"
    },
    RangePlugin: {
      tooltipNumber(num) {
        return num;
      },
      locale: {
        one: 'dia',
        other: 'dias',
      },
    },
    LockPlugin: {
      minDate: new Date(),
      minDays: 1,
      inseparable: true,
      filter(date, picked) {
        if (picked.length === 1) {
          const incl = date.isBefore(picked[0]) ? '[]' : '[]';
          return !picked[0].isSame(date, 'day') && date.inArray(bookedDates, incl);
        }
        return date.inArray(bookedDates, '[]');
      },
    },
    locale: {
      cancel: 'Cancelar',
      apply: 'Aplicar',
      reset: 'Limpar',
      one: 'dia',
      other: 'dias',
    },

    format: 'DD/MM/YYYY',
  });


  picker.on('preselect', (evt) => {
    const start = picker.getStartDate();
    const end = picker.getEndDate();

    if (start && end) {
      const clickedDate = evt.detail.date;

      // Previne que o EasePick processe esse clique
      evt.preventDefault();

      // Limpa a sele√ß√£o atual
      picker.setStartDate(null);
      picker.setEndDate(null);
      document.getElementById('datepicker').value = '';

      // Define o clique atual como o novo in√≠cio do range
      picker.setStartDate(clickedDate);
    }
  });
</script>


<script>
  document.getElementById('form-rent').addEventListener('submit', function (e) {
    const dp = document.getElementById('datepicker');
    if (!dp.value || dp.value.trim() === '') {
      e.preventDefault(); // cancela o envio
      alert('Por favor, selecione um intervalo de datas.');
      dp.focus();
    }
  });
</script>




<script>
  const clientInput = document.getElementById('client_name');
  const telInput = document.getElementById('client_tel');
  const idInput = document.getElementById('client_id');
  const emailInput = document.getElementById('client_email');
  const cpfInput = document.getElementById('client_cpf');
  const cnpjInput = document.getElementById('client_cnpj');
  const suggestionsBox = document.getElementById('client_suggestions');

  clientInput.addEventListener('input', async () => {
    const term = clientInput.value.trim();
    if (term.length < 2) {
      suggestionsBox.innerHTML = '';
      return;
    }

    const res = await fetch(`/autocomplete_clients?term=${encodeURIComponent(term)}`);
    const clients = await res.json();

    suggestionsBox.innerHTML = '';
    clients.forEach((client) => {
      const tel = client.client_tel ? `<div><small>üìû ${client.client_tel}</small></div>` : '';
      const email = client.client_email ? `<div><small>üìß ${client.client_email}</small></div>` : '';
      const cpf = client.client_cpf ? `<div><small>üÜî CPF: ${client.client_cpf}</small></div>` : '';
      const cnpj = client.client_cnpj ? `<div><small>üè¢ CNPJ: ${client.client_cnpj}</small></div>` : '';

      const div = document.createElement('div');
      div.className = 'autocomplete-item';
      div.innerHTML = `<strong>${client.client_name}</strong>${tel}${email}${cpf}${cnpj}`;

      div.addEventListener('click', () => {
        clientInput.value = client.client_name || '';
        telInput.value = client.client_tel || '';
        if (idInput) idInput.value = client.client_id || '';
        if (emailInput) emailInput.value = client.client_email || '';
        if (cpfInput) cpfInput.value = client.client_cpf || '';
        if (cnpjInput) cnpjInput.value = client.client_cnpj || '';

        suggestionsBox.innerHTML = '';
      });

      suggestionsBox.appendChild(div);
    });
  });

  document.addEventListener('click', (e) => {
    if (!clientInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.innerHTML = '';
    }
  });
</script>
