{% extends "base.html" %}
{% block title %}Adicionar Cliente{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_add_client.css') }}" />
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Novo Cliente</h1>
    <a href="{{ next or url_for('listar_clientes') }}" class="cancel-link">Cancelar</a>
  </div>
  <div class="alert alert-primary d-flex justify-content-between align-items-center" role="alert">
    <div>
      Dica: Acesse <a href="/custom_fields/item" class="alert-link">Customizar Campos</a> para criar novos ou ajustar os existentes.
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
  </div>

  <form method="POST" id="clientForm">
    <input type="hidden" name="next" value="{{ next or url_for('listar_clientes') }}" />

    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for field in all_fields if field.visible %}
      <div class="col d-flex">
        <div class="bg-light shadow-sm rounded p-3 border w-100 h-100 d-flex flex-column justify-content-center">
          <label for="{{ field.id }}" class="form-label fw-semibold">
            {{ field.label if field.fixed else field.title }}{% if field.required %} *{% endif %}
          </label>

          {% if field.type == 'client_phone' %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ client.get(field.id, '') }}" {% if field.required %}required{% endif %} />

              {% elif field.type == 'client_name' %}
              <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
                value="{{ client.get(field.id, '') }}" {% if field.required %}required{% endif %} />
                <div id="client-suggestions-title" style="display: none;">Clientes encontrados:</div>
<div id="client_suggestions" class="autocomplete-box"></div>
<div id="client-status-message" class="status-message" style="display: none;"></div>


          {% elif field.type == 'client_email' %}
            <input type="email" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ client.get(field.id, '') }}" {% if field.required %}required{% endif %} />

              {% elif field.type == 'client_address' %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ client.get(field.id, '') }}" {% if field.required %}required{% endif %} />

          {% elif field.type == 'client_cpf' %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ client.get(field.id, '') }}" {% if field.required %}required{% endif %} />

              {% elif field.type == 'client_cnpj' %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ client.get(field.id, '') }}" {% if field.required %}required{% endif %} />

              {% elif field.type == 'client_notes' %}
              <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
                value="{{ client.get(field.id, '') }}" {% if field.required %}required{% endif %} />


          {% elif field.type == 'dropdown' %}
            <select class="form-select" id="{{ field.id }}" name="{{ field.id }}" {% if field.required %}required{% endif %}>
              <option value="">Selecione</option>
              {% for option in field.options %}
                <option value="{{ option }}" {% if client.get(field.id) == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="d-flex justify-content-center mt-4">
      <button type="submit" class="btn btn-success btn-submit">Salvar</button>
    </div>
  </form>
</div>
{% endblock %}





 {% block scripts %}
 <script>
  document.addEventListener('DOMContentLoaded', function () {
    function maskCPF(cpf) {
      return cpf.replace(/\D/g, '')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    function maskCNPJ(cnpj) {
      return cnpj.replace(/\D/g, '')
        .replace(/^(\d{2})(\d)/, '$1.$2')
        .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
        .replace(/\.(\d{3})(\d)/, '.$1/$2')
        .replace(/(\d{4})(\d)/, '$1-$2');
    }

    function maskPhone(value) {
      const v = value.replace(/\D/g, '').slice(0, 11);
      return v.length >= 8
        ? `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`
        : v.length >= 3
        ? `(${v.slice(0,2)}) ${v.slice(2)}`
        : v.length >= 1
        ? `(${v}`
        : '';
    }

    const cpfInput = document.getElementById('client_cpf');
    const cnpjInput = document.getElementById('client_cnpj');
    const telInput = document.getElementById('client_phone');

    if (cpfInput) cpfInput.addEventListener('input', e => e.target.value = maskCPF(e.target.value));
    if (cnpjInput) cnpjInput.addEventListener('input', e => e.target.value = maskCNPJ(e.target.value));
    if (telInput) telInput.addEventListener('input', e => e.target.value = maskPhone(e.target.value));

    const form = document.getElementById('clientForm');
    if (form) {
      form.addEventListener('submit', function (e) {
        const cpf = cpfInput?.value.replace(/\D/g, '');
        const cnpj = cnpjInput?.value.replace(/\D/g, '');

        if (cpf && !validaCPF(cpf)) {
          e.preventDefault();
          alert('CPF inv√°lido!');
        }

        if (cnpj && !validaCNPJ(cnpj)) {
          e.preventDefault();
          alert('CNPJ inv√°lido!');
        }
      });
    }

    function validaCPF(cpf) {
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf[i]) * (10 - i);
      let resto = soma % 11;
      let dig1 = resto < 2 ? 0 : 11 - resto;

      if (dig1 != parseInt(cpf[9])) return false;

      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf[i]) * (11 - i);
      resto = soma % 11;
      let dig2 = resto < 2 ? 0 : 11 - resto;

      return dig2 == parseInt(cpf[10]);
    }

    function validaCNPJ(cnpj) {
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
      let t = cnpj.length - 2, d = cnpj.substring(t), n = cnpj.substring(0, t), s = 0, p = t - 7;
      for (let i = t; i >= 1; i--) {
        s += n.charAt(t - i) * p--;
        if (p < 2) p = 9;
      }
      let r = s % 11 < 2 ? 0 : 11 - s % 11;
      if (r != d.charAt(0)) return false;

      t += 1; n = cnpj.substring(0, t); s = 0; p = t - 7;
      for (let i = t; i >= 1; i--) {
        s += n.charAt(t - i) * p--;
        if (p < 2) p = 9;
      }
      r = s % 11 < 2 ? 0 : 11 - s % 11;
      return r == d.charAt(1);
    }
  });
</script>



<script>
  function autocompleteClienteRedirect() {
    const clientInput = document.getElementById('client_name');
    const statusMessage = document.getElementById('client-status-message');
    const suggestionsBox = document.getElementById('client_suggestions');
    const titleBox = document.getElementById('client-suggestions-title'); // ‚¨ÖÔ∏è fora do loop!

    let suggestionClicked = false;

    if (!clientInput || !statusMessage || !suggestionsBox || !titleBox) return;

    let currentController = null;

clientInput.addEventListener('input', async () => {
  const term = clientInput.value.trim();

  // Cancela requisi√ß√£o anterior se ainda estiver ativa
  if (currentController) {
    currentController.abort();
  }

  // Cria novo controller para esta requisi√ß√£o
  currentController = new AbortController();
  const signal = currentController.signal;

  suggestionsBox.innerHTML = '';
  titleBox.style.display = 'none';
  statusMessage.style.display = 'none';

  if (term.length < 1) return;

  try {
    const res = await fetch(`/autocomplete_clients?term=${encodeURIComponent(term)}`, { signal });
    const clients = await res.json();

    if (clients.length === 0) return;

    titleBox.style.display = 'block';

    clients.forEach((client) => {
      function formatCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        return cpf.replace(/(\d{3})(\d)/, '$1.$2')
                  .replace(/(\d{3})(\d)/, '$1.$2')
                  .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      }

      function formatCNPJ(cnpj) {
        cnpj = cnpj.replace(/\D/g, '');
        return cnpj.replace(/^(\d{2})(\d)/, '$1.$2')
                   .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
                   .replace(/\.(\d{3})(\d)/, '.$1/$2')
                   .replace(/(\d{4})(\d)/, '$1-$2');
      }

      function formatPhone(tel) {
        const v = tel.replace(/\D/g, '').slice(0, 11);
        return v.length >= 8
          ? `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`
          : v.length >= 3
          ? `(${v.slice(0,2)}) ${v.slice(2)}`
          : v.length >= 1
          ? `(${v}`
          : '';
      }

      const div = document.createElement('div');
      div.className = 'autocomplete-item';

      const tel = client.client_tel && client.client_tel !== 'N/A' ? formatPhone(client.client_tel) : '';
      const cpf = client.client_cpf && client.client_cpf !== 'N/A' ? formatCPF(client.client_cpf) : '';
      const cnpj = client.client_cnpj && client.client_cnpj !== 'N/A' ? formatCNPJ(client.client_cnpj) : '';

      div.innerHTML = `
        <strong>${client.client_name}</strong>
        ${tel ? `<div><small>üìû ${tel}</small></div>` : ''}
        ${cpf ? `<div><small>üÜî CPF: ${cpf}</small></div>` : ''}
        ${cnpj ? `<div><small>üè¢ CNPJ: ${cnpj}</small></div>` : ''}
      `;
      div.addEventListener('click', () => {
        window.location.href = `/editar_cliente/${client.client_id}`;
      });
      suggestionsBox.appendChild(div);
    });
  } catch (err) {
    if (err.name !== 'AbortError') {
      console.error('Erro no autocomplete:', err);
    }
    // Se for AbortError, ignora silenciosamente
  }
});


    clientInput.addEventListener('blur', () => {
      setTimeout(() => {
        if (!suggestionClicked && clientInput.value.trim().length > 1) {
          suggestionsBox.innerHTML = '';
          titleBox.style.display = 'none';
          statusMessage.className = 'status-message user-new';
          statusMessage.innerHTML = 'Novo cliente ser√° criado.';
          statusMessage.style.display = 'block';
        }
      }, 200);
    });

    document.addEventListener('click', (e) => {
      if (!clientInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
        suggestionsBox.innerHTML = '';
        titleBox.style.display = 'none';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', autocompleteClienteRedirect);
</script>

{% endblock %}
