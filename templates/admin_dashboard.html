{% extends "base.html" %} {% block title %}LocaShop - Painel de Administração{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    checkAIStatus();
});

function checkAIStatus() {
    const loading = document.getElementById('aiStatusLoading');
    const content = document.getElementById('aiStatusContent');
    const alert = document.getElementById('aiSyncAlert');
    const btn = document.getElementById('btnSyncAI');
    
    loading.classList.remove('d-none');
    content.classList.add('d-none');
    alert.classList.add('d-none');
    btn.disabled = true;

    fetch('/api/admin/ai-status')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Erro:', data.error);
                return;
            }

            document.getElementById('aiDbCount').textContent = data.db_count;
            document.getElementById('aiIndexCount').textContent = data.index_count;
            document.getElementById('aiMissingCount').textContent = data.missing_count;
            document.getElementById('aiDeletedCount').textContent = data.deleted_count;

            loading.classList.add('d-none');
            content.classList.remove('d-none');
            btn.disabled = false;

            // Reset alert classes
            alert.classList.remove('alert-danger', 'alert-warning');
            
            if (data.integrity_error) {
                alert.classList.remove('d-none');
                alert.classList.add('alert-danger');
                document.getElementById('aiSyncMsg').innerHTML = `<strong>ERRO DE INTEGRIDADE:</strong> ${data.integrity_error}`;
            } else if (data.warning) {
                alert.classList.remove('d-none');
                alert.classList.add('alert-warning');
                document.getElementById('aiSyncMsg').innerHTML = `<strong>ATENÇÃO:</strong> ${data.warning}`;
            } else if (data.missing_count > 0 || data.deleted_count > 0) {
                alert.classList.remove('d-none');
                alert.classList.add('alert-warning');
                const msg = [];
                if (data.missing_count > 0) msg.push(`${data.missing_count} novos itens para adicionar`);
                if (data.deleted_count > 0) msg.push(`${data.deleted_count} itens para remover`);
                document.getElementById('aiSyncMsg').textContent = msg.join(' e ') + '.';
            }
        })
        .catch(err => {
            console.error('Erro ao buscar status IA:', err);
            loading.innerHTML = '<p class="text-danger">Erro ao carregar status da IA.</p>';
        });
}

function syncAIIndex() {
    checkAIStatus(); // Apenas recarrega o status
}

function confirmSyncAI() {
    if (!confirm('Esta operação pode levar alguns minutos dependendo do número de novos itens. Deseja continuar?')) {
        return;
    }

    const btnSync = document.getElementById('btnRunSyncAI');
    const btnReset = document.getElementById('btnResetAIIndex');
    const alertEl = document.getElementById('aiSyncAlert');
    const originalTextSync = btnSync.innerHTML;
    btnSync.disabled = true;
    if (btnReset) btnReset.disabled = true;
    btnSync.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
    if (alertEl) {
        alertEl.classList.remove('d-none');
        alertEl.classList.add('alert-warning');
    }

    fetch('/api/admin/sync-ai-index', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'started') {
            startProgressPolling(() => {
                btnSync.disabled = false;
                if (btnReset) btnReset.disabled = false;
                btnSync.innerHTML = originalTextSync;
                checkAIStatus();
            });
        } else {
            alert('Erro ao iniciar sincronização.');
            btnSync.disabled = false;
            if (btnReset) btnReset.disabled = false;
            btnSync.innerHTML = originalTextSync;
        }
    })
    .catch(err => {
        alert('Erro de comunicação com o servidor.');
        console.error(err);
        btnSync.disabled = false;
        if (btnReset) btnReset.disabled = false;
        btnSync.innerHTML = originalTextSync;
    });
}

function confirmResetAI() {
    if (!confirm('Isto vai apagar o índice local e reconstruir tudo do zero (sem apagar itens cadastrados). Deseja continuar?')) {
        return;
    }

    const btnSync = document.getElementById('btnRunSyncAI');
    const btnReset = document.getElementById('btnResetAIIndex');
    const originalTextReset = btnReset.innerHTML;
    btnReset.disabled = true;
    if (btnSync) btnSync.disabled = true;
    btnReset.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetando...';

    fetch('/api/admin/sync-ai-index', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({reset_local: true, force_regenerate: true})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'started') {
            startProgressPolling(() => {
                btnReset.disabled = false;
                if (btnSync) btnSync.disabled = false;
                btnReset.innerHTML = originalTextReset;
                checkAIStatus();
            });
        } else {
            alert('Erro ao iniciar reset.');
            btnReset.disabled = false;
            if (btnSync) btnSync.disabled = false;
            btnReset.innerHTML = originalTextReset;
        }
    })
    .catch(err => {
        alert('Erro de comunicação com o servidor.');
        console.error(err);
        btnReset.disabled = false;
        if (btnSync) btnSync.disabled = false;
        btnReset.innerHTML = originalTextReset;
    });
}
function startProgressPolling(onFinish) {
    const bar = document.getElementById('aiProgressBar');
    const text = document.getElementById('aiProgressText');
    let stop = false;
    let lastMsg = '';

    function render(p) {
        const total = p.total || 0;
        const processed = p.processed || 0;
        const pct = total > 0 ? Math.round((processed / total) * 100) : 0;
        bar.style.width = pct + '%';
        bar.textContent = pct + '%';
        const eta = typeof p.eta_seconds === 'number' ? p.eta_seconds : null;
        const current = p.current || '';
        if (p.running) {
            text.textContent = `[${processed}/${total}] ${current ? 'Processando ' + current : ''}${eta !== null ? ' • ETA ~' + eta + 's' : ''}`;
        } else if (p.done) {
            bar.classList.remove('progress-bar-animated');
            bar.classList.remove('bg-warning');
            bar.classList.add('bg-success');
            text.textContent = p.message || 'Concluído';
            lastMsg = p.message || 'Concluído';
        }
        if (p.error) {
            bar.classList.add('bg-danger');
            text.textContent = 'Erro: ' + p.error;
            lastMsg = 'Erro: ' + p.error;
        }
    }

    function poll() {
        if (stop) return;
        fetch('/api/admin/sync-progress')
            .then(r => r.json())
            .then(p => {
                render(p);
                if (p.done && !p.running) {
                    stop = true;
                    if (!p.error) {
                        alert(lastMsg || 'Índice atualizado com sucesso!');
                        const alertEl = document.getElementById('aiSyncAlert');
                        if (alertEl) {
                            alertEl.classList.add('d-none');
                            alertEl.classList.remove('alert-danger', 'alert-warning');
                        }
                    } else {
                        alert(lastMsg);
                    }
                    if (typeof onFinish === 'function') onFinish();
                } else {
                    setTimeout(poll, 1000);
                }
            })
            .catch(() => setTimeout(poll, 2000));
    }

    bar.classList.add('bg-warning');
    bar.classList.add('progress-bar-animated');
    bar.style.width = '0%';
    bar.textContent = '0%';
    text.textContent = 'Iniciando...';
    poll();
}
</script>
{% endblock %} {% block content %}
<div class="container mt-5 pt-5">
  <h1 class="text-center mb-4">Painel de Administração Geral</h1>

  <div class="row mb-4">
    <!-- Card de Status da IA -->
    <div class="col-12 mb-4">
      <div class="card border-info">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h2 class="card-title h5 m-0"><i class="fas fa-robot me-2"></i>Status do Índice de IA</h2>
          <button id="btnSyncAI" class="btn btn-light btn-sm" onclick="syncAIIndex()" disabled>
            <i class="fas fa-sync me-1"></i> Verificar/Sincronizar
          </button>
        </div>
        <div class="card-body">
          <div class="row text-center" id="aiStatusLoading">
            <div class="col">
              <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
              <p class="mt-2">Verificando integridade do índice...</p>
            </div>
          </div>
          
          <div class="row text-center d-none" id="aiStatusContent">
            <div class="col-md-3 border-end">
              <h3 class="h2 text-primary" id="aiDbCount">-</h3>
              <p class="text-muted mb-0">Itens no Banco</p>
            </div>
            <div class="col-md-3 border-end">
              <h3 class="h2 text-success" id="aiIndexCount">-</h3>
              <p class="text-muted mb-0">Itens no Índice IA</p>
            </div>
            <div class="col-md-3 border-end">
              <h3 class="h2 text-warning" id="aiMissingCount">-</h3>
              <p class="text-muted mb-0">Novos (Não indexados)</p>
            </div>
            <div class="col-md-3">
              <h3 class="h2 text-danger" id="aiDeletedCount">-</h3>
              <p class="text-muted mb-0">Deletados (No índice)</p>
            </div>
          </div>
          
          <div class="alert alert-warning mt-3 d-none" id="aiSyncAlert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Atenção:</strong> O índice de IA está desatualizado. 
            <span id="aiSyncMsg"></span>
            <div class="mt-2">
              <button id="btnRunSyncAI" class="btn btn-warning me-2" onclick="confirmSyncAI()">
                <i class="fas fa-sync me-2"></i>Atualizar Índice Agora
              </button>
              <button id="btnResetAIIndex" class="btn btn-danger" onclick="confirmResetAI()">
                <i class="fas fa-trash-alt me-2"></i>Resetar e Recriar
              </button>
            </div>
            <div class="mt-3">
              <div class="progress" style="height: 20px;">
                <div id="aiProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
              </div>
              <small id="aiProgressText" class="text-muted d-block mt-1"></small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h2 class="card-title h5 m-0">Usuários da Plataforma</h2>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('admin_create_user') }}" class="mb-4">
            <div class="row g-2 align-items-end">
              <div class="col-md-5">
                <label class="form-label mb-1">Nome do admin</label>
                <input type="text" name="username" class="form-control" required />
              </div>
              <div class="col-md-5">
                <label class="form-label mb-1">Senha</label>
                <input type="text" name="password" class="form-control" required />
              </div>
              <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-success">Criar admin</button>
              </div>
            </div>
          </form>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Nome de Usuário</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>{{ user.username }}</td>
                  <td>{{ user.email }}</td>
                  <td>
                    {% if user.status == 'active' %}
                      <span class="badge bg-success">Conta ativa</span>
                    {% elif user.status == 'pending' %}
                      <span class="badge bg-warning text-dark">Aguardando aprovação</span>
                    {% elif user.status == 'inactive' %}
                      <span class="badge bg-secondary">Conta desativada</span>
                    {% elif user.status == 'canceled' %}
                      <span class="badge bg-danger">Cancelada</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ user.status or 'Desconhecido' }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ url_for('login_as_user', user_id=user.user_id) }}" class="btn btn-sm btn-primary">Entrar como</a>
                    {% if user.status == 'pending' and user.account_id %}
                      <form method="POST" action="{{ url_for('approve_account') }}" class="d-inline">
                        <input type="hidden" name="account_id" value="{{ user.account_id }}" />
                        <button type="submit" class="btn btn-sm btn-success">Aprovar conta</button>
                      </form>
                    {% endif %}

                    {% if user.status == 'active' and user.account_id %}
                      <form method="POST" action="{{ url_for('set_account_status') }}" class="d-inline">
                        <input type="hidden" name="account_id" value="{{ user.account_id }}" />
                        <input type="hidden" name="status" value="inactive" />
                        <button type="submit" class="btn btn-sm btn-outline-secondary">Desativar</button>
                      </form>
                    {% elif user.status == 'inactive' and user.account_id %}
                      <form method="POST" action="{{ url_for('set_account_status') }}" class="d-inline">
                        <input type="hidden" name="account_id" value="{{ user.account_id }}" />
                        <input type="hidden" name="status" value="active" />
                        <button type="submit" class="btn btn-sm btn-outline-success">Ativar</button>
                      </form>
                    {% endif %}
                    <form method="POST" action="{{ url_for('admin_delete_user') }}" class="d-inline">
                      <input type="hidden" name="user_id" value="{{ user.user_id }}" />
                      <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza que deseja deletar este admin?')">Deletar</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-3"></div>
</div>

<div class="mt-4 text-center">
  <div class="btn-group" role="group">
    {% if has_prev %}
    <a class="btn btn-outline-secondary" href="{{ url_for('admin_dashboard') }}?page={{ page - 1 }}&nav_stack={{ nav_stack | urlencode }}">
      ← Página Anterior
    </a>
    {% endif %}

    <span class="btn btn-outline-dark disabled">Página {{ page }}</span>

    {% if has_next %}
    <a class="btn btn-outline-primary" href="{{ url_for('admin_dashboard') }}?page={{ page + 1 }}&nav_stack={{ nav_stack | urlencode }}">
      Próxima Página →
    </a>
    {% endif %}
  </div>
</div>

{% endblock %}
