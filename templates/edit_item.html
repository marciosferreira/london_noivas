{% extends "base.html" %}
{% block title %}{{title}}{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_edit_item.css') }}" />
{% endblock %}
{% block content %}

<div class="container-fluid px-4 py-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0">
        <i class="fas fa-edit text-warning me-2"></i>{{ title }}
      </h1>
      <p class="text-muted mb-0">Edite os dados do item no inventário</p>
    </div>
    <a href="{{ request.args.get('next', url_for('inventory')) }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
  </div>

  <!-- Alert Customizar Campos -->
  <div class="alert alert-primary d-flex justify-content-between align-items-center shadow-sm" role="alert">
    <div>
      <i class="fas fa-info-circle me-2"></i>Dica: Acesse <a href="/custom_fields/item" class="alert-link">Customizar Campos</a> para criar novos ou ajustar os existentes.
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
  </div>

  <!-- Form Card -->
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-bottom">
          <h5 class="card-title mb-0 text-primary">
            <i class="fas fa-tshirt me-2"></i>Dados do Item
          </h5>
        </div>
        <div class="card-body p-4">
          <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="next" value="{{ request.args.get('next', url_for('index')) }}" />

            <div class="row g-3">
              {% for field in all_fields if field.visible %}
              <div class="col-md-6">
                <label for="{{ field.id }}" class="form-label fw-semibold text-secondary small text-uppercase mb-1">
                  {{ field.label if field.fixed else field.title }}{% if field.required %} <span class="text-danger">*</span>{% endif %}
                  
                  {% if field.id in ["title", "item_title", "description", "item_description"] %}
                  <small class="text-muted ms-1 fw-normal text-lowercase">(será gerado se vazio)</small>
                  {% endif %}
                  
                  {% if field.type == 'item_image_url' %}
                   <span class="text-danger small ms-1 fw-bold text-lowercase">(obrigatório)</span>
                  {% endif %}
                </label>

                {# Lógica de valor para Edit Item #}
                {% set valor = item.get(field.id) %}
                
                {# Fallback for legacy fields #}
                {% if valor is none and field.id == 'title' %}
                    {% set valor = item.get('item_title') %}
                {% elif valor is none and field.id == 'description' %}
                    {% set valor = item.get('item_description') %}
                {% endif %}

                {% if valor is none %}{% set valor = '' %}{% endif %}
                
                {% if (field.id == "valor" or field.id == "item_value") and not valor %}
                  {% set valor = "0" %}
                {% endif %}

                {% if field.type == "text" or field.type == "item_obs" or field.type == "item_custom_id" or field.type == "item_description" or field.type == "item_title" %}
                <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}" value="{{ valor }}" {% if field.required %}required{% endif %} {% if field.type == 'item_custom_id' or field.id == 'item_custom_id' %}readonly style="background-color: #e9ecef; cursor: not-allowed;" title="Não é possível alterar este ID"{% endif %} />

                {% elif field.type == "value" or field.type == "item_value" or field.type == "number" %}
                <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="text" class="form-control campo-monetario" id="{{ field.id }}" name="{{ field.id }}" value="{{ valor }}" {% if field.required %}required{% endif %} />
                </div>

                {% elif field.type == 'date' %}
                <input type="date" class="form-control" id="{{ field.id }}" name="{{ field.id }}" value="{{ valor }}" {% if field.required %}required{% endif %} />

                {% elif field.type == 'dropdown' %}
                <select class="form-select" id="{{ field.id }}" name="{{ field.id }}" {% if field.required %}required{% endif %}>
                  <option value="">Selecione</option>
                  {% for option in field.options %}
                  <option value="{{ option }}" {% if valor == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>

                {% elif field.type == 'item_image_url' %}
                <div class="card bg-light border-dashed p-3 text-center">
                    <div class="mb-2">
                        <img id="item-image"
                        src="{{ valor if valor and valor != 'N/A' else url_for('static', filename='item-placeholder.png') }}"
                        class="img-fluid rounded shadow-sm" style="max-height: 150px;" />
                    </div>
                    <input type="text" name="item_image_url" id="image-url-input" value="{{ valor if valor != 'N/A' else '' }}" style="opacity: 0; position: absolute; left: -9999px" />
                    <div class="d-grid gap-2 col-8 mx-auto">
                        <label class="btn btn-outline-primary btn-sm" for="image_file">
                            <i class="fas fa-upload me-1"></i> Escolher Foto
                        </label>
                        <input type="file" class="d-none" id="image_file" name="image_file" {% if field.required %}data-required="true"{% endif %} />
                        <button type="button" onclick="removeImage()" id="remove-btn" class="btn btn-outline-danger btn-sm" style="{{ 'display: block;' if valor and valor != 'N/A' else 'display: none;' }}">
                            <i class="fas fa-trash me-1"></i> Remover
                        </button>
                    </div>
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            
            <!-- Checkboxes Específicos de Edição -->
            <div class="row mt-4 border-top pt-3">
                <div class="col-md-12">
                    <div class="d-flex flex-wrap gap-4 justify-content-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="featured" name="featured" {% if item.get('featured') %}checked{% endif %}>
                            <label class="form-check-label" for="featured">Destaque na Home?</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="update_all_transactions" name="update_all_transactions">
                            <label class="form-check-label" for="update_all_transactions">Atualizar em todas as transações?</label>
                        </div>
                        <div class="w-100"></div>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="occasion_madrinha" name="occasion_madrinha" {% if item.get('occasion_madrinha') %}checked{% endif %}>
                                <label class="form-check-label" for="occasion_madrinha">Madrinha</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="occasion_formatura" name="occasion_formatura" {% if item.get('occasion_formatura') %}checked{% endif %}>
                                <label class="form-check-label" for="occasion_formatura">Formatura</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="occasion_gala" name="occasion_gala" {% if item.get('occasion_gala') %}checked{% endif %}>
                                <label class="form-check-label" for="occasion_gala">Gala</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="occasion_debutante" name="occasion_debutante" {% if item.get('occasion_debutante') %}checked{% endif %}>
                                <label class="form-check-label" for="occasion_debutante">Debutante</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="occasion_convidada" name="occasion_convidada" {% if item.get('occasion_convidada') %}checked{% endif %}>
                                <label class="form-check-label" for="occasion_convidada">Convidada</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="occasion_mae_dos_noivos" name="occasion_mae_dos_noivos" {% if item.get('occasion_mae_dos_noivos') %}checked{% endif %}>
                                <label class="form-check-label" for="occasion_mae_dos_noivos">Mãe dos Noivos</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="occasion_noiva" name="occasion_noiva" {% if item.get('occasion_noiva') %}checked{% endif %}>
                                <label class="form-check-label" for="occasion_noiva">Noiva</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="occasion_civil" name="occasion_civil" {% if item.get('occasion_civil') %}checked{% endif %}>
                                <label class="form-check-label" for="occasion_civil">Civil</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                <a href="{{ request.args.get('next', url_for('inventory')) }}" class="btn btn-light me-2 border">Cancelar</a>
                <button type="submit" class="btn btn-warning px-4 d-flex align-items-center gap-2">
                    <i class="fas fa-save"></i>
                    <span>Salvar Alterações</span>
                    <div class="spinner-border spinner-border-sm text-dark" role="status" style="display: none;"></div>
                </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // --- Funções de Imagem ---
  function removeImage() {
    document.getElementById('item-image').src = "{{ url_for('static', filename='item-placeholder.png') }}";
    document.getElementById('image-url-input').value = 'DELETE_IMAGE';
    document.getElementById('remove-btn').style.display = 'none';
    document.getElementById('image_file').value = '';
  }
  
  document.getElementById('image_file')?.addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      document.getElementById('item-image').src = e.target.result;
      document.getElementById('remove-btn').style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  // --- Funções Monetárias ---
  function formatarCampoMonetario(input) {
    input.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 12) value = value.slice(0, 12);
      if (!value) {
        input.value = '';
        return;
      }
      const floatValue = parseFloat(value) / 100;
      input.value = floatValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    });

    const raw = input.value.replace(/\D/g, '');
    if (raw) {
      const floatValue = parseFloat(raw) / 100;
      input.value = floatValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
  }

  // --- Inicialização ---
  document.addEventListener('DOMContentLoaded', () => {
    // Inicializar Formatação Monetária
    const campoValor = document.getElementById('item_value');
    if (campoValor) formatarCampoMonetario(campoValor);
    
    // Formatar outros campos monetários se houver
    document.querySelectorAll('.campo-monetario').forEach(el => {
        if(el.id !== 'item_value') formatarCampoMonetario(el);
    });
  });
</script>
{% endblock %}
