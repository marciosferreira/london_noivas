{% extends "base.html" %}
{% block title %}{{title}}{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_edit_item.css') }}" />
{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">{{title}}</h1>

  <a href="{{ request.args.get('next') }}" class="exit-link">
  <i class="fas fa-sign-out-alt me-2"></i>
  Sair sem Finalizar
</a>



  </div>


  <form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="next" value="{{ request.args.get('next', url_for('index')) }}" />
    <div class="row row-cols-1 row-cols-md-3 g-4">
     {% for field in all_fields if field.visible %}
{% set key_values = item.key_values if item.get('key_values') else {} %}
{% set value = item.get(field.id) if field.fixed else key_values.get(field.id, '') %}


  <div class="col d-flex">
    <div class="bg-light shadow-sm rounded p-3 border w-100 h-100 d-flex flex-column justify-content-center">
      <label for="{{ field.id }}" class="form-label fw-semibold">
        {{ field.label }}{% if field.required %} *{% endif %}
      </label>

      {% if field.type in ['text', 'value', 'item_custom_id', 'item_description', 'item_obs', 'item_value'] %}
        <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
               value="{{ value }}" {% if field.required %}required{% endif %} />

      {% elif field.type == 'number' %}
        <input type="number" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
               value="{{ value }}" {% if field.required %}required{% endif %} />

      {% elif field.type == 'date' %}
        <input type="date" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
               value="{{ value }}" {% if field.required %}required{% endif %} />

      {% elif field.type in ['dropdown', 'transaction_status'] %}
        <select class="form-select" id="{{ field.id }}" name="{{ field.id }}" {% if field.required %}required{% endif %}>
          <option value="">Selecione</option>
          {% for option in field.options %}
            <option value="{{ option }}" {% if option == value %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>

      {% elif field.type == 'item_image_url' %}
        <div class="text-center mb-2">
          <img id="item-image"
               src="{{ item.item_image_url if item.item_image_url and item.item_image_url != 'N/A' else url_for('static', filename='item-placeholder.png') }}"
               style="max-width: 150px;" />
          <input type="text" name="item_image_url" id="image-url-input"
                 value="{{ item.item_image_url if item.item_image_url != 'N/A' else '' }}"
                 style="opacity: 0; position: absolute; left: -9999px" />
          <button type="button" onclick="removeImage()" id="remove-btn"
                  class="btn btn-outline-danger btn-sm mt-2"
                  style="{{ 'display: block;' if item.item_image_url and item.item_image_url != 'N/A' else 'display: none;' }}">
            Excluir imagem
          </button>
        </div>
        <input type="file" class="form-control" id="image_file" name="image_file"
               {% if field.required %}data-required="true"{% endif %} />
      {% endif %}
    </div>
  </div>
{% endfor %}

    </div>
<br>
    <div class="row">
      <div class="col text-center">
        <div class="d-inline-flex align-items-center gap-2 mb-3">
          <input type="checkbox" id="update_all_transactions" name="update_all_transactions" />

          <label for="update_all_transactions" class="form-check-label">Alterar em todas as transa√ß√µes existentes?</label>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-center mt-3">
      <button type="submit" class="btn btn-success btn-submit">Salvar</button>
    </div>

  </form>
</div>

{% endblock %}

{% block scripts %}
<script>
  function removeImage() {
    const imageInput = document.getElementById('image-url-input');
    const imageElement = document.getElementById('item-image');
    const removeButton = document.getElementById('remove-btn');

    if (imageInput) {
      imageInput.value = 'DELETE_IMAGE';
    }

    if (imageElement) {
      imageElement.src = "{{ url_for('static', filename='item-placeholder.png') }}";
    }

    if (removeButton) {
      removeButton.style.display = 'none';
    }
  }

  document.getElementById('image_file').addEventListener('change', function (event) {
    const file = event.target.files[0];
    const imageElement = document.getElementById('item-image');
    const removeButton = document.getElementById('remove-btn');
    const hiddenInput = document.getElementById('image-url-input');

    if (file && imageElement) {
      const reader = new FileReader();
      reader.onload = function (e) {
        imageElement.src = e.target.result;
        imageElement.style.display = 'block';
        imageElement.style.margin = '0 auto';
        if (removeButton) {
          removeButton.style.display = 'block';
        }
      };
      reader.readAsDataURL(file);

      // ‚úÖ Limpa instru√ß√£o de exclus√£o, j√° que uma nova imagem foi selecionada
      if (hiddenInput && hiddenInput.value === 'DELETE_IMAGE') {
        hiddenInput.value = '';
      }
    }
  });


</script>


<script>
  function formatarCampoMonetario(input) {
    input.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');

      if (!value) {
        e.target.value = '';
        return;
      }

      let intValue = parseInt(value, 10);
      let floatValue = intValue / 100;

      e.target.value = floatValue.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const campo = document.getElementById('item_value');
    if (campo) {
      // üü° Formata valor inicial (ex: "123.45" ‚Üí "123,45")
      let valorAtual = campo.value.replace('.', ',');
      campo.value = valorAtual;

      // Ativa m√°scara ao digitar
      formatarCampoMonetario(campo);
    }
  });
</script>



<script>
    // Valida√ß√£o obrigat√≥ria da imagem (para edi√ß√£o)
    document.querySelector('form')?.addEventListener('submit', function (e) {
      const imageFile = document.getElementById('image_file');
      const hiddenImageUrl = document.getElementById('image-url-input');

      // Essa flag ser√° criada com base no all_fields
      let imageRequired = false;

      {% for field in all_fields %}
        {% if field.type == 'image_url' and field.required %}
          imageRequired = true;
        {% endif %}
      {% endfor %}

      if (imageRequired) {
        const noNewImage = !imageFile || imageFile.files.length === 0;
        const noExistingImage = !hiddenImageUrl || hiddenImageUrl.value === '' || hiddenImageUrl.value === 'N/A' || hiddenImageUrl.value === 'DELETE_IMAGE';

        if (noNewImage && noExistingImage) {
          e.preventDefault();
          alert('A imagem √© obrigat√≥ria. Por favor, selecione uma imagem.');
          imageFile.focus();
        }
      }
    });

</script>
{% endblock %}
