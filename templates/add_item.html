{% extends "base.html" %}
{% block title %}{{title}}{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_edit_item.css') }}" />
{% endblock %}
{% block content %}

<div class="container-fluid px-4 py-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0">
        <i class="fas fa-plus-circle text-success me-2"></i>{{ title }}
      </h1>
      <p class="text-muted mb-0">Cadastre um novo item no inventário</p>
    </div>
    <a href="{{ url_for('inventory') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Voltar para Inventário
    </a>
  </div>

  <!-- Form Card -->
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-bottom">
          <h5 class="card-title mb-0 text-primary">
            <i class="fas fa-tshirt me-2"></i>Dados do Item
          </h5>
        </div>
        <div class="card-body p-4">
          <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="next" value="{{ request.args.get('next', url_for('index')) }}" />

            <div class="row g-3">
              {% for field in all_fields if field.visible and field.id != 'category_raw' and field.id not in ["cor_base", "cor_comercial"] %}
              <div class="col-md-6">
                <label for="{{ field.id }}" class="form-label fw-semibold text-secondary small text-uppercase mb-1">
                  {{ field.label if field.fixed else field.title }}{% if field.required %} <span class="text-danger">*</span>{% endif %}
                  
                  {% if field.id in ["title", "item_title", "description", "item_description", "item_custom_id"] %}
                  <small class="text-muted ms-1 fw-normal text-lowercase">(será gerado se vazio)</small>
                  {% endif %}
                  
                  {% if field.type == 'item_image_url' %}
                   <span class="text-danger small ms-1 fw-bold text-lowercase">(obrigatório)</span>
                  {% endif %}
                </label>

                {% set valor = item.get(field.id, '') %}
                
                {% if (field.id == "valor" or field.id == "item_value") and not valor %}
                  {% set valor = "0" %}
                {% endif %}

                {% set label_text = (field.label if field.fixed else field.title) %}
                {% set is_color_field = field.id in ["cor","color","item_cor","item_color"] or (label_text and label_text|lower == "cor") %}
                {% set is_size_field = field.id in ["tamanho","size","item_tamanho","item_size"] or (label_text and label_text|lower == "tamanho") %}

                {% if is_color_field and color_pairs %}
                {% set current_name = item.get('cor_comercial') or valor|string|trim %}
                {% set current_base = item.get('cor_base') or '' %}
                <select class="form-select" id="{{ field.id }}" name="{{ field.id }}" {% if field.required %}required{% endif %}>
                  <option value="">Selecione</option>
                  {% for c in color_pairs %}
                  {% set opt_value = c.name ~ '||' ~ c.base %}
                  {% set opt_label = c.name ~ (c.base and (' (' ~ c.base ~ ')') or '') %}
                  {% set name_norm = current_name|string|trim|lower %}
                  {% set base_norm = current_base|string|trim|lower %}
                  {% set c_name_norm = c.name|string|trim|lower %}
                  {% set c_base_norm = c.base|string|trim|lower %}
                  <option value="{{ opt_value }}" {% if name_norm == c_name_norm and base_norm == c_base_norm %}selected{% endif %}>{{ opt_label }}</option>
                  {% endfor %}
                </select>

                {% elif is_size_field and size_options %}
                {% set raw_sizes = (valor|string) %}
                {% set sizes_text = raw_sizes|replace(' e ', ',')|replace('/', ',') %}
                {% set size_parts = sizes_text.split(',') %}
                {% set ns = namespace(selected=[]) %}
                {% for part in size_parts %}
                  {% set p = part|string|trim %}
                  {% if p %}
                    {% set ns.selected = ns.selected + [p|lower] %}
                  {% endif %}
                {% endfor %}
                <input type="hidden" name="{{ field.id }}" value="">
                <select class="form-select" id="{{ field.id }}" name="{{ field.id }}" multiple {% if field.required %}required{% endif %}>
                  {% for s in size_options %}
                  {% set s_norm = s|string|trim|lower %}
                  <option value="{{ s }}" {% if s_norm in ns.selected %}selected{% endif %}>{{ s }}</option>
                  {% endfor %}
                </select>

                {% elif field.type == "text" or field.type == "item_obs" %}
                <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}" value="{{ valor }}" {% if field.required %}required{% endif %} />

                {% elif field.type == "value" or field.type == "item_value" or field.type == "number" %}
                <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="text" class="form-control campo-monetario" id="{{ field.id }}" name="{{ field.id }}" value="{{ valor }}" {% if field.required %}required{% endif %} />
                </div>

                {% elif field.type == 'date' %}
                <input type="date" class="form-control" id="{{ field.id }}" name="{{ field.id }}" value="{{ valor }}" {% if field.required %}required{% endif %} />

                {% elif field.type == 'dropdown' %}
                <select class="form-select" id="{{ field.id }}" name="{{ field.id }}" {% if field.required %}required{% endif %}>
                  <option value="">Selecione</option>
                  {% for option in field.options %}
                  <option value="{{ option }}" {% if valor == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>

                {% elif field.type == 'item_image_url' %}
                <div class="card bg-light border-dashed p-3 text-center">
                    <div class="mb-2">
                        <img id="item-image"
                        src="{{ valor if valor and valor != 'N/A' else url_for('static', filename='item-placeholder.png') }}"
                        class="img-fluid rounded shadow-sm" style="max-height: 150px;" />
                    </div>
                    <div id="image-thumbs" class="d-flex flex-wrap gap-2 justify-content-center mb-2"></div>
                    <input type="text" name="item_image_url" id="image-url-input" value="{{ valor if valor != 'N/A' else '' }}" style="opacity: 0; position: absolute; left: -9999px" />
                    <div class="d-grid gap-2 col-8 mx-auto">
                        <label class="btn btn-outline-primary btn-sm" for="image_file">
                            <i class="fas fa-upload me-1"></i> Escolher Foto
                        </label>
                        <input type="file" class="d-none" id="image_file" name="image_file" multiple {% if field.required %}data-required="true"{% endif %} />
                        <button type="button" onclick="removeImage()" id="remove-btn" class="btn btn-outline-danger btn-sm" style="{{ 'display: block;' if valor and valor != 'N/A' else 'display: none;' }}">
                            <i class="fas fa-trash me-1"></i> Remover
                        </button>
                    </div>
                </div>

               {% elif field.type in ["item_custom_id", "item_description"] %}
                <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
                  value="{{ item.get(field.id, '') }}"
                  {% if field.required %}required{% endif %} />
                {% endif %}
              </div>
              {% endfor %}
            </div>

            <div class="row mt-4 border-top pt-3">
              <div class="col-md-12">
                <h6 class="mb-3">Ocasiões</h6>
                <div class="d-flex flex-wrap gap-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="occasion_madrinha" name="occasion_madrinha">
                    <label class="form-check-label" for="occasion_madrinha">Madrinha</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="occasion_formatura" name="occasion_formatura">
                    <label class="form-check-label" for="occasion_formatura">Formatura</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="occasion_gala" name="occasion_gala">
                    <label class="form-check-label" for="occasion_gala">Gala</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="occasion_debutante" name="occasion_debutante">
                    <label class="form-check-label" for="occasion_debutante">Debutante</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="occasion_convidada" name="occasion_convidada">
                    <label class="form-check-label" for="occasion_convidada">Convidada</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="occasion_mae_dos_noivos" name="occasion_mae_dos_noivos">
                    <label class="form-check-label" for="occasion_mae_dos_noivos">Mãe dos Noivos</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="occasion_noiva" name="occasion_noiva">
                    <label class="form-check-label" for="occasion_noiva">Noiva</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="occasion_civil" name="occasion_civil">
                    <label class="form-check-label" for="occasion_civil">Civil</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                <a href="{{ url_for('inventory') }}" class="btn btn-light me-2 border">Cancelar</a>
                <button type="submit" class="btn btn-success px-4 d-flex align-items-center gap-2">
                    <i class="fas fa-check"></i>
                    <span>Salvar Item</span>
                    <div class="spinner-border spinner-border-sm text-light" role="status" style="display: none;"></div>
                </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal plano -->
<div class="modal fade" id="limitModal" tabindex="-1" aria-labelledby="limitModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="limitModalLabel">Limite de Itens Atingido</h5>
      </div>
      <div class="modal-body text-center">
        Você atingiu o número máximo de <strong>itens cadastrados</strong> permitido pelo seu plano atual.
        <br />
      </div>
      <div class="modal-footer justify-content-center">
        <a href="{{ url_for('adjustments') }}" class="btn btn-primary btn-lg">Atualizar Plano</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // --- Funções de Imagem ---
  function removeImage() {
    document.getElementById('item-image').src = "{{ url_for('static', filename='item-placeholder.png') }}";
    document.getElementById('image-url-input').value = 'DELETE_IMAGE';
    const thumbs = document.getElementById('image-thumbs');
    if (thumbs) thumbs.innerHTML = '';
    document.getElementById('remove-btn').style.display = 'none';
    document.getElementById('image_file').value = '';
  }
  
  document.getElementById('image_file')?.addEventListener('change', function (e) {
    const files = Array.from(e.target.files || []);
    const thumbs = document.getElementById('image-thumbs');
    if (thumbs) thumbs.innerHTML = '';
    if (!files.length) return;
    if (files.length > 4) {
      alert('Limite de fotos por item: no máximo 4.');
      e.target.value = '';
      document.getElementById('remove-btn').style.display = 'none';
      return;
    }

    document.getElementById('remove-btn').style.display = 'block';

    files.forEach((file, idx) => {
      const reader = new FileReader();
      reader.onload = function (ev) {
        const src = ev.target.result;
        const wrapper = document.createElement('label');
        wrapper.className = 'd-inline-flex align-items-center gap-2 border rounded px-2 py-1 bg-white';
        wrapper.style.cursor = 'pointer';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'main_image_index';
        radio.value = String(idx);
        radio.className = 'form-check-input m-0';
        if (idx === 0) radio.checked = true;
        radio.addEventListener('change', () => {
          document.getElementById('item-image').src = src;
        });

        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Foto';
        img.style.height = '44px';
        img.style.width = '44px';
        img.style.objectFit = 'cover';
        img.className = 'rounded';

        wrapper.appendChild(radio);
        wrapper.appendChild(img);
        if (thumbs) thumbs.appendChild(wrapper);

        if (idx === 0) {
          document.getElementById('item-image').src = src;
        }
      };
      reader.readAsDataURL(file);
    });
  });

  // --- Funções Monetárias ---
  function formatarCampoMonetario(input) {
    function normalizarMonetarioParaNumero(raw) {
      let s = (raw || '').toString().trim();
      if (!s) return null;

      s = s.replace(/\s+/g, '').replace(/^R\$\s*/i, '');
      s = s.replace(/[^\d.,]/g, '');
      if (!s) return null;

      if (s.includes(',')) {
        const parts = s.split(',');
        const intPart = parts.slice(0, -1).join(',').replace(/[.,]/g, '');
        let decPart = (parts[parts.length - 1] || '').replace(/\D/g, '').slice(0, 2);
        if (decPart.length === 1) decPart = `${decPart}0`;
        if (decPart.length === 0) decPart = '00';
        const n = Number(`${intPart || '0'}.${decPart}`);
        return Number.isFinite(n) ? n : null;
      }

      if (s.includes('.')) {
        const dotParts = s.split('.');
        if (dotParts.length === 2 && dotParts[1] && dotParts[1].length <= 2) {
          const intPart = (dotParts[0] || '').replace(/\D/g, '');
          let decPart = (dotParts[1] || '').replace(/\D/g, '').slice(0, 2);
          if (decPart.length === 1) decPart = `${decPart}0`;
          if (decPart.length === 0) decPart = '00';
          const n = Number(`${intPart || '0'}.${decPart}`);
          return Number.isFinite(n) ? n : null;
        }

        const digits = s.replace(/\D/g, '');
        if (!digits) return null;
        const n = Number(`${digits}.00`);
        return Number.isFinite(n) ? n : null;
      }

      const digits = s.replace(/\D/g, '');
      if (!digits) return null;
      const n = Number(`${digits}.00`);
      return Number.isFinite(n) ? n : null;
    }

    function aplicarFormatacao() {
      const n = normalizarMonetarioParaNumero(input.value);
      if (n === null) {
        return;
      }
      input.value = n.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    function formatarEmTempoReal() {
      let s = (input.value || '').toString();
      s = s.replace(/\s+/g, '').replace(/^R\$\s*/i, '');
      const digits = s.replace(/\D/g, '');
      if (!digits) {
        input.value = '';
        return;
      }
      let intPart = digits.slice(0, -2);
      let decPart = digits.slice(-2);
      if (decPart.length === 1) decPart = `0${decPart}`;
      intPart = intPart.replace(/^0+(?=\d)/, '');
      if (intPart === '') intPart = '0';
      const intComMilhar = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      input.value = `${intComMilhar},${decPart}`;
      if (document.activeElement === input && typeof input.setSelectionRange === 'function') {
        const end = input.value.length;
        input.setSelectionRange(end, end);
      }
    }

    function validarFormatoBR() {
      const v = (input.value || '').trim();
      if (!v) {
        input.setCustomValidity('');
        input.classList.remove('is-invalid');
        return true;
      }
      const regexBR = /^(?:\d{1,3}(?:\.\d{3})+|\d+),\d{2}$/;
      if (regexBR.test(v)) {
        input.setCustomValidity('');
        input.classList.remove('is-invalid');
        return true;
      }
      const n = normalizarMonetarioParaNumero(v);
      if (n !== null) {
        input.value = n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        input.setCustomValidity('');
        input.classList.remove('is-invalid');
        return true;
      }
      input.setCustomValidity('Use vírgula para centavos. Ex: 1.000,00 ou 1000,00');
      input.classList.add('is-invalid');
      return false;
    }

    input.addEventListener('input', formatarEmTempoReal);
    input.addEventListener('blur', () => {
      formatarEmTempoReal();
      validarFormatoBR();
    });
    if (input.value) aplicarFormatacao();

    const form = input.closest('form');
    if (form) {
      form.addEventListener('submit', (e) => {
        if (!validarFormatoBR()) {
          e.preventDefault();
          input.focus();
        }
      });
    }
  }

  // --- Funções Auxiliares ---
  function gerarCodigoItem() {
    const campo = document.getElementById('item_custom_id');
    if (campo) {
      const uuid = crypto.randomUUID().replace(/-/g, '').substring(0, 12);
      campo.value = uuid;
      campo.dispatchEvent(new Event('input'));
    }
  }

  // --- Inicialização ---
  document.addEventListener('DOMContentLoaded', () => {
    // Inicializar Formatação Monetária
    const campoValor = document.getElementById('item_value');
    if (campoValor) formatarCampoMonetario(campoValor);
  });
</script>
{% endblock %}
