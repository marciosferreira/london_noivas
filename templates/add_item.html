{% extends "base.html" %}
{% block title %}Adicionar Item{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_edit_item.css') }}" />
{% endblock %}
{% block content %}

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Adicionar Item</h1>
    <a href="{{ request.args.get('next', url_for('index')) }}" class="cancel-link">Cancelar</a>
  </div>

  <div class="alert alert-primary d-flex justify-content-between align-items-center" role="alert">
    <div>
      Dica: Acesse <a href="/custom_fields/item" class="alert-link">Customizar Campos</a> para criar novos ou ajustar os existentes.
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
  </div>


  <form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="next" value="{{ request.args.get('next', url_for('index')) }}" />

    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for field in all_fields if field.visible %}
      <div class="col d-flex">
        <div class="bg-light shadow-sm rounded p-3 border w-100 h-100 d-flex flex-column justify-content-center">
          <label for="{{ field.id }}" class="form-label fw-semibold">
            {{ field.label if field.fixed else field.title }}{% if field.required %} *{% endif %}
          </label>



          {% if field.type in ['string', 'value'] %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ item.get(field.id, '') }}" {% if field.required %}required{% endif %} />


          {% elif field.type == 'number' %}
            <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ item.get(field.id, '') }}" {% if field.required %}required{% endif %} />

          {% elif field.type == 'date' %}
            <input type="date" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
              value="{{ item.get(field.id, '') }}" {% if field.required %}required{% endif %} />

          {% elif field.type == 'dropdown' %}
            <select class="form-select" id="{{ field.id }}" name="{{ field.id }}" {% if field.required %}required{% endif %}>
              <option value="">Selecione</option>
              {% for option in field.options %}
                <option value="{{ option }}" {% if item.get(field.id) == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>

          {% elif field.type == 'image_url' %}
            <div class="text-center mb-2">
              <img id="item-image"
                   src="{{ item.item_image_url if item.item_image_url and item.item_image_url != 'N/A' else url_for('static', filename='item-placeholder.png') }}"
                   style="max-width: 150px;" />
              <input type="text" name="item_image_url" id="image-url-input"
                     value="{{ item.item_image_url if item.item_image_url != 'N/A' else '' }}"
                     style="opacity: 0; position: absolute; left: -9999px" />
              <button type="button" onclick="removeImage()" id="remove-btn"
                      class="btn btn-outline-danger btn-sm mt-2"
                      style="{{ 'display: block;' if item.item_image_url and item.item_image_url != 'N/A' else 'display: none;' }}">
                Excluir imagem
              </button>
            </div>
            <input type="file" class="form-control" id="image_file" name="image_file"
              {% if field.required %}data-required="true"{% endif %} />
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>


    <div class="d-flex justify-content-center mt-4">
      <button type="submit" class="btn btn-success btn-submit">Salvar</button>
    </div>

  </form>
</div>



{% endblock %}

{% block scripts %}
<script>
  function removeImage() {
    document.getElementById('item-image').src = "{{ url_for('static', filename='item-placeholder.png') }}";
    document.getElementById('image-url-input').value = 'DELETE_IMAGE';
    document.getElementById('remove-btn').style.display = 'none';
    document.getElementById('image_file').value = '';
  }

  document.getElementById('image_file')?.addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      document.getElementById('item-image').src = e.target.result;
      document.getElementById('remove-btn').style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

</script>


<script>
  function formatarCampoMonetario(input) {
    input.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');

      // Limita a 12 dígitos para evitar problemas com números muito grandes
      if (value.length > 12) value = value.slice(0, 12);

      if (!value) {
        input.value = '';
        return;
      }

      const floatValue = parseFloat(value) / 100;
      input.value = floatValue.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    });

    // Formata valor já existente ao carregar a página
    const raw = input.value.replace(/\D/g, '');
    if (raw) {
      const floatValue = parseFloat(raw) / 100;
      input.value = floatValue.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const campoValor = document.getElementById('item_value');
    if (campoValor) formatarCampoMonetario(campoValor);
  });
</script>


{% endblock %}
