{% extends "base.html" %}

{% block title %}Editar Prova{% endblock %}

{% block head %}
<!-- Bootstrap CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
  crossorigin="anonymous"
/>

<!-- FontAwesome -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>

<style>
  .autocomplete-container {
    position: relative;
  }
  .autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .autocomplete-item {
    cursor: pointer;
    transition: background-color 0.2s;
    padding: 8px 10px;
  }
  .autocomplete-item:hover {
    background-color: #f8f9fa;
  }
  .item-suggestion {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: nowrap;
  }
  .item-suggestion-thumb {
    width: 42px;
    height: 42px;
    flex: 0 0 42px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.08);
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .item-suggestion-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .item-suggestion-text {
    min-width: 0;
    display: flex;
    flex-direction: column;
  }
  .item-suggestion-id {
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.1;
  }
  .item-suggestion-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.1;
  }
  .item-suggestion-sub {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.1;
  }
  .card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
  }
  .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
  }
  .fitting-items-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  .fitting-item-card {
    width: 140px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0">
        <i class="fas fa-edit text-warning me-2"></i>Editar Prova
      </h1>
      <p class="text-muted mb-0">Modifique os dados da prova de roupa</p>
    </div>
    <a href="{{ url_for('agenda') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Voltar para Agenda
    </a>
  </div>

  <!-- Form Card -->
  <div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-user-clock me-2"></i>Dados da Prova
          </h5>
        </div>
        <div class="card-body">
          <form method="POST">
            <input type="hidden" name="items_json" id="items_json" value="{{ (initial_items_json or '[]')|e }}">
            <div class="row g-3">
              <!-- Data -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-calendar me-1"></i>Data <span class="text-danger">*</span>
                </label>
                <input type="date" class="form-control" name="date_iso" id="date_iso" value="{{ fitting.date_local }}" required>
              </div>

              <!-- Hora -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-clock me-1"></i>Hora
                </label>
                <select class="form-select" name="time_local" id="time_local" data-current-time="{{ fitting.time_local or '' }}">
                  <option value="">Carregando hor치rios...</option>
                </select>
                <div class="form-text">Os hor치rios seguem a configura칞칚o do agendamento</div>
              </div>

              <!-- Dura칞칚o -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-stopwatch me-1"></i>Dura칞칚o (min)
                </label>
                <input type="number" min="1" step="1" class="form-control" name="duration_minutes" value="{{ default_duration_minutes or fitting.duration_minutes or 60 }}">
                <div class="form-text">A dura칞칚o influencia o bloqueio de slots</div>
              </div>

              <!-- Cliente ID -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-hashtag me-1"></i>ID do Cliente
                </label>
                <div class="autocomplete-container">
                  <input type="text" class="form-control" name="client_id" id="client_id" value="{{ fitting.client_id }}" placeholder="Digite o ID do cliente">
                  <div id="client_id_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="form-text">Campo auxiliar para busca</div>
              </div>

              <!-- Nome do Cliente -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-user me-1"></i>Nome do Cliente
                </label>
                <div class="autocomplete-container">
                  <input type="text" class="form-control" name="client_name" id="client_name" value="{{ fitting.client_name }}" placeholder="Digite para buscar cliente">
                  <div id="client_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="form-text">Campo auxiliar para busca</div>
              </div>

              <!-- Email do Cliente -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-envelope me-1"></i>Email do Cliente
                </label>
                <input type="email" class="form-control" name="client_email" value="{{ fitting.client_email or '' }}" placeholder="ex: cliente@email.com">
              </div>

              <!-- Telefone do Cliente -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-phone me-1"></i>Telefone do Cliente
                </label>
                <input type="text" class="form-control" name="client_phone" value="{{ fitting.client_phone or '' }}" placeholder="WhatsApp/Telefone">
              </div>

              <div class="col-12">
                <label class="form-label">
                  <i class="fas fa-person-dress me-1"></i>Vestidos
                </label>
                <div id="fitting_items_list" class="fitting-items-grid"></div>
                <div class="form-text">Adicione ou remova vestidos deste agendamento</div>
              </div>

              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-barcode me-1"></i>Buscar por ID/c칩digo
                </label>
                <div class="autocomplete-container">
                  <input type="text" class="form-control" name="item_id_lookup" id="item_id" value="" placeholder="Digite o ID/c칩digo do item">
                  <div id="item_id_suggestions" class="autocomplete-suggestions"></div>
                </div>
              </div>

              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-tag me-1"></i>Buscar por t칤tulo
                </label>
                <div class="autocomplete-container">
                  <input type="text" class="form-control" name="item_description_lookup" id="item_description" value="" placeholder="Digite para buscar t칤tulo">
                  <div id="item_description_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="d-flex justify-content-end mt-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" id="btn_add_item">
                    <i class="fas fa-plus me-1"></i>Adicionar vestido
                  </button>
                </div>
              </div>

              <!-- Status -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-info-circle me-1"></i>Status
                </label>
                <select class="form-select" name="status">
                  <option value="Pendente" {% if fitting.status == 'Pendente' %}selected{% endif %}>Pendente</option>
                  <option value="Confirmado" {% if fitting.status == 'Confirmado' %}selected{% endif %}>Confirmado</option>
                  <option value="Cancelado" {% if fitting.status == 'Cancelado' %}selected{% endif %}>Cancelado</option>
                </select>
              </div>

              <!-- Observa칞칫es -->
              <div class="col-12">
                <label class="form-label">
                  <i class="fas fa-sticky-note me-1"></i>Observa칞칫es (opcional)
                </label>
                <textarea class="form-control" name="notes" rows="3" placeholder="Detalhes importantes sobre a prova">{{ fitting.notes or '' }}</textarea>
              </div>

              <!-- Reenviar e-mail -->
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="send_email_on_save" name="send_email_on_save">
                  <label class="form-check-label" for="send_email_on_save">
                    Enviar e-mail ao salvar (conforme o status)
                  </label>
                </div>
                <div class="form-text">Somente envia se houver e-mail preenchido.</div>
              </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i>Atualizar Prova
              </button>
              <a href="{{ url_for('agenda') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-2"></i>Cancelar
              </a>
              <form method="post" action="{{ url_for('delete_fitting', fitting_id=fitting.fitting_id) }}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta prova?')">
                <button type="submit" class="btn btn-danger">
                  <i class="fas fa-trash me-2"></i>Excluir
                </button>
              </form>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- FontAwesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<!-- Bootstrap Bundle -->
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-A3xORN3yEh9NTBI69AsVZqg0vszNvB4LaU6gq3p0eNmKUy5OWyE4hzJxKr5oUqvN"
  crossorigin="anonymous"
></script>

<script>
  (function() {
    const dateInput = document.getElementById('date_iso');
    const timeSelect = document.getElementById('time_local');
    if (!dateInput || !timeSelect) return;

    const currentTime = (timeSelect.getAttribute('data-current-time') || '').trim();

    function setTimeOptions(options, placeholder) {
      timeSelect.innerHTML = '';
      const first = document.createElement('option');
      first.value = '';
      first.textContent = placeholder || 'Selecione';
      timeSelect.appendChild(first);

      for (const t of options) {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        timeSelect.appendChild(opt);
      }
    }

    function normalizeSlots(slots) {
      const set = new Set();
      for (const s of slots) {
        const t = (s || '').toString().trim();
        if (t) set.add(t);
      }
      return Array.from(set).sort();
    }

    async function refreshTimes() {
      const date = (dateInput.value || '').trim();
      if (!date) {
        setTimeOptions([], 'Selecione uma data');
        return;
      }

      setTimeOptions([], 'Carregando hor치rios...');
      try {
        const resp = await fetch(`/api/admin/available_slots?date=${encodeURIComponent(date)}`, {
          headers: { 'Accept': 'application/json' },
        });
        if (!resp.ok) {
          setTimeOptions(currentTime ? [currentTime] : [], 'Sem hor치rios dispon칤veis');
          if (currentTime) timeSelect.value = currentTime;
          return;
        }
        const data = await resp.json();
        const slots = normalizeSlots(Array.isArray(data.slots) ? data.slots : []);
        if (currentTime && !slots.includes(currentTime)) slots.unshift(currentTime);
        setTimeOptions(slots, slots.length ? 'Selecione um hor치rio' : 'Sem hor치rios dispon칤veis');
        if (currentTime) timeSelect.value = currentTime;
      } catch (e) {
        setTimeOptions(currentTime ? [currentTime] : [], 'Sem hor치rios dispon칤veis');
        if (currentTime) timeSelect.value = currentTime;
      }
    }

    dateInput.addEventListener('change', refreshTimes);
    refreshTimes();
  })();

  // Utilit치rio de debounce para limitar chamadas de busca
  function debounce(fn, wait) {
    let t;
    return function(...args) {
      clearTimeout(t);
      const ctx = this;
      t = setTimeout(() => fn.apply(ctx, args), wait);
    };
  }

  // Cliente: autocomplete por nome, copia apenas o texto para o campo
  (function() {
    const input = document.getElementById('client_name');
    const box = document.getElementById('client_suggestions');
    if (!input || !box) return;

    // Limpar client_id quando client_name for limpo
    input.addEventListener('input', function() {
      if (this.value.trim() === '') {
        const clientIdInput = document.querySelector('input[name="client_id"]');
        if (clientIdInput) clientIdInput.value = '';
      }
    });

    const handleInput = async () => {
      const term = input.value.trim();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_clients?term=${encodeURIComponent(term)}`);
        const clients = await res.json();
        box.innerHTML = '';
        clients.forEach((cli, idx) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item px-2 py-1';
          if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
          div.innerHTML = `
            <div class="d-flex flex-column">
              <strong>${cli.client_name || ''}</strong>
              ${cli.client_phone ? `<small class="text-muted">游 ${cli.client_phone}</small>` : ''}
              ${cli.client_email ? `<small class="text-muted">游닎 ${cli.client_email}</small>` : ''}
            </div>`;
          div.addEventListener('click', () => {
            input.value = cli.client_name || '';
            // Preencher automaticamente o campo client_id
            const clientIdInput = document.querySelector('input[name="client_id"]');
            if (clientIdInput) clientIdInput.value = cli.client_id || '';
            box.innerHTML = '';
          });
          box.appendChild(div);
        });
      } catch (e) {
        console.error('Erro ao buscar clientes:', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  // Cliente ID: autocomplete por ID ou nome
  (function() {
    const input = document.getElementById('client_id');
    const box = document.getElementById('client_id_suggestions');
    if (!input || !box) return;

    const handleInput = async () => {
      const term = input.value.trim();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_clients?term=${encodeURIComponent(term)}`);
        const clients = await res.json();
        const termLower = term.toLowerCase();
        box.innerHTML = '';
        clients
          .filter(cli => (cli.client_id || '').toLowerCase().includes(termLower) || (cli.client_name || '').toLowerCase().includes(termLower))
          .forEach((cli, idx) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item px-2 py-1';
            if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
            div.innerHTML = `
              <div class="d-flex flex-column">
                <div><strong>${cli.client_name || '(sem nome)'}</strong> <small class="text-muted">ID: ${cli.client_id}</small></div>
                ${cli.client_phone ? `<small class="text-muted">游 ${cli.client_phone}</small>` : ''}
                ${cli.client_email ? `<small class="text-muted">游닎 ${cli.client_email}</small>` : ''}
              </div>`;
            div.addEventListener('click', () => {
              input.value = cli.client_id || '';
              const nameInput = document.getElementById('client_name');
              if (nameInput) nameInput.value = cli.client_name || '';
              box.innerHTML = '';
            });
            box.appendChild(div);
          });
      } catch (e) {
        console.error('Erro ao buscar clientes (ID):', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  // Client ID: autocomplete por ID do cliente
  (function() {
    const input = document.getElementById('client_id');
    const box = document.getElementById('client_id_suggestions');
    if (!input || !box) return;

    const handleInput = async () => {
      const term = input.value.trim();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_clients_by_id?term=${encodeURIComponent(term)}`);
        const clients = await res.json();
        box.innerHTML = '';
        clients.forEach((cli, idx) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item px-2 py-1';
          if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
          div.innerHTML = `
            <div class="d-flex flex-column">
              <div><strong>${cli.client_id}</strong></div>
              <small class="text-muted">${cli.client_name || 'Sem nome'}</small>
              ${cli.client_phone ? `<small class="text-muted">游 ${cli.client_phone}</small>` : ''}
            </div>`;
          div.addEventListener('click', () => {
            input.value = cli.client_id || '';
            const nameInput = document.getElementById('client_name');
            if (nameInput) nameInput.value = cli.client_name || '';
            box.innerHTML = '';
          });
          box.appendChild(div);
        });
      } catch (e) {
        console.error('Erro ao buscar clientes (ID):', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  // Item: autocomplete por descri칞칚o ou c칩digo, copia apenas descri칞칚o
  (function() {
    const input = document.getElementById('item_description');
    const box = document.getElementById('item_description_suggestions');
    if (!input || !box) return;

    // Limpar item_id quando item_description for limpo
    input.addEventListener('input', function() {
      if (this.value.trim() === '') {
        const itemIdInput = document.getElementById('item_id');
        if (itemIdInput) itemIdInput.value = '';
      }
    });

    const handleInput = async () => {
      const term = input.value.trim();
      const termLower = term.toLowerCase();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_items?term=${encodeURIComponent(term)}`);
        const items = await res.json();
        box.innerHTML = '';
        items
          .filter(it => {
            const title = (it.item_title || it.title || '').toLowerCase();
            const custom = (it.item_custom_id || '').toLowerCase();
            return title.includes(termLower) || custom.includes(termLower);
          })
          .forEach((it, idx) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item px-2 py-1';
          if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
          const title = it.item_title || it.title || 'Sem t칤tulo';
          const idText = it.item_custom_id || it.item_id || '(sem ID)';
          const img = it.item_image_url || it.image_url || '';
          div.innerHTML = `
            <div class="item-suggestion">
              <div class="item-suggestion-thumb">
                ${img ? `<img src="${img}" alt="">` : `<i class="fas fa-image text-muted"></i>`}
              </div>
              <div class="item-suggestion-text">
                <div class="item-suggestion-id">${idText}</div>
                <small class="text-muted item-suggestion-title">${title}</small>
              </div>
            </div>`;
          div.addEventListener('click', () => {
            input.value = it.item_title || it.title || '';
            const idInput = document.getElementById('item_id');
            if (idInput) idInput.value = it.item_id || '';
            if (idInput) idInput.dataset.itemCustomId = it.item_custom_id || '';
            if (idInput) idInput.dataset.itemImageUrl = it.item_image_url || it.image_url || '';
            box.innerHTML = '';
          });
          box.appendChild(div);
        });
      } catch (e) {
        console.error('Erro ao buscar itens:', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  // Item ID: autocomplete por c칩digo/ID, copia apenas o item_id
  (function() {
    const input = document.getElementById('item_id');
    const box = document.getElementById('item_id_suggestions');
    if (!input || !box) return;

    const handleInput = async () => {
      const term = input.value.trim();
      const termLower = term.toLowerCase();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_items?term=${encodeURIComponent(term)}`);
        const items = await res.json();
        box.innerHTML = '';
        items
          .filter(it =>
            (it.item_custom_id || '').toLowerCase().includes(termLower) ||
            String(it.item_id || '').toLowerCase().includes(termLower)
          )
          .forEach((it, idx) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item px-2 py-1';
            if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
            const title = it.item_title || it.title || 'Sem t칤tulo';
            const idText = it.item_custom_id || it.item_id || '(sem ID)';
            const img = it.item_image_url || it.image_url || '';
            div.innerHTML = `
              <div class="item-suggestion">
                <div class="item-suggestion-thumb">
                  ${img ? `<img src="${img}" alt="">` : `<i class="fas fa-image text-muted"></i>`}
                </div>
                <div class="item-suggestion-text">
                  <div class="item-suggestion-id">${idText}</div>
                  <small class="text-muted item-suggestion-title">${title}</small>
                  ${it.item_id ? `<small class="text-muted item-suggestion-sub">ID interno: ${it.item_id}</small>` : ``}
                </div>
              </div>`;
            div.addEventListener('click', () => {
              input.value = it.item_id || '';
              input.dataset.itemCustomId = it.item_custom_id || '';
              input.dataset.itemImageUrl = it.item_image_url || it.image_url || '';
              const descInput = document.getElementById('item_description');
              if (descInput) descInput.value = it.item_title || it.title || '';
              box.innerHTML = '';
            });
            box.appendChild(div);
          });
      } catch (e) {
        console.error('Erro ao buscar itens por ID:', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  (function() {
    const listEl = document.getElementById('fitting_items_list');
    const hiddenEl = document.getElementById('items_json');
    const addBtn = document.getElementById('btn_add_item');
    const itemIdEl = document.getElementById('item_id');
    const itemDescEl = document.getElementById('item_description');
    if (!listEl || !hiddenEl || !addBtn || !itemIdEl || !itemDescEl) return;

    let items = [];
    try {
      const parsed = JSON.parse(hiddenEl.value || '[]');
      items = Array.isArray(parsed) ? parsed.slice() : [];
    } catch (e) {
      items = [];
    }

    function normalizeItem(raw) {
      if (!raw || typeof raw !== 'object') return null;
      const itemId = String(raw.item_id || '').trim();
      const itemCustomId = String(raw.item_custom_id || '').trim();
      const title = String(raw.item_title || raw.title || raw.item_description || '').trim();
      const desc = String(raw.item_description || title || '').trim();
      const img = String(raw.item_image_url || raw.image_url || '').trim();
      if (!itemId && !itemCustomId && !title) return null;
      return {
        item_id: itemId,
        item_custom_id: itemCustomId,
        item_title: title || desc || itemCustomId || itemId || 'Item',
        item_description: desc,
        item_image_url: img,
      };
    }

    function dedupeById(list) {
      const out = [];
      const seen = new Set();
      for (const it of list) {
        const n = normalizeItem(it);
        if (!n) continue;
        let key = n.item_id;
        if (!key && n.item_custom_id) key = `custom:${n.item_custom_id}`;
        if (!key) key = `title:${n.item_title}`;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(n);
      }
      return out;
    }

    function syncHidden() {
      hiddenEl.value = JSON.stringify(items);
    }

    function removeAt(idx) {
      items.splice(idx, 1);
      render();
    }

    function render() {
      items = dedupeById(items);
      listEl.innerHTML = '';
      if (!items.length) {
        listEl.innerHTML = `<div class="text-muted">Nenhum vestido adicionado</div>`;
        syncHidden();
        return;
      }

      items.forEach((it, idx) => {
        const imgHtml = it.item_image_url
          ? `<img src="${it.item_image_url}" alt="" style="width:96px;height:96px;object-fit:cover;border-radius:12px;border:1px solid rgba(0,0,0,0.08);background:#f8f9fa;">`
          : `<div style="width:96px;height:96px;border-radius:12px;border:1px solid rgba(0,0,0,0.08);background:#f8f9fa;display:flex;align-items:center;justify-content:center;color:#6c757d;">
               <i class="fas fa-person-dress" style="font-size:28px;"></i>
             </div>`;

        const sub = it.item_custom_id || it.item_id || '';
        const title = it.item_title || it.item_description || sub || 'Item';

        const card = document.createElement('div');
        card.className = 'fitting-item-card';
        card.innerHTML = `
          <div class="border rounded-3 p-2 h-100" style="background:#fff;">
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-sm btn-outline-danger" data-remove="${idx}" title="Remover">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <div class="d-flex flex-column align-items-center" style="gap:8px;">
              ${imgHtml}
              <div class="text-center fw-semibold text-truncate" style="max-width:120px;line-height:1.15;color:#212529;">${title}</div>
              ${sub ? `<div class="text-muted text-truncate" style="max-width:120px;line-height:1.1;font-size:0.8rem;">${sub}</div>` : ``}
            </div>
          </div>
        `;
        listEl.appendChild(card);
      });

      listEl.querySelectorAll('button[data-remove]').forEach(btn => {
        btn.addEventListener('click', () => removeAt(parseInt(btn.getAttribute('data-remove') || '0', 10)));
      });

      syncHidden();
    }

    addBtn.addEventListener('click', () => {
      const itemId = String(itemIdEl.value || '').trim();
      const title = String(itemDescEl.value || '').trim();
      const itemCustomId = String(itemIdEl.dataset.itemCustomId || '').trim();
      const itemImageUrl = String(itemIdEl.dataset.itemImageUrl || '').trim();
      if (!itemId && !title && !itemCustomId) return;

      items.push({
        item_id: itemId,
        item_custom_id: itemCustomId,
        item_title: title,
        item_description: title,
        item_image_url: itemImageUrl,
      });

      itemIdEl.value = '';
      itemDescEl.value = '';
      itemIdEl.dataset.itemCustomId = '';
      itemIdEl.dataset.itemImageUrl = '';
      render();
    });

    render();
  })();
</script>
{% endblock %}
