{% extends "base.html" %}

{% block title %}Editar Prova{% endblock %}

{% block head %}
<!-- Bootstrap CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
  crossorigin="anonymous"
/>

<!-- FontAwesome -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>

<style>
  .autocomplete-container {
    position: relative;
  }
  .autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .autocomplete-item {
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .autocomplete-item:hover {
    background-color: #f8f9fa;
  }
  .card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
  }
  .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0">
        <i class="fas fa-edit text-warning me-2"></i>Editar Prova
      </h1>
      <p class="text-muted mb-0">Modifique os dados da prova de roupa</p>
    </div>
    <a href="{{ url_for('agenda') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Voltar para Agenda
    </a>
  </div>

  <!-- Form Card -->
  <div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-user-clock me-2"></i>Dados da Prova
          </h5>
        </div>
        <div class="card-body">
          <form method="POST">
            <div class="row g-3">
              <!-- Data -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-calendar me-1"></i>Data <span class="text-danger">*</span>
                </label>
                <input type="date" class="form-control" name="date_iso" id="date_iso" value="{{ fitting.date_local }}" required>
              </div>

              <!-- Hora -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-clock me-1"></i>Hora
                </label>
                <select class="form-select" name="time_local" id="time_local" data-current-time="{{ fitting.time_local or '' }}">
                  <option value="">Carregando hor치rios...</option>
                </select>
                <div class="form-text">Os hor치rios seguem a configura칞칚o do agendamento</div>
              </div>

              <!-- Dura칞칚o -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-stopwatch me-1"></i>Dura칞칚o (min)
                </label>
                <input type="number" min="1" step="1" class="form-control" name="duration_minutes" value="{{ default_duration_minutes or fitting.duration_minutes or 60 }}">
                <div class="form-text">A dura칞칚o influencia o bloqueio de slots</div>
              </div>

              <!-- Cliente ID -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-hashtag me-1"></i>ID do Cliente
                </label>
                <div class="autocomplete-container">
                  <input type="text" class="form-control" name="client_id" id="client_id" value="{{ fitting.client_id }}" placeholder="Digite o ID do cliente">
                  <div id="client_id_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="form-text">Campo auxiliar para busca</div>
              </div>

              <!-- Nome do Cliente -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-user me-1"></i>Nome do Cliente
                </label>
                <div class="autocomplete-container">
                  <input type="text" class="form-control" name="client_name" id="client_name" value="{{ fitting.client_name }}" placeholder="Digite para buscar cliente">
                  <div id="client_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="form-text">Campo auxiliar para busca</div>
              </div>

              <!-- Email do Cliente -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-envelope me-1"></i>Email do Cliente
                </label>
                <input type="email" class="form-control" name="client_email" value="{{ fitting.client_email or '' }}" placeholder="ex: cliente@email.com">
              </div>

              <!-- Telefone do Cliente -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-phone me-1"></i>Telefone do Cliente
                </label>
                <input type="text" class="form-control" name="client_phone" value="{{ fitting.client_phone or '' }}" placeholder="WhatsApp/Telefone">
              </div>

              <!-- Item ID -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-barcode me-1"></i>ID do Item
                </label>
                <div class="autocomplete-container">
                  <input type="text" class="form-control" name="item_id" id="item_id" value="{{ fitting.item_id }}" placeholder="Digite o ID do item">
                  <div id="item_id_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="form-text">Campo auxiliar para busca</div>
              </div>

              <!-- Descri칞칚o do Item -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-tag me-1"></i>Descri칞칚o do Item
                </label>
                <div class="autocomplete-container">
                  <input type="text" class="form-control" name="item_description" id="item_description" value="{{ fitting.item_description }}" placeholder="Digite para buscar item">
                  <div id="item_description_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="form-text">Campo auxiliar para busca</div>
              </div>

              <!-- Status -->
              <div class="col-sm-6">
                <label class="form-label">
                  <i class="fas fa-info-circle me-1"></i>Status
                </label>
                <select class="form-select" name="status">
                  <option value="Pendente" {% if fitting.status == 'Pendente' %}selected{% endif %}>Pendente</option>
                  <option value="Confirmado" {% if fitting.status == 'Confirmado' %}selected{% endif %}>Confirmado</option>
                  <option value="Cancelado" {% if fitting.status == 'Cancelado' %}selected{% endif %}>Cancelado</option>
                </select>
              </div>

              <!-- Observa칞칫es -->
              <div class="col-12">
                <label class="form-label">
                  <i class="fas fa-sticky-note me-1"></i>Observa칞칫es (opcional)
                </label>
                <textarea class="form-control" name="notes" rows="3" placeholder="Detalhes importantes sobre a prova">{{ fitting.notes or '' }}</textarea>
              </div>

              <!-- Reenviar e-mail -->
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="send_email_on_save" name="send_email_on_save">
                  <label class="form-check-label" for="send_email_on_save">
                    Enviar e-mail ao salvar (conforme o status)
                  </label>
                </div>
                <div class="form-text">Somente envia se houver e-mail preenchido.</div>
              </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i>Atualizar Prova
              </button>
              <a href="{{ url_for('agenda') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-2"></i>Cancelar
              </a>
              <form method="post" action="{{ url_for('delete_fitting', fitting_id=fitting.fitting_id) }}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta prova?')">
                <button type="submit" class="btn btn-danger">
                  <i class="fas fa-trash me-2"></i>Excluir
                </button>
              </form>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- FontAwesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<!-- Bootstrap Bundle -->
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-A3xORN3yEh9NTBI69AsVZqg0vszNvB4LaU6gq3p0eNmKUy5OWyE4hzJxKr5oUqvN"
  crossorigin="anonymous"
></script>

<script>
  (function() {
    const dateInput = document.getElementById('date_iso');
    const timeSelect = document.getElementById('time_local');
    if (!dateInput || !timeSelect) return;

    const currentTime = (timeSelect.getAttribute('data-current-time') || '').trim();

    function setTimeOptions(options, placeholder) {
      timeSelect.innerHTML = '';
      const first = document.createElement('option');
      first.value = '';
      first.textContent = placeholder || 'Selecione';
      timeSelect.appendChild(first);

      for (const t of options) {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        timeSelect.appendChild(opt);
      }
    }

    function normalizeSlots(slots) {
      const set = new Set();
      for (const s of slots) {
        const t = (s || '').toString().trim();
        if (t) set.add(t);
      }
      return Array.from(set).sort();
    }

    async function refreshTimes() {
      const date = (dateInput.value || '').trim();
      if (!date) {
        setTimeOptions([], 'Selecione uma data');
        return;
      }

      setTimeOptions([], 'Carregando hor치rios...');
      try {
        const resp = await fetch(`/api/admin/available_slots?date=${encodeURIComponent(date)}`, {
          headers: { 'Accept': 'application/json' },
        });
        if (!resp.ok) {
          setTimeOptions(currentTime ? [currentTime] : [], 'Sem hor치rios dispon칤veis');
          if (currentTime) timeSelect.value = currentTime;
          return;
        }
        const data = await resp.json();
        const slots = normalizeSlots(Array.isArray(data.slots) ? data.slots : []);
        if (currentTime && !slots.includes(currentTime)) slots.unshift(currentTime);
        setTimeOptions(slots, slots.length ? 'Selecione um hor치rio' : 'Sem hor치rios dispon칤veis');
        if (currentTime) timeSelect.value = currentTime;
      } catch (e) {
        setTimeOptions(currentTime ? [currentTime] : [], 'Sem hor치rios dispon칤veis');
        if (currentTime) timeSelect.value = currentTime;
      }
    }

    dateInput.addEventListener('change', refreshTimes);
    refreshTimes();
  })();

  // Utilit치rio de debounce para limitar chamadas de busca
  function debounce(fn, wait) {
    let t;
    return function(...args) {
      clearTimeout(t);
      const ctx = this;
      t = setTimeout(() => fn.apply(ctx, args), wait);
    };
  }

  // Cliente: autocomplete por nome, copia apenas o texto para o campo
  (function() {
    const input = document.getElementById('client_name');
    const box = document.getElementById('client_suggestions');
    if (!input || !box) return;

    // Limpar client_id quando client_name for limpo
    input.addEventListener('input', function() {
      if (this.value.trim() === '') {
        const clientIdInput = document.querySelector('input[name="client_id"]');
        if (clientIdInput) clientIdInput.value = '';
      }
    });

    const handleInput = async () => {
      const term = input.value.trim();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_clients?term=${encodeURIComponent(term)}`);
        const clients = await res.json();
        box.innerHTML = '';
        clients.forEach((cli, idx) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item px-2 py-1';
          if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
          div.innerHTML = `
            <div class="d-flex flex-column">
              <strong>${cli.client_name || ''}</strong>
              ${cli.client_phone ? `<small class="text-muted">游 ${cli.client_phone}</small>` : ''}
              ${cli.client_email ? `<small class="text-muted">游닎 ${cli.client_email}</small>` : ''}
            </div>`;
          div.addEventListener('click', () => {
            input.value = cli.client_name || '';
            // Preencher automaticamente o campo client_id
            const clientIdInput = document.querySelector('input[name="client_id"]');
            if (clientIdInput) clientIdInput.value = cli.client_id || '';
            box.innerHTML = '';
          });
          box.appendChild(div);
        });
      } catch (e) {
        console.error('Erro ao buscar clientes:', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  // Cliente ID: autocomplete por ID ou nome
  (function() {
    const input = document.getElementById('client_id');
    const box = document.getElementById('client_id_suggestions');
    if (!input || !box) return;

    const handleInput = async () => {
      const term = input.value.trim();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_clients?term=${encodeURIComponent(term)}`);
        const clients = await res.json();
        const termLower = term.toLowerCase();
        box.innerHTML = '';
        clients
          .filter(cli => (cli.client_id || '').toLowerCase().includes(termLower) || (cli.client_name || '').toLowerCase().includes(termLower))
          .forEach((cli, idx) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item px-2 py-1';
            if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
            div.innerHTML = `
              <div class="d-flex flex-column">
                <div><strong>${cli.client_name || '(sem nome)'}</strong> <small class="text-muted">ID: ${cli.client_id}</small></div>
                ${cli.client_phone ? `<small class="text-muted">游 ${cli.client_phone}</small>` : ''}
                ${cli.client_email ? `<small class="text-muted">游닎 ${cli.client_email}</small>` : ''}
              </div>`;
            div.addEventListener('click', () => {
              input.value = cli.client_id || '';
              const nameInput = document.getElementById('client_name');
              if (nameInput) nameInput.value = cli.client_name || '';
              box.innerHTML = '';
            });
            box.appendChild(div);
          });
      } catch (e) {
        console.error('Erro ao buscar clientes (ID):', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  // Client ID: autocomplete por ID do cliente
  (function() {
    const input = document.getElementById('client_id');
    const box = document.getElementById('client_id_suggestions');
    if (!input || !box) return;

    const handleInput = async () => {
      const term = input.value.trim();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_clients_by_id?term=${encodeURIComponent(term)}`);
        const clients = await res.json();
        box.innerHTML = '';
        clients.forEach((cli, idx) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item px-2 py-1';
          if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
          div.innerHTML = `
            <div class="d-flex flex-column">
              <div><strong>${cli.client_id}</strong></div>
              <small class="text-muted">${cli.client_name || 'Sem nome'}</small>
              ${cli.client_phone ? `<small class="text-muted">游 ${cli.client_phone}</small>` : ''}
            </div>`;
          div.addEventListener('click', () => {
            input.value = cli.client_id || '';
            const nameInput = document.getElementById('client_name');
            if (nameInput) nameInput.value = cli.client_name || '';
            box.innerHTML = '';
          });
          box.appendChild(div);
        });
      } catch (e) {
        console.error('Erro ao buscar clientes (ID):', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  // Item: autocomplete por descri칞칚o ou c칩digo, copia apenas descri칞칚o
  (function() {
    const input = document.getElementById('item_description');
    const box = document.getElementById('item_description_suggestions');
    if (!input || !box) return;

    // Limpar item_id quando item_description for limpo
    input.addEventListener('input', function() {
      if (this.value.trim() === '') {
        const itemIdInput = document.getElementById('item_id');
        if (itemIdInput) itemIdInput.value = '';
      }
    });

    const handleInput = async () => {
      const term = input.value.trim();
      const termLower = term.toLowerCase();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_items?term=${encodeURIComponent(term)}`);
        const items = await res.json();
        box.innerHTML = '';
        // Filtra somente por descri칞칚o no frontend
        items
          .filter(it => (it.item_description || '').toLowerCase().includes(termLower))
          .forEach((it, idx) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item px-2 py-1';
          if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
          div.innerHTML = `
            <div class="d-flex flex-column">
              <div><strong>${it.item_custom_id || '(sem c칩digo)'}</strong></div>
              <small class="text-muted">${it.item_description || 'Sem descri칞칚o'}</small>
            </div>`;
          div.addEventListener('click', () => {
            input.value = it.item_description || '';
            const idInput = document.getElementById('item_id');
            if (idInput) idInput.value = it.item_id || '';
            box.innerHTML = '';
          });
          box.appendChild(div);
        });
      } catch (e) {
        console.error('Erro ao buscar itens:', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();

  // Item ID: autocomplete por c칩digo/ID, copia apenas o item_id
  (function() {
    const input = document.getElementById('item_id');
    const box = document.getElementById('item_id_suggestions');
    if (!input || !box) return;

    const handleInput = async () => {
      const term = input.value.trim();
      const termLower = term.toLowerCase();
      if (!term) { box.innerHTML = ''; return; }
      try {
        const res = await fetch(`/autocomplete_items?term=${encodeURIComponent(term)}`);
        const items = await res.json();
        box.innerHTML = '';
        items
          .filter(it =>
            (it.item_custom_id || '').toLowerCase().includes(termLower) ||
            String(it.item_id || '').toLowerCase().includes(termLower)
          )
          .forEach((it, idx) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item px-2 py-1';
            if (idx > 0) div.style.borderTop = '1px solid #e9ecef';
            div.innerHTML = `
              <div class="d-flex flex-column">
                <div><strong>${it.item_custom_id || '(sem c칩digo)'}</strong></div>
                <small class="text-muted">${it.item_description || 'Sem descri칞칚o'}</small>
                <small class="text-muted">ID interno: ${it.item_id || '-'}</small>
              </div>`;
            div.addEventListener('click', () => {
              input.value = it.item_id || '';
              const descInput = document.getElementById('item_description');
              if (descInput) descInput.value = it.item_description || '';
              box.innerHTML = '';
            });
            box.appendChild(div);
          });
      } catch (e) {
        console.error('Erro ao buscar itens por ID:', e);
      }
    };
    input.addEventListener('input', debounce(handleInput, 300));
    input.addEventListener('blur', () => setTimeout(() => (box.innerHTML = ''), 200));
  })();
</script>
{% endblock %}
