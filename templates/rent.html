{% extends "base.html" %} {% block title %}Adicionar Transa√ß√£o{% endblock %} {% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_rent.css') }}" />

<style>
  .stepper .step {
    flex: 1;
    text-align: center;
    padding: 0.75rem;
    border-bottom: 3px solid #ccc;
    font-weight: 500;
  }
  .stepper .step.active {
    border-color: #0d6efd;
    color: #0d6efd;
  }

  .exit-link {
    color: #6c757d;
    text-decoration: none;
    font-weight: 500;
    display: flex;
    align-items: center;
    transition: color 0.2s ease;
  }

  .exit-link:hover {
    color: #dc3545; /* vermelho suave ao passar o mouse */
    text-decoration: underline;
  }
</style>
{% endblock %} {% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h1 class="mb-0">Adicionar Transa√ß√£o</h1>



      <a href="{{ url_for('inventory') }}" class="exit-link">
        <i class="fas fa-sign-out-alt me-2"></i>
        Sair sem Finalizar
      </a>
    </div>
  </div>

  {% if item_vindo_da_query and not cliente_vindo_da_query %} {% set ordem = ["bloco-item", "bloco-cliente", "bloco-transacao"] %} {% elif
  cliente_vindo_da_query and not item_vindo_da_query %} {% set ordem = ["bloco-cliente", "bloco-item", "bloco-transacao"] %} {% else %} {% set ordem =
  ["bloco-cliente", "bloco-item", "bloco-transacao"] %} {% endif %}

  <!-- Stepper visual -->
  <div class="stepper mb-4 d-flex justify-content-between">
    {% for bloco in ordem %}
    <div class="step {% if loop.first %}active{% endif %}" data-step="{{ loop.index }}">
      {% if "cliente" in bloco %} Cliente {% elif "item" in bloco %} Item {% else %} Transa√ß√£o {% endif %}
    </div>
    {% endfor %}
  </div>

  <form action="{{ url_for('rent') }}" method="POST" enctype="multipart/form-data" id="form-rent" novalidate>
    <!-- üîπ Bloco Cliente -->
    <div id="bloco-cliente" class="form-section">
      <h4 class="mb-3">Informa√ß√µes do Cliente</h4>
      <div class="mb-4">{% include 'components/dynamic_input_client.html' with context %}</div>
      <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-primary w-auto" onclick="mostrarAba('bloco-item')">Avan√ßar</button>
      </div>
    </div>

    <!-- üîπ Bloco Item -->
    <div id="bloco-item" class="form-section d-none">
      <h4 class="mb-3">Dados do Item</h4>
      <div class="mb-4">{% include 'components/dynamic_input_item.html' with context %}</div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" onclick="mostrarAba('bloco-cliente')">Voltar</button>
        <button type="button" class="btn btn-primary w-auto" onclick="mostrarAba('bloco-item')">Avan√ßar</button>
      </div>
    </div>

    <!-- üîπ Bloco Transa√ß√£o -->
    <div id="bloco-transacao" class="form-section d-none">
      <h4 class="mb-3">Detalhes da Transa√ß√£o</h4>
      <div class="mb-4">{% include 'components/dynamic_input_transaction.html' with context %}</div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" onclick="mostrarAba('bloco-item')">Voltar</button>
        <button type="submit" class="btn btn-primary w-auto">Concluir</button>
      </div>
    </div>
  </form>
</div>

<!-- üîπModal limite atingido -->

<div
  class="modal fade"
  id="limitModal"
  tabindex="-1"
  aria-labelledby="limitModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="limitModalLabel">Limite do Plano Atingido</h5>
      </div>
      <div class="modal-body text-center">
        Voc√™ atingiu os limites de
        <strong>transa√ß√µes</strong>
        permitidas pelo seu plano atual.
        <br />
      </div>
      <div class="modal-footer justify-content-center">
        <a href="{{ url_for('adjustments') }}" class="btn btn-primary btn-lg">Atualizar Plano Agora</a>
      </div>
    </div>
  </div>
</div>
{{item_id}}{{user_id}} {% endblock %} {% block scripts %} {{ super() }}
<script src="https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.1/dist/index.umd.min.js"></script>

<script>
  function mostrarAba(id) {
    const sections = document.querySelectorAll('.form-section');
    const steps = document.querySelectorAll('.step');

    sections.forEach((sec) => sec.classList.add('d-none'));
    document.getElementById(id).classList.remove('d-none');

    const index = ['bloco-cliente', 'bloco-item', 'bloco-transacao'].indexOf(id);
    steps.forEach((step, i) => step.classList.toggle('active', i === index));
  }
</script>

<script>
  // üßº M√°scaras
  function maskPhone(value) {
    let input = value.replace(/\D/g, '');
    if (input.length > 11) input = input.slice(0, 11);
    let formatted = '';
    if (input.length > 0) formatted += '(' + input.substring(0, 2);
    if (input.length >= 3) formatted += ') ' + input.substring(2, 7);
    if (input.length >= 8) formatted += '-' + input.substring(7);
    return formatted;
  }

  function maskCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    return cpf;
  }

  function maskCNPJ(cnpj) {
    cnpj = cnpj.replace(/\D/g, '');
    cnpj = cnpj.replace(/^(\d{2})(\d)/, '$1.$2');
    cnpj = cnpj.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    cnpj = cnpj.replace(/\.(\d{3})(\d)/, '.$1/$2');
    cnpj = cnpj.replace(/(\d{4})(\d)/, '$1-$2');
    return cnpj;
  }
</script>

<script>
  // üß† Bloqueia todos os campos do bloco de cliente
  function bloquearCamposCliente() {
    const blocoCliente = document.getElementById('bloco-cliente');
    if (!blocoCliente) return;

    const campos = blocoCliente.querySelectorAll('input, select, textarea');

    campos.forEach((el) => {
      if (el.id !== 'client_name' && el.type !== 'hidden') {
        el.setAttribute('readonly', true);
        el.setAttribute('disabled', true);
      } else if (el.id === 'client_name') {
        // Garante que client_name fique ativo
        el.removeAttribute('readonly');
        el.removeAttribute('disabled');
      }
    });
  }

  function desbloquearCamposCliente() {
    const blocoCliente = document.getElementById('bloco-cliente');
    if (!blocoCliente) return;

    const campos = blocoCliente.querySelectorAll('input, select, textarea');
    campos.forEach((el) => {
      if (el.type !== 'hidden') {
        el.removeAttribute('readonly');
        el.removeAttribute('disabled');
      }
    });
  }

  // üß† Aplica m√°scaras espec√≠ficas para CPF, CNPJ e telefone
  function aplicarMascaraCliente(id, valor) {
    if (!valor) return '';
    if (id === 'client_phone') return maskPhone(valor);
    if (id === 'client_cpf') return maskCPF(valor);
    if (id === 'client_cnpj') return maskCNPJ(valor);
    return valor;
  }

  // üß† Autocomplete de cliente
  function autocompleteCliente() {
    const clientInput = document.getElementById('client_name');
    const statusMessage = document.getElementById('client-status-message');
    const suggestionsBox = document.getElementById('client_suggestions');

    let suggestionSelected = false;

    if (!clientInput || !statusMessage || !suggestionsBox) return;

    clientInput.addEventListener('input', async () => {
      const term = clientInput.value.trim();
      if (term.length < 1) {
        suggestionsBox.innerHTML = '';
        statusMessage.style.display = 'none';
        return;
      }

      try {
        const res = await fetch(`/autocomplete_clients?term=${encodeURIComponent(term)}`);
        const clients = await res.json();

        suggestionsBox.innerHTML = '';

        clients.forEach((cli) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.innerHTML = `
  <strong>${cli.client_name}</strong>
  ${cli.client_phone ? `<div><small>üìû ${maskPhone(cli.client_phone)}</small></div>` : ''}
  ${cli.client_email ? `<div><small>üìß ${cli.client_email}</small></div>` : ''}
  ${cli.client_cpf ? `<div><small>üÜî CPF: ${maskCPF(cli.client_cpf)}</small></div>` : ''}
  ${cli.client_cnpj ? `<div><small>üè¢ CNPJ: ${maskCNPJ(cli.client_cnpj)}</small></div>` : ''}
`;
          div.addEventListener('click', () => {
            // Preenche qualquer campo que existir com base nas chaves do JSON
            for (const key in cli) {
              const el = document.getElementById(key);
              if (el) {
                el.value = aplicarMascaraCliente(key, cli[key]);
              }
            }

            suggestionSelected = true;
            suggestionsBox.innerHTML = '';
            statusMessage.className = 'status-message user-found';
            const editarLink = `
  <a href="/editar_cliente/${cli.client_id}?client_id=${cli.client_id}&next=${encodeURIComponent(window.location.pathname)}"
     class="ms-2 text-decoration-underline text-warning">
    Editar
  </a>
`;

            statusMessage.innerHTML = 'Cliente encontrado ' + editarLink;
            statusMessage.style.display = 'block';

            bloquearCamposCliente();
          });

          suggestionsBox.appendChild(div);
        });

        const exactMatch = clients.find((client) => client.client_name.trim().toLowerCase() === term.toLowerCase());

        if (exactMatch) {
          statusMessage.className = 'status-message user-found';
          statusMessage.innerHTML = 'Cliente encontrado';
        } else {
          statusMessage.className = 'status-message user-new';
          statusMessage.innerHTML = 'Cliente novo ser√° criado';
          desbloquearCamposCliente();
        }

        statusMessage.style.display = 'block';
      } catch (error) {
        console.error('Erro ao buscar clientes:', error);
      }
    });

    document.addEventListener('click', (e) => {
      if (!clientInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
        suggestionsBox.innerHTML = '';
      }
    });

    clientInput.addEventListener('focus', () => {
      suggestionSelected = false;
    });
  }

  // üîÅ Inicializar ao carregar
  autocompleteCliente();
</script>

<script>

  // üìÜ Datepicker com datas bloqueadas
  function iniciarDatePicker() {
    const DateTime = easepick.DateTime;
    const rawDates = {{ reserved_ranges | tojson(indent=2) }};
    const bookedDates = rawDates.map(d => {
      if (d instanceof Array) {
        const start = new DateTime(d[0], 'YYYY-MM-DD');
        const end = new DateTime(d[1], 'YYYY-MM-DD');
        return [start, end];
      }
      return new DateTime(d, 'YYYY-MM-DD');
    });

    new easepick.create({
      element: document.getElementById('transaction_period'),
      css: [
        'https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.1/dist/index.css',
        'https://easepick.com/css/demo_hotelcal.css',
      ],
      lang: 'pt-BR',
      autoApply: false,
      plugins: ['RangePlugin', 'LockPlugin', 'AmpPlugin'],
      AmpPlugin: {
        resetButton: true,
      },
      RangePlugin: {
        tooltipNumber(num) {
          return num;
        },
        locale: {
          one: 'dia',
          other: 'dias',
        },
      },
      LockPlugin: {
        minDate: new Date(),
        minDays: 1,
        inseparable: true,
        filter(date, picked) {
          if (picked.length === 1) {
            return !picked[0].isSame(date, 'day') && date.inArray(bookedDates, '[]');
          }
          return date.inArray(bookedDates, '[]');
        },
      },
      locale: {
        cancel: 'Cancelar',
        apply: 'Aplicar',
        reset: 'Limpar',
        one: 'dia',
        other: 'dias',
      },
      format: 'DD/MM/YYYY',
    });
  }

  // ‚úÖ Valida√ß√£o do formul√°rio + preenchimento dos campos ocultos
  function configurarValidacao() {
    document.getElementById('form-rent').addEventListener('submit', function (e) {
      const dp = document.getElementById('datepicker');


      const telFormatted = document.getElementById('client_phone').value;
      const cpfFormatted = document.getElementById('client_cpf').value;
      const cnpjFormatted = document.getElementById('client_cnpj').value;

      const telDigits = telFormatted.replace(/\D/g, '');
      const cpfDigits = cpfFormatted.replace(/\D/g, '');
      const cnpjDigits = cnpjFormatted.replace(/\D/g, '');

      document.getElementById('client_phone').value = telDigits;
      document.getElementById('client_cpf').value = cpfDigits;
      document.getElementById('client_cnpj').value = cnpjDigits;

      if (cpfDigits && !validaCPF(cpfDigits)) {
        e.preventDefault();
        alert('CPF inv√°lido!');
        return;
      }

      if (cnpjDigits && !validaCNPJ(cnpjDigits)) {
        e.preventDefault();
        alert('CNPJ inv√°lido!');
        return;
      }
    });
  }

  function validaCPF(cpf) {
    if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
    let soma = 0, resto;
    for (let i = 1; i <= 9; i++) soma += parseInt(cpf[i - 1]) * (11 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf[9])) return false;
    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(cpf[i - 1]) * (12 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    return resto === parseInt(cpf[10]);
  }

  function validaCNPJ(cnpj) {
    if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
    let tamanho = cnpj.length - 2;
    let numeros = cnpj.substring(0, tamanho);
    let digitos = cnpj.substring(tamanho);
    let soma = 0;
    let pos = tamanho - 7;

    for (let i = tamanho; i >= 1; i--) {
      soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
      if (pos < 2) pos = 9;
    }

    let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
    if (resultado != parseInt(digitos.charAt(0))) return false;

    tamanho += 1;
    numeros = cnpj.substring(0, tamanho);
    soma = 0;
    pos = tamanho - 7;
    for (let i = tamanho; i >= 1; i--) {
      soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
      if (pos < 2) pos = 9;
    }

    resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
    return resultado == parseInt(digitos.charAt(1));
  }

  // üöÄ Inicializar tudo quando a p√°gina carregar
  window.addEventListener('DOMContentLoaded', () => {
    iniciarDatePicker();
    configurarValidacao();

    // üßº Aplicar m√°scara de telefone ao digitar
    const telInput = document.getElementById('client_phone');
    if (telInput) {
    telInput.addEventListener('input', (e) => {
      e.target.value = maskPhone(e.target.value);
    });
  }

  // üßº Aplicar m√°scara de CPF ao digitar
  const cpfInput = document.getElementById('client_cpf');
  if (cpfInput) {
    cpfInput.addEventListener('input', (e) => {
      e.target.value = maskCPF(e.target.value);
    });
  }

  // üßº Aplicar m√°scara de CNPJ ao digitar
  const cnpjInput = document.getElementById('client_cnpj');
  if (cnpjInput) {
    cnpjInput.addEventListener('input', (e) => {
      e.target.value = maskCNPJ(e.target.value);
    });
  }
  });
</script>

{{ super() }}

<script>
  function formatarCampoMonetario(input) {
    input.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');

      if (!value) {
        e.target.value = '';
        return;
      }

      let intValue = parseInt(value, 10);
      let floatValue = intValue / 100;

      // üîí Limite de 1.000.000,00
      if (floatValue > 1000000) {
        floatValue = 1000000;
      }

      e.target.value = floatValue.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    });
  }

  // Aplica nos campos que precisam
  const campos = [document.getElementById('item_value'), document.getElementById('transaction_value_paid')];
  campos.forEach((campo) => {
    if (campo) {
      formatarCampoMonetario(campo);
    }
  });
</script>

<script>
  const clientNameInput = document.getElementById('client_name');
  const clientIdInput = document.getElementById('client_id');

  // Sempre que digitar no nome do cliente, limpa o client_id
  clientNameInput.addEventListener('input', function () {
    clientIdInput.value = '';
  });
</script>

<script>
  function inicializarAutocompleteItem(campoId) {
    const input = document.getElementById(campoId);
    const suggestionsBox = document.getElementById(`${campoId}_suggestions`);
    const statusIds = ['item_custom_id_status', 'item_description_status'];

    if (!input || !suggestionsBox) return;

    let itensSugeridos = [];
    let camposBloqueados = false;

    async function buscarSugestoes(term) {
      const res = await fetch(`/autocomplete_items?term=${encodeURIComponent(term)}`);
      const data = await res.json();
      itensSugeridos = data;
      return data;
    }

    function aplicarPreenchimento(item) {
      for (const key in item) {
        const field = document.getElementById(key);
        if (field) {
          field.value = item[key];
        }
      }

      // üëâ Garante que item_id ser√° inclu√≠do no form
      if (item.item_id) {
        let idHidden = document.getElementById('item_id');
        if (!idHidden) {
          idHidden = document.createElement('input');
          idHidden.type = 'hidden';
          idHidden.name = 'item_id';
          idHidden.id = 'item_id';
          document.getElementById('form-rent').appendChild(idHidden);
        }
        idHidden.value = item.item_id;
      }
    }

    function bloquearCamposItem() {
      if (camposBloqueados) return;
      camposBloqueados = true;

      const form = document.getElementById('form-rent');
      const campos = form.querySelectorAll('input, select, textarea');

      campos.forEach((el) => {
        if (!['item_custom_id', 'item_description'].includes(el.id) && el.type !== 'hidden') {
          el.setAttribute('readonly', true);
          el.setAttribute('disabled', true);
        }
      });

      const imgInput = document.getElementById('image_file');
      if (imgInput) imgInput.style.display = 'none';
    }

    function desbloquearCamposItem() {
      if (!camposBloqueados) return;
      camposBloqueados = false;

      const form = document.getElementById('form-rent');
      const campos = form.querySelectorAll('input, select, textarea');

      campos.forEach((el) => {
        if (el.type !== 'hidden') {
          el.removeAttribute('readonly');
          el.removeAttribute('disabled');
        }
      });

      const imgInput = document.getElementById('image_file');
      if (imgInput) imgInput.style.display = '';
    }

    function exibirStatusEncontrado(texto, classe) {
      statusIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = texto;
          el.className = `status-message ${classe} mt-1`;
          el.style.display = 'block';
        }
      });
    }

    function checarMatchExato() {
      const term = input.value.trim().toLowerCase();
      const match = itensSugeridos.find((it) => {
        const custom = (it.item_custom_id || '').toLowerCase();
        const desc = (it.item_description || '').toLowerCase();
        return custom === term || desc === term;
      });

      if (match) {
        exibirStatusEncontrado('Item encontrado', 'user-found');
        aplicarPreenchimento(match);
        bloquearCamposItem();
      } else {
        exibirStatusEncontrado('Novo item ser√° criado', 'user-new');
        desbloquearCamposItem();
      }
    }

    input.addEventListener('input', async () => {
      const term = input.value.trim();
      if (term.length < 1) {
        suggestionsBox.innerHTML = '';
        exibirStatusEncontrado('', '');
        desbloquearCamposItem();
        return;
      }

      try {
        const items = await buscarSugestoes(term);
        suggestionsBox.innerHTML = '';

        items.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item px-2 py-1';
          div.innerHTML = `<strong>${item.item_custom_id || '(sem c√≥digo)'}</strong><br>
                         <small>${item.item_description || 'Sem descri√ß√£o'}</small>`;
          div.addEventListener('click', () => {
            input.value = item[campoId] || '';
            aplicarPreenchimento(item);
            suggestionsBox.innerHTML = '';
            exibirStatusEncontrado('Item encontrado', 'user-found');
            bloquearCamposItem();
          });
          suggestionsBox.appendChild(div);
        });

        if (!camposBloqueados) checarMatchExato();
      } catch (err) {
        console.error('Erro ao buscar itens:', err);
      }
    });

    input.addEventListener('blur', () => {
      setTimeout(() => {
        suggestionsBox.innerHTML = '';
        if (!camposBloqueados) checarMatchExato();
      }, 200);
    });

    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
        suggestionsBox.innerHTML = '';
      }
    });
  }
</script>

<script>
    // üîÅ Bloqueia novas transa√ßoes de acordo com o plano

  document.addEventListener("DOMContentLoaded", function () {
    const totalTransactions = {{ total_relevant_transactions | default(0) | tojson }};
    const subscriptionStatus = {{ current_stripe_transaction.subscription_status | default('none') | tojson }};

    const allowedStatuses = ["trialing", "active", "past_due"];
    const maxLimit = allowedStatuses.includes(subscriptionStatus) ? 300 : 0;

    const atingiuLimite = totalTransactions >= maxLimit;

    if (atingiuLimite) {
      const modal = new bootstrap.Modal(document.getElementById("limitModal"));
      modal.show();
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tentarExibirClienteEncontrado = () => {
      const clientId = document.getElementById('client_id')?.value;
      const clientName = document.getElementById('client_name')?.value;
      const statusMsg = document.getElementById('client-status-message');

      if (clientId && clientName && statusMsg) {
        const editarLink = `
          <a href="/editar_cliente/${clientId}?client_id=${clientId}&next=${encodeURIComponent(window.location.pathname)}"
             class="ms-2 text-decoration-underline text-warning">
            Editar
          </a>
        `;
        statusMsg.innerHTML = 'Cliente encontrado ' + editarLink;
        statusMsg.className = 'status-message user-found mt-1';
        statusMsg.style.display = 'block';
      }
    };

    // Espera at√© o elemento existir no DOM
    const interval = setInterval(() => {
      const statusMsg = document.getElementById('client-status-message');
      if (statusMsg) {
        clearInterval(interval);
        tentarExibirClienteEncontrado();
      }
    }, 100);
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const clientId = urlParams.get('client_id');

    const clientNameInput = document.getElementById('client_name');
    const statusMsg = document.getElementById('client-status-message');

    if (clientId && clientNameInput && statusMsg) {
      const clientName = clientNameInput.value || 'Cliente';
      const editarLink = `
        <a href="/editar_cliente/${clientId}?client_id=${clientId}&next=${encodeURIComponent(window.location.pathname)}"
           class="ms-2 text-decoration-underline text-warning">
          Editar
        </a>
      `;

      statusMsg.innerHTML = `Cliente encontrado: ${clientName} ${editarLink}`;
      statusMsg.className = 'status-message user-found mt-1';
      statusMsg.style.display = 'block';
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    inicializarAutocompleteItem('item_custom_id');
    inicializarAutocompleteItem('item_description');
  });
</script>

{% endblock %}
