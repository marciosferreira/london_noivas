<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Completo - London Noivas</title>
    <!-- Same head content as index.html -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'london-gold': '#C5A059',
                        'stone': {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            800: '#292524',
                            900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        serif: ['Playfair Display', 'serif'],
                        sans: ['Lato', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        .animate-fadeIn { animation: fadeIn 1.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 font-sans antialiased">

    <header id="main-header" class="sticky top-0 left-0 right-0 z-50 bg-stone-900 py-4 shadow-lg">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-12 h-12 rounded-sm overflow-hidden bg-white">
                    <img src="{{ url_for('static', filename='logo.jpeg') }}" alt="London Noivas Logo" class="w-full h-full object-contain">
                </div>
                <h1 id="header-title" class="text-2xl font-serif tracking-widest text-white">
                    LONDON NOIVAS
                </h1>
            </div>

            <nav class="hidden md:flex gap-8 items-center font-medium tracking-wide text-sm">
                <a href="/" class="nav-link text-white hover:text-london-gold transition-colors">HOME</a>
                <a href="{{ url_for('index') }}#sobre" class="nav-link text-white hover:text-london-gold transition-colors">SOBRE</a>
                <a href="{{ url_for('index') }}#contato" class="nav-link text-white hover:text-london-gold transition-colors">CONTATO</a>
                <a href="https://wa.me/5592993531943" onclick="trackWhatsAppClick('header')" class="bg-london-gold text-white px-6 py-2 rounded-full hover:bg-opacity-90 transition-all shadow-lg">
                    AGENDAR VISITA
                </a>
                
                {% if session.get('logged_in') %}
                <a href="{{ url_for('agenda') }}" class="bg-white/10 text-white px-4 py-2 rounded hover:bg-white/20 transition-all text-xs ml-4">
                    PAINEL
                </a>
                {% endif %}
            </nav>
            
            <button id="mobile-menu-btn" class="md:hidden text-london-gold focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </div>
    </header>

    <div id="mobile-menu" class="fixed inset-0 z-[60] bg-stone-900/95 backdrop-blur-sm transform translate-x-full transition-transform duration-300 md:hidden flex flex-col justify-center items-center">
        <button id="close-menu-btn" class="absolute top-6 right-6 text-white hover:text-london-gold transition-colors focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        
        <nav class="flex flex-col gap-8 text-center">
            <a href="/" class="text-2xl font-serif text-white hover:text-london-gold transition-colors" onclick="closeMobileMenu()">INÍCIO</a>
            <a href="{{ url_for('index') }}#sobre" class="text-2xl font-serif text-white hover:text-london-gold transition-colors" onclick="closeMobileMenu()">SOBRE</a>
            <a href="{{ url_for('index') }}#contato" class="text-2xl font-serif text-white hover:text-london-gold transition-colors" onclick="closeMobileMenu()">CONTATO</a>
            <a href="https://wa.me/5592993531943" onclick="trackWhatsAppClick('mobile_menu'); closeMobileMenu()" class="text-xl bg-london-gold text-white px-8 py-3 rounded-full hover:bg-white hover:text-london-gold transition-all shadow-lg mt-4">
                AGENDAR VISITA
            </a>
        </nav>
    </div>

    <main class="container mx-auto px-6 pt-10 pb-12">
        <div class="text-center mb-16">
            <h2 class="text-4xl md:text-5xl font-serif text-stone-800 mb-4">{{ active_occasion_label }}</h2>
            <div class="w-24 h-1 bg-london-gold mx-auto mb-6"></div>
            {% if active_occasion_description %}
            <p class="text-stone-600 max-w-4xl mx-auto mb-8 text-lg leading-relaxed font-light italic px-4">
                "{{ active_occasion_description }}"
            </p>
            {% else %}
            <p class="text-stone-500 max-w-xl mx-auto mb-8">
                Explore nossa coleção completa para cada ocasião.
            </p>
            {% endif %}
            
            <!-- AI Search Bar -->
            <div class="max-w-2xl mx-auto relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-london-gold" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input 
                    type="text" 
                    id="ai-catalog-search-input"
                    class="w-full pl-12 pr-4 py-4 bg-white border-2 border-stone-200 rounded-full focus:outline-none focus:border-london-gold focus:ring-1 focus:ring-london-gold transition-all shadow-sm text-stone-700 placeholder-stone-400"
                    placeholder="Ex: sereia com renda"
                    onkeypress="handleEnterSearch(event)"
                >
                <button 
                    onclick="performCatalogSearch(1)"
                    class="absolute right-2 top-2 bottom-2 bg-london-gold text-white px-6 rounded-full hover:bg-stone-800 transition-colors font-medium tracking-wide shadow-md"
                >
                    ORDENAR
                </button>
            </div>
            <p class="text-xs text-stone-400 mt-2 italic">Powered by London AI &trade;</p>
        </div>

        <!-- Loading State -->
        <div id="search-loading" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-london-gold border-t-transparent"></div>
            <p class="mt-4 text-stone-500 font-serif animate-pulse">Consultando nossa estilista virtual...</p>
        </div>

        <!-- Occasion Tabs -->
        <div class="flex flex-wrap gap-3 justify-center mb-12" id="occasion-tabs">
            {% for tab in occasion_tabs %}
            <a href="{{ url_for('catalogo', occasion=tab.slug) }}"
               class="px-6 py-2 rounded-full text-sm font-medium tracking-wider border transition-all duration-300 {{ 'bg-london-gold text-white border-london-gold shadow-md' if active_occasion == tab.slug else 'bg-white text-stone-600 border-stone-200 hover:bg-stone-50 hover:border-london-gold hover:text-london-gold' }}">
                {{ tab.label | upper }}
            </a>
            {% endfor %}
        </div>

        {% if active_occasion in ['debutante', 'noiva'] %}
        <div class="max-w-3xl mx-auto mb-10">
            <div class="bg-amber-50 border border-amber-200 text-amber-900 rounded-lg px-5 py-4 text-sm md:text-base shadow-sm">
                <span class="font-semibold">Mais vestidos disponíveis na loja:</span>
                consulte nossa equipe para ver outras opções.
            </div>
        </div>
        {% endif %}

        <!-- Catalog Grid -->
        <div id="catalog-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8">
            {% if itens %}
                {% for item in itens %}
                <div class="group bg-white rounded-sm shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden animate-fadeIn"
                     onclick="openCatalogModalById('{{ item.item_id }}', 'catalog')">
                    
                    <div class="aspect-[3/4] overflow-hidden bg-stone-200 relative">
                        <img src="{{ item.item_image_url }}" alt="{{ item.title }}" class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-700">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                        <div class="absolute bottom-4 right-4 bg-white/90 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-stone-800">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <h3 class="font-serif text-lg text-stone-800 mb-2 truncate">{{ item.title }}</h3>
                        <p class="text-xs text-london-gold tracking-widest font-bold uppercase">Ver Detalhes</p>
                    </div>
                </div>
                <script>
                    {% set occs = [] %}
                    {% if item.occasion_noiva == '1' %}{% set _ = occs.append('Noiva') %}{% endif %}
                    {% if item.occasion_civil == '1' %}{% set _ = occs.append('Civil') %}{% endif %}
                    {% if item.occasion_madrinha == '1' %}{% set _ = occs.append('Madrinha') %}{% endif %}
                    {% if item.occasion_mae_dos_noivos == '1' %}{% set _ = occs.append('Mãe dos Noivos') %}{% endif %}
                    {% if item.occasion_formatura == '1' %}{% set _ = occs.append('Formatura') %}{% endif %}
                    {% if item.occasion_debutante == '1' %}{% set _ = occs.append('Debutante') %}{% endif %}
                    {% if item.occasion_gala == '1' %}{% set _ = occs.append('Gala') %}{% endif %}
                    {% if item.occasion_convidada == '1' %}{% set _ = occs.append('Convidada') %}{% endif %}
                    
                    window.catalogData = window.catalogData || {};
                    window.catalogData['{{ item.item_id }}'] = {
                        imageUrl: '{{ item.item_image_url }}',
                        title: '{{ item.title | replace("'", "\\'") }}',
                        description: '{{ item.item_description | replace("'", "\\'") | replace("\n", " ") }}',
                        price: '{{ item.item_value }}',
                        customId: '{{ item.item_custom_id }}',
                        color: '{{ (item.cor or item.cores or "") | string | replace("'", "\\'") }}',
                        colorBase: '{{ (item.cor_base or "") | string | replace("'", "\\'") }}',
                        colorCommercial: '{{ (item.cor_comercial or "") | string | replace("'", "\\'") }}',
                        size: '{{ (item.tamanho or item.size or "") | string | replace("'", "\\'") }}',
                        occasions: '{{ occs | join(", ") }}'
                    };
                </script>
                {% endfor %}
            {% else %}
                <div class="col-span-full text-center py-20 bg-stone-100 rounded-lg">
                    <p class="text-stone-500 text-xl font-serif">Digite o que procura acima para ver nossa coleção.</p>
                </div>
            {% endif %}
        </div>

        <!-- Pagination Controls -->
        <div id="catalog-pagination" class="{% if total_pages and total_pages > 1 %}flex{% else %}hidden{% endif %} justify-center items-center mt-12 gap-4">
            {% if page and page > 1 %}
            <a href="{{ url_for('catalogo', page=page-1, occasion=active_occasion) }}" class="px-6 py-3 border border-stone-300 text-stone-600 hover:bg-stone-800 hover:text-white hover:border-stone-800 transition-all font-medium rounded-sm">
                &larr; Anterior
            </a>
            {% endif %}
            
            <span class="font-serif text-stone-500 mx-4">
                Página <span class="text-stone-800 font-bold">{{ page|default(1) }}</span> de {{ total_pages|default(1) }}
            </span>
            
            {% if page and total_pages and page < total_pages %}
            <a href="{{ url_for('catalogo', page=page+1, occasion=active_occasion) }}" class="px-6 py-3 border border-stone-300 text-stone-600 hover:bg-stone-800 hover:text-white hover:border-stone-800 transition-all font-medium rounded-sm">
                Próxima &rarr;
            </a>
            {% endif %}
        </div>

    </main>

    <!-- Catalog Modal -->
    <div id="catalog-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-stone-900/95 backdrop-blur-sm" onclick="closeCatalogModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 md:p-8 pointer-events-none">
            <div class="bg-white w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col md:flex-row pointer-events-auto rounded-sm relative">
                
                <button onclick="closeCatalogModal()" class="fixed top-4 right-4 z-20 text-stone-400 hover:text-stone-800 transition-colors bg-white/90 rounded-full shadow-md p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <!-- Image Side -->
                <div class="md:w-1/2 bg-stone-100 relative h-[40vh] md:h-auto group cursor-zoom-in" onclick="openFullImage(document.getElementById('modal-img').src)">
                    <img id="modal-img" src="" alt="Detail" class="w-full h-full object-contain transition-transform duration-500 hover:scale-105">
                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/20 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-12 h-12 drop-shadow-lg">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
                        </svg>
                    </div>
                </div>
                
                <!-- Content Side -->
                <div class="md:w-1/2 p-8 md:p-12 flex flex-col overflow-y-auto bg-white">
                    <div class="flex-1">
                        <span class="text-london-gold font-bold tracking-widest text-xs uppercase mb-2 block">London Noivas Collection</span>
                        <h3 id="modal-title" class="text-3xl md:text-4xl font-serif text-stone-900 mb-2 leading-tight"></h3>
                        <p id="modal-occasions" class="text-stone-500 font-serif mb-2">Ocasiões: <span id="modal-occasions-value"></span></p>
                        <p id="modal-color" class="text-stone-500 font-serif mb-2 hidden"><span id="modal-color-value"></span></p>
                        <p id="modal-size" class="text-stone-500 font-serif mb-2 hidden">Tamanho: <span id="modal-size-value"></span></p>
                        <p id="modal-price" class="text-stone-500 font-serif mb-2 hidden">Valor do aluguel: <span id="modal-price-value"></span></p>
                        <p class="text-xs text-stone-400 mb-6 font-mono">ID: <span id="modal-id-value"></span></p>
                        
                        <div class="w-12 h-1 bg-stone-200 mb-8"></div>
                        
                        <div class="prose prose-stone max-w-none">
                            <h4 class="font-serif text-lg text-stone-800 mb-2">Descrição da Peça</h4>
                            <p id="modal-desc" class="text-stone-600 font-light leading-relaxed text-lg mb-8"></p>
                        </div>

                        <!-- Similar Items Section -->
                        <div id="modal-similar-section" class="hidden mb-8">
                            <div class="w-12 h-1 bg-stone-200 mb-6"></div>
                            <h4 class="font-serif text-lg text-stone-800 mb-4">Você também pode gostar</h4>
                            <div id="modal-similar-grid" class="grid grid-cols-2 gap-4">
                                <!-- Similar items injected here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-8 border-t border-stone-100">
                        <p class="text-stone-400 text-sm mb-4 text-center italic">Gostou deste modelo? Fale conosco agora.</p>
                        <a id="modal-whatsapp-link" href="#" target="_blank" class="block w-full bg-[#25D366] hover:bg-[#1ebc57] text-white py-4 px-6 rounded-sm transition-colors text-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 duration-200 flex items-center justify-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                            </svg>
                            <span class="font-bold tracking-widest text-sm">SOLICITAR MAIS INFORMAÇÕES</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global catalog data store
        window.catalogData = window.catalogData || {};

        function openCatalogModalById(itemId, source) {
            const data = window.catalogData && window.catalogData[itemId];
            if (data) {
                openCatalogModal(
                    data.imageUrl,
                    data.title,
                    data.description,
                    itemId,
                    data.price,
                    source,
                    data.customId,
                    data.occasions,
                    data.color,
                    data.size,
                    data.colorBase,
                    data.colorCommercial
                );
            } else {
                console.error('Dados do item não encontrados para ID:', itemId);
            }
        }

        function openCatalogModal(imageUrl, title, description, itemId, price, source, customDisplayId, occasions, color, size, colorBase, colorCommercial) {
            const idToShow = customDisplayId || itemId;
            
            // Handle Price Display Logic
            let displayPrice = price;
            if (!price || price === '0' || price === 0 || price === '0.00' || price === '0,00') {
                displayPrice = 'Valor do aluguel: Consulte';
            }

            document.getElementById('modal-img').src = imageUrl || 'https://via.placeholder.com/600x800?text=Sem+Imagem';
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-desc').textContent = description;
            const priceRow = document.getElementById('modal-price');
            const priceValue = document.getElementById('modal-price-value');
            const priceText = (displayPrice || '').toString().trim();
            if (priceValue) priceValue.textContent = priceText.replace(/^Valor do aluguel:\s*/i, '').trim();
            if (priceRow) {
                if (priceText) priceRow.classList.remove('hidden');
                else priceRow.classList.add('hidden');
            }
            document.getElementById('modal-id-value').textContent = idToShow;
            document.getElementById('modal-occasions-value').textContent = occasions || 'Várias';

            const colorRow = document.getElementById('modal-color');
            const colorValue = document.getElementById('modal-color-value');
            const baseText = (colorBase || '').toString().trim();
            const commercialText = (colorCommercial || '').toString().trim();
            const colorText = (baseText || commercialText)
                ? [baseText ? `Cor base: ${baseText}` : '', commercialText ? `Cor comercial: ${commercialText}` : ''].filter(Boolean).join(' / ')
                : (color || '').toString().trim();
            if (colorValue) colorValue.textContent = colorText;
            if (colorRow) {
                if (colorText) colorRow.classList.remove('hidden');
                else colorRow.classList.add('hidden');
            }

            const sizeRow = document.getElementById('modal-size');
            const sizeValue = document.getElementById('modal-size-value');
            const sizeText = (size || '').toString().trim();
            if (sizeValue) sizeValue.textContent = sizeText;
            if (sizeRow) {
                if (sizeText) sizeRow.classList.remove('hidden');
                else sizeRow.classList.add('hidden');
            }
            
            const phoneNumber = "5592993531943";
            
            // Construct message with Title and ID
            let text = `Olá, gostaria de mais informações sobre o vestido do catálogo: ${title}`;
            text += `\nCód: ${idToShow}`;
            
            const isAiItem = itemId && itemId.toString().startsWith('ai_');

            if (!isAiItem) {
                const url = new URL(window.location);
                url.searchParams.set('item', itemId);
                window.history.pushState({}, '', url);
                text += `\nLink: ${url.toString()}`;
            }

            const encodedText = encodeURIComponent(text);
            const whatsappLink = document.getElementById('modal-whatsapp-link');
            whatsappLink.href = `https://wa.me/${phoneNumber}?text=${encodedText}`;
            
            if (isAiItem) {
                whatsappLink.onclick = function() { trackWhatsAppClick('ai_modal_whatsapp'); };
            } else {
                whatsappLink.onclick = function() { trackWhatsAppClick('catalog_modal_whatsapp'); };
            }
            
            document.getElementById('catalog-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            const similarSection = document.getElementById('modal-similar-section');
            const similarGrid = document.getElementById('modal-similar-grid');
            similarSection.classList.add('hidden');
            similarGrid.innerHTML = '';

            if (itemId && !isAiItem) {
                // Increment visit count for all sources
                fetch(`/api/item/${itemId}/visit`, { method: 'POST' })
                    .catch(err => console.error('Error incrementing visit count:', err));

                fetch(`/api/ai-similar/${itemId}?limit=4`)
                    .then(response => response.json())
                    .then(data => {
                        const normalizeSlug = (s) => (s || '')
                            .toString()
                            .normalize('NFD')
                            .replace(/[\u0300-\u036f]/g, '')
                            .toLowerCase()
                            .replace(/[^a-z0-9]+/g, '_')
                            .replace(/^_+|_+$/g, '')
                            .replace(/_+/g, '_');

                        const targetOccasion = normalizeSlug((activeOccasion || '').replace(/-/g, '_'));

                        const parseOccasionsToSlugs = (occasionsStr) => {
                            if (!occasionsStr) return [];
                            return occasionsStr
                                .toString()
                                .split(',')
                                .map(s => normalizeSlug(s.trim()))
                                .filter(Boolean);
                        };

                        const apiSuggestions = Array.isArray(data.suggestions) ? data.suggestions : [];
                        let suggestions = targetOccasion
                            ? apiSuggestions.filter(s => parseOccasionsToSlugs(s.occasions).includes(targetOccasion))
                            : apiSuggestions.slice();

                        const existingIds = new Set(suggestions.map(s => String(s.id)));
                        if (suggestions.length < 4 && window.catalogData && typeof window.catalogData === 'object') {
                            const localCandidates = Object.entries(window.catalogData)
                                .filter(([id, d]) => id && d && String(id) !== String(itemId))
                                .filter(([id, d]) => !existingIds.has(String(id)))
                                .filter(([id, d]) => !targetOccasion || parseOccasionsToSlugs(d.occasions).includes(targetOccasion))
                                .map(([id, d]) => ({
                                    id,
                                    customId: d.customId,
                                    title: d.title,
                                    image_url: d.imageUrl,
                                    description: d.description,
                                    color: d.color,
                                    colorBase: d.colorBase,
                                    colorCommercial: d.colorCommercial,
                                    size: d.size,
                                    occasions: d.occasions
                                }));

                            for (const c of localCandidates) {
                                if (suggestions.length >= 4) break;
                                suggestions.push(c);
                                existingIds.add(String(c.id));
                            }
                        }

                        if (suggestions.length > 0) {
                            suggestions.forEach(item => {
                                const div = document.createElement('div');
                                div.className = 'cursor-pointer group';
                                const itemOccasions = typeof item.occasions === 'string'
                                    ? item.occasions
                                    : Array.isArray(item.occasions)
                                        ? item.occasions.join(', ')
                                        : '';
                                const suggestionBase = item.colorBase || item.color_base || item.cor_base || '';
                                const suggestionCommercial = item.colorCommercial || item.color_comercial || item.cor_comercial || '';
                                div.onclick = () => openCatalogModal(item.image_url, item.title, item.description, item.id, 'Valor do aluguel: Consulte', 'similar', item.customId, itemOccasions, item.color, item.size, suggestionBase, suggestionCommercial);
                                div.innerHTML = `
                                    <div class="aspect-[3/4] bg-stone-100 overflow-hidden mb-2 rounded-sm relative">
                                        <img src="${item.image_url}" class="w-full h-full object-contain transition-transform duration-500 group-hover:scale-110" alt="${item.title}">
                                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300"></div>
                                    </div>
                                    <p class="text-xs font-bold text-stone-800 uppercase tracking-wide truncate">${item.title}</p>
                                `;
                                similarGrid.appendChild(div);
                            });
                            similarSection.classList.remove('hidden');
                        }
                    })
                    .catch(err => console.error('Erro ao buscar similares:', err));
            }
        }

        function closeCatalogModal() {
            document.getElementById('catalog-modal').classList.add('hidden');
            document.body.style.overflow = '';
            
            const url = new URL(window.location);
            url.searchParams.delete('item');
            window.history.pushState({}, '', url);
        }

        // AI Search Logic
        let currentSearchQuery = '';
        const activeOccasion = "{{ active_occasion }}";

        function handleEnterSearch(event) {
            if (event.key === 'Enter') {
                performCatalogSearch(1);
            }
        }

        function performCatalogSearch(page = 1) {
            const input = document.getElementById('ai-catalog-search-input');
            const loading = document.getElementById('search-loading');
            
            if (page === 1) {
                currentSearchQuery = input.value.trim();
            }

            if (!currentSearchQuery) return;

            loading.classList.remove('hidden');
            
            trackEvent('ai_catalog_search', {
                'search_term': currentSearchQuery,
                'page': page
            });

            fetch('/api/ai-catalog-search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    query: currentSearchQuery, 
                    page: page, 
                    limit: 8,
                    occasion: activeOccasion
                })
            })
            .then(response => response.json())
            .then(data => {
                loading.classList.add('hidden');
                if (data.results) {
                    updateCatalogGrid(data);
                    const gridElement = document.getElementById('catalog-grid');
                    if (gridElement) {
                        const headerOffset = 150;
                        const elementPosition = gridElement.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth"
                        });
                    }
                } else if (data.error) {
                    console.error('Search error:', data.error);
                    alert('Erro na busca. Tente novamente.');
                }
            })
            .catch(err => {
                loading.classList.add('hidden');
                console.error('Fetch error:', err);
                alert('Erro de conexão.');
            });
        }

        function updateCatalogGrid(data) {
            const items = data.results || [];
            const currentPage = data.page || 1;
            const totalPages = data.total_pages || 1;
            
            const grid = document.getElementById('catalog-grid');
            const pagination = document.getElementById('catalog-pagination');
            
            grid.innerHTML = '';
            if (pagination) {
                pagination.innerHTML = '';
                pagination.classList.add('hidden');
            }

            if (items.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-20 bg-stone-100 rounded-lg">
                        <p class="text-stone-500 text-xl font-serif">Nenhum vestido encontrado para sua descrição.</p>
                        <button onclick="window.location.reload()" class="mt-4 text-london-gold hover:underline">Ver todos os vestidos</button>
                    </div>
                `;
                return;
            }

            items.forEach(item => {
                window.catalogData = window.catalogData || {};
                const itemOccasions = typeof item.occasions === 'string'
                    ? item.occasions
                    : Array.isArray(item.occasions)
                        ? item.occasions.join(', ')
                        : '';
                const colorBase = item.color_base || item.cor_base || item.colorBase || item.corBase || '';
                const colorCommercial = item.color_comercial || item.cor_comercial || item.colorCommercial || item.corCommercial || '';
                const colorFallback = item.color || item.cor || item.cores || '';
                window.catalogData[item.item_id] = {
                    imageUrl: item.imageUrl,
                    title: item.title,
                    description: item.description,
                    price: item.price,
                    customId: item.customId || item.item_id,
                    color: colorFallback,
                    colorBase: colorBase,
                    colorCommercial: colorCommercial,
                    size: item.size,
                    occasions: itemOccasions
                };

                const div = document.createElement('div');
                div.className = 'group bg-white rounded-sm shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden animate-fadeIn';
                div.onclick = () => openCatalogModal(item.imageUrl, item.title, item.description, item.item_id, item.price, 'ai_search', item.customId, itemOccasions, colorFallback, item.size, colorBase, colorCommercial);
                
                div.innerHTML = `
                    <div class="aspect-[3/4] overflow-hidden bg-stone-200 relative">
                        <img src="${item.imageUrl}" alt="${item.title}" class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-700">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                        <div class="absolute bottom-4 right-4 bg-white/90 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-stone-800">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <h3 class="font-serif text-lg text-stone-800 mb-2 truncate">${item.title}</h3>
                        <p class="text-xs text-london-gold tracking-widest font-bold uppercase">Ver Detalhes</p>
                    </div>
                `;
                
                grid.appendChild(div);
            });

            if (pagination && totalPages > 1) {
                pagination.classList.remove('hidden');
                let paginationHtml = '';
                
                if (currentPage > 1) {
                    paginationHtml += `
                        <button onclick="performCatalogSearch(${currentPage - 1})" class="px-6 py-3 border border-stone-300 text-stone-600 hover:bg-stone-800 hover:text-white hover:border-stone-800 transition-all font-medium rounded-sm">
                            &larr; Anterior
                        </button>
                    `;
                }
                
                paginationHtml += `
                    <span class="font-serif text-stone-500 mx-4">
                        Página <span class="text-stone-800 font-bold">${currentPage}</span> de ${totalPages}
                    </span>
                `;
                
                if (currentPage < totalPages) {
                    paginationHtml += `
                        <button onclick="performCatalogSearch(${currentPage + 1})" class="px-6 py-3 border border-stone-300 text-stone-600 hover:bg-stone-800 hover:text-white hover:border-stone-800 transition-all font-medium rounded-sm">
                            Próxima &rarr;
                        </button>
                    `;
                }
                
                pagination.innerHTML = paginationHtml;
            }
        }

        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item');
            if (itemId && window.catalogData && window.catalogData[itemId]) {
                const item = window.catalogData[itemId];
                openCatalogModal(item.imageUrl, item.title, item.description, itemId, item.price, 'direct', item.customId, item.occasions, item.color, item.size, item.colorBase, item.colorCommercial);
            }
        });
    </script>

    <!-- Analytics Tracking Scripts -->
    <script>
        const GA_MEASUREMENT_ID = 'G-23RSZ1SMRX';

        function trackEvent(eventName, params) {
            console.log('Event Tracked:', eventName, params);
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, params);
            }
        }

        function trackWhatsAppClick(location) {
            trackEvent('whatsapp_click', {
                'event_category': 'contact',
                'event_label': location,
                'transport_type': 'beacon'
            });
        }

        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const itemId = params.get('item');
            if (itemId) {
                setTimeout(() => {
                    openCatalogModalById(itemId, 'link');
                }, 200);
            }
        });
    </script>
    <!-- Full Screen Image Modal -->
    <div id="full-image-modal" class="fixed inset-0 z-[200] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="closeFullImage()"></div>
        
        <button onclick="closeFullImage()" class="absolute top-4 right-4 z-[210] text-white/70 hover:text-white transition-colors p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <img id="full-image-img" src="" alt="Full Screen" class="max-w-full max-h-full object-contain shadow-2xl pointer-events-auto rounded-sm">
        </div>
    </div>

    <script>
        function openFullImage(src) {
            if (!src || src.includes('placeholder')) return;
            const modal = document.getElementById('full-image-modal');
            const img = document.getElementById('full-image-img');
            img.src = src;
            modal.classList.remove('hidden');
            // document.body.style.overflow = 'hidden'; // Already hidden by catalog modal
        }

        function closeFullImage() {
            const modal = document.getElementById('full-image-modal');
            modal.classList.add('hidden');
        }

        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const fullModal = document.getElementById('full-image-modal');
                if (!fullModal.classList.contains('hidden')) {
                    closeFullImage();
                    // Prevent event propagation so catalog modal doesn't close too if it listens to Esc
                    event.stopPropagation();
                }
            }
        });
    </script>
    <!-- Full Screen Image Modal -->
    <div id="full-image-modal" class="fixed inset-0 z-[200] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="closeFullImage()"></div>
        
        <button onclick="closeFullImage()" class="absolute top-4 right-4 z-[210] text-white/70 hover:text-white transition-colors p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <img id="full-image-img" src="" alt="Full Screen" class="max-w-full max-h-full object-contain shadow-2xl pointer-events-auto rounded-sm">
        </div>
    </div>

    <script>
        function openFullImage(src) {
            if (!src || src.includes('placeholder')) return;
            const modal = document.getElementById('full-image-modal');
            const img = document.getElementById('full-image-img');
            img.src = src;
            modal.classList.remove('hidden');
        }

        function closeFullImage() {
            const modal = document.getElementById('full-image-modal');
            modal.classList.add('hidden');
        }

        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const fullModal = document.getElementById('full-image-modal');
                if (!fullModal.classList.contains('hidden')) {
                    closeFullImage();
                    event.stopPropagation();
                }
            }
        });
    </script>

    <div id="ai-stylist-cta" class="fixed bottom-32 right-8 z-50 group">
        <div id="ai-cta-bubble" class="absolute bottom-full right-0 mb-6 bg-white p-6 rounded-lg shadow-2xl border-l-4 border-london-gold w-[90vw] sm:w-[450px] transform scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100 group-focus-within:scale-100 group-focus-within:opacity-100 transition-all duration-300 origin-bottom-right">
            <div class="flex justify-between items-start mb-3">
                <h4 class="font-serif text-london-gold font-bold text-xl">Estilista Virtual</h4>
                <span class="text-sm bg-stone-100 text-stone-500 px-3 py-1 rounded-full">Beta</span>
            </div>
            <p class="text-base text-stone-600 mb-5 font-light leading-relaxed">
                Oi! Eu sou a Bella, sua estilista virtual com IA. Descreva a ocasião e o estilo do vestido e eu te mostro as melhores opções do nosso acervo.
                <span class="block text-sm text-stone-400 mt-3 italic border-t border-stone-100 pt-3">Ex: "Procuro um vestido sereia com brilho para um casamento à noite"</span>
            </p>
            <div class="flex gap-2 relative">
                <input type="text" id="ai-cta-input" placeholder="Digite aqui..." 
                       class="w-full text-base border border-stone-200 rounded-sm px-4 py-3 pr-12 focus:border-london-gold focus:ring-1 focus:ring-london-gold outline-none transition-all"
                       onkeypress="handleAiCtaEnter(event)">
                <button onclick="submitAiCta()" class="absolute right-3 top-1/2 -translate-y-1/2 text-london-gold hover:text-stone-800 transition-colors p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                    </svg>
                </button>
            </div>
        </div>
    
        <button class="bg-stone-900 text-white p-4 rounded-full shadow-2xl hover:bg-london-gold transition-colors relative group-hover:rotate-12 duration-300">
            <span class="absolute -top-1 -right-1 flex h-4 w-4">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-london-gold opacity-75"></span>
              <span class="relative inline-flex rounded-full h-4 w-4 bg-london-gold border-2 border-white"></span>
            </span>
            
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
            </svg>
        </button>
    </div>

    <a href="https://wa.me/5592993531943" class="fixed bottom-8 right-8 bg-green-500 text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform z-50 flex items-center gap-2 group">
        <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-500 whitespace-nowrap font-bold">
            Agendamento/Dúvidas
        </span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.588-5.946 0-6.556 5.332-11.891 11.891-11.891 3.181 0 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.481 8.403 0 6.556-5.332 11.892-11.891 11.892-1.999 0-3.956-.503-5.692-1.448l-6.301 1.666zm6.29-4.143c1.589.943 3.197 1.441 4.934 1.441 5.485 0 9.95-4.465 9.95-9.95 0-2.652-1.036-5.147-2.919-7.031-1.883-1.883-4.384-2.917-7.031-2.917-5.485 0-9.951 4.465-9.951 9.95 0 2.07.635 4.089 1.835 5.823l-1.101 4.022 4.133-1.092zm10.293-7.234c-.298-.15-1.764-.871-2.037-.972-.273-.102-.472-.152-.671.152-.199.303-.771 1.018-.944 1.219-.174.202-.348.227-.646.077-.298-.15-1.258-.464-2.396-1.48-.885-.789-1.483-1.763-1.656-2.064-.174-.302-.018-.465.132-.614.135-.133.298-.348.447-.521.149-.174.199-.298.298-.497.099-.198.05-.373-.025-.522-.075-.15-.671-1.616-.919-2.213-.242-.581-.486-.502-.671-.512-.174-.01-.373-.013-.572-.013-.199 0-.523.075-.795.373-.273.302-1.045 1.018-1.045 2.486s1.07 2.885 1.219 3.085c.149.202 2.105 3.214 5.099 4.507.712.308 1.268.491 1.701.628.715.227 1.365.195 1.879.118.573-.086 1.764-.72 2.013-1.417.248-.696.248-1.292.174-1.417-.074-.125-.272-.201-.57-.352z"/>
        </svg>
    </a>

    <script>
        function handleAiCtaEnter(e) {
            if (e.key === 'Enter') submitAiCta();
        }

        function redirectToBella(text) {
            const url = new URL(window.location.origin + '/');
            if (text) {
                url.searchParams.set('bella_query', text);
            }
            url.hash = 'showroom';
            window.location.href = url.toString();
        }

        function submitAiCta() {
            const ctaInput = document.getElementById('ai-cta-input');
            if (!ctaInput) return;
            const text = ctaInput.value.trim();
            redirectToBella(text);
        }
    </script>

    <script>
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        function openMobileMenu() {
            if (mobileMenu) mobileMenu.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            if (mobileMenu) mobileMenu.classList.add('translate-x-full');
            document.body.style.overflow = '';
        }

        if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', openMobileMenu);
        if(closeMenuBtn) closeMenuBtn.addEventListener('click', closeMobileMenu);
    </script>
</body>
</html>
